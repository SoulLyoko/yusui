import{d as st}from"./index.a2682797.js";import{I as Me}from"./iconify.a7519ee4.js";import{_ as ut,a as it,d as ct}from"./index.81c79613.js";import"./index.b9b6321b.js";import{E as le,m as dt}from"./index.05b719a1.js";import{b as S,r as E,e as X,u as V,n as ke,Y as pt,X as Ce,L as ft,h as W,H as R,k as M,R as ae,F as H,j as I,D as $,E as L,J as A,p as Y,q as z,i as ne,a3 as Re,C as ee,_ as Ne,w as pe,s as ue,G as Z,K as mt,I as vt,N as Ae,a9 as bt,d as gt,a7 as _t,a8 as yt,B as fe}from"./framework.87994f31.js";import{j as wt}from"./tree.faa3b0d0.js";import{f as we,t as Be,a as ht}from"./vuedraggable.umd.3ed62a2a.js";import{u as me,w as Ye,c as kt}from"./theme.cdcbae00.js";import{p as Ct}from"./index.vue_vue_type_script_setup_true_lang.b05f95f4.js";import{s as Nt,a as ze,e as G,u as Tt}from"./index.d61e7aee.js";import{d as Dt}from"./differenceBy.5155784c.js";import{D as se}from"./index.4aada9e5.js";function Vt(e){const{buttonHandler:t,request:a}=Q(),{commitTask:i,revokeTask:o,saveDraft:f,startTask:n,terminateTask:s,transferTask:c,withdrawTask:r,rejectTask:w,greenChannel:u,circulateTask:_}=Le(a),d=S(()=>{const{flowDetail:b,formVariables:g,approvalFormData:l,debug:m,fileIds:p}=e,{flowDeployId:y}=b.value.process??{},{taskId:h,flowInstanceId:T}=b.value.task??{};return{flowDeployId:y,taskId:h,flowInstanceId:T,variables:g.value,debug:m.value,fileIds:p==null?void 0:p.value,...l.value}}),v=()=>d.value.taskId&&d.value.flowInstanceId;return{flow_draft(){if(v())return f(d.value)},flow_pass(){return v()?i(d.value):n(d.value)},flow_revoke(){if(v())return o(d.value)},flow_withdraw(){if(v())return r(d.value)},flow_terminate(){if(v())return s(d.value)},flow_transfer(){if(v())return c(d.value)},flow_reject(){if(v())return w(d.value)},flow_green(){if(v())return u(d.value)},flow_circulate(){if(v()){const{approvalFormData:b,circulateId:g}=e;return _({id:g==null?void 0:g.value,comment:b==null?void 0:b.value.comment})}},...t==null?void 0:t(e)}}function xt(e){const t=E({});return X(async()=>{var i;const{formProperty:a}=((i=V(e))==null?void 0:i.properties)||{};a!=null&&a.length&&(await ke(),Object.keys(t.value).forEach(o=>{var s,c,r,w;const f=((s=t.value[o])==null?void 0:s.label)||"",n=a==null?void 0:a.find(u=>u.prop===o);if(t.value[o].display=n==null?void 0:n.display,t.value[o].disabled=n==null?void 0:n.disabled,t.value[o].detail=n==null?void 0:n.detail,t.value[o].readonly=n==null?void 0:n.readonly,t.value[o].rules=t.value[o].rules??[],n!=null&&n.required&&((c=t.value[o].rules)!=null&&c.some(u=>u.required)))return null;n!=null&&n.required?(r=t.value[o].rules)==null||r.push({required:!0,message:`${f}为必填项`}):t.value[o].rules=(w=t.value[o].rules)==null?void 0:w.filter(u=>!u.required)}))}),t}const It={modelValue:{type:Object,default:()=>({})},title:{type:String},flowDetail:{type:Object,default:()=>({})},formLoading:{type:Boolean},submitLoading:{type:Boolean},activeTab:{type:String,default:"formTab"},activeBtn:{type:Object,default:()=>({})},approvalVisible:{type:Boolean},approvalFormData:{type:Object,default:()=>({})},flowKey:{type:String},taskId:{type:String},instanceId:{type:String},formId:{type:String},fileIds:{type:String},permission:{type:Object},beforeClick:{type:Function},beforeSubmit:{type:Function},detail:{type:Boolean},debug:{type:Boolean},circulateId:{type:String}},Lt={complete:e=>e},Ge=Symbol("flowFormState");function Ot(e,t){const a=me(e,void 0,{passive:!0,deep:!0}),{flowDetail:i,modelValue:o,formLoading:f}=a,{tabs:n,customForm:s,request:c}=Q(),r=E({}),w=S(()=>(n==null?void 0:n.filter(b=>{var l,m,p;const g=(p=(m=(l=i.value)==null?void 0:l.properties)==null?void 0:m.formProperty)==null?void 0:p.find(y=>y.prop===b.prop);return(g==null?void 0:g.display)!==!1}))??[]),u=S(()=>{var l,m,p;const b=(l=w.value.find(y=>y.prop==="formTab"))==null?void 0:l.component,g=s==null?void 0:s[((p=(m=i==null?void 0:i.value)==null?void 0:m.process)==null?void 0:p.formPath)??""];return typeof g=="function"?ft(g):g??b}),{getFlowDetail:_}=Le(c);X(()=>{const{flowKey:b,taskId:g,instanceId:l}=e;!b&&!g&&!l||(f.value=!0,_({flowKey:b,taskId:g,flowInstanceId:l}).then(m=>{i.value=m.data,o.value=m.data.formData||{}}).finally(()=>{f.value=!1}))});const d=S(()=>Object.entries(o.value||{}).filter(([b])=>!b.startsWith("$")).map(([b,g])=>({key:b,value:g}))),v={...a,formData:o,formVariables:d,tabRefs:r,tabList:w,formTabComponent:u,emit:t};return pt(Ge,v),v}function te(){return Ce(Ge)}const Et=W({__name:"button-list",emits:["click"],setup(e,{emit:t}){const{userInfo:a,request:i}=Q(),{flowDetail:o,circulateId:f}=te(),{data:n}=et(i).useList();function s(r,w){return r.map(u=>{const _=w.find(v=>v.buttonKey===u.buttonKey);return{...u,...Ct(_,["display","approval"])}})}const c=S(()=>{var p,y,h,T,D,N;if(f!=null&&f.value){const O=(p=n.value)==null?void 0:p.find(k=>k.buttonKey==="flow_circulate");return O?[O]:[]}const r=typeof a=="function"?a():a,{assignee:w,status:u}=((y=o.value)==null?void 0:y.task)||{},{createUser:_,flowInstanceId:d,status:v}=((h=o.value)==null?void 0:h.flowInstance)||{},b={true:!0,false:!1,startUser:_==(r==null?void 0:r.userId),assignee:w==(r==null?void 0:r.userId),todo:u==2,done:u==1,notstarted:!d,started:!!d,finished:v===1,unfinished:v===2},g=((T=n.value)==null?void 0:T.filter(O=>O.buttonKey!=="flow_circulate"))??[],{button:l}=((D=o.value)==null?void 0:D.properties)||{};return((N=s(g,l??[]))==null?void 0:N.filter(O=>{var k,x;return(x=(k=O.display)==null?void 0:k.split(","))==null?void 0:x.every(C=>b[C])}))??[]});return(r,w)=>{const u=R("el-button");return I(!0),M(H,null,ae(c.value,_=>(I(),$(u,{key:_.buttonKey,type:_.buttonType,onClick:d=>t("click",_)},{default:L(()=>[A(V(Me),{icon:_.icon},null,8,["icon"]),Y(" "+z(_.name),1)]),_:2},1032,["type","onClick"]))),128)}}}),Pt=W({__name:"common-comments",props:{modelValue:{}},setup(e){const t=e,{modelValue:a}=me(t),{request:i}=Q(),{batchUpdate:o,create:f,remove:n,useList:s}=Na(i),c=E(!1),{activeBtn:r}=te(),w=S(()=>{var y;return(y=r.value)==null?void 0:y.buttonKey}),{data:u,refresh:_}=s(w),d=S(()=>{var h,T,D;const y=a.value;if(y&&!((h=u.value)!=null&&h.some(N=>N.content===y))){const N=(((D=(T=u.value)==null?void 0:T[0])==null?void 0:D.sort)||1)-1;return[{content:y,sort:N},...u.value||[]]}return u.value});async function v(y){var h;await f({...y,type:(h=r.value)==null?void 0:h.buttonKey}),le.success("添加成功"),_()}async function b(y){await n(y.id),le.success("删除成功"),_()}async function g(y,h){let T=h.parent.data;T=T.map((D,N)=>({id:D.id,sort:N+1})),await o(T),le.success("修改排序成功"),_(),c.value=!1}function l(){c.value=!0}const m=E();async function p(y){var h;a.value=y.content??"",await ke(),(h=m.value)==null||h.blur()}return(y,h)=>{const T=R("el-input"),D=R("el-text"),N=R("el-col"),O=R("el-button"),k=R("el-row"),x=R("el-tree"),C=R("el-popover");return I(),$(C,{visible:c.value,placement:"bottom",title:"常用意见",width:600},{reference:L(()=>[A(T,{ref_key:"inputRef",ref:m,modelValue:V(a),"onUpdate:modelValue":h[0]||(h[0]=P=>ne(a)?a.value=P:null),type:"textarea",placeholder:"请输入意见",rows:"5",onFocus:h[1]||(h[1]=P=>c.value=!0),onBlur:h[2]||(h[2]=P=>c.value=!1)},null,8,["modelValue"])]),default:L(()=>[A(x,{data:d.value,"node-key":"content",draggable:"","allow-drop":(P,K,U)=>U!=="inner",props:{label:"content"},onNodeClick:p,onNodeDrop:g,onNodeDragStart:l},{default:L(({data:P})=>[A(k,{style:{width:"600px"}},{default:L(()=>[A(N,{span:22},{default:L(()=>[A(D,{truncated:"",title:P.content},{default:L(()=>[Y(z(P.content),1)]),_:2},1032,["title"])]),_:2},1024),A(N,{span:2},{default:L(()=>[P.id?(I(),$(O,{key:0,type:"danger",size:"small",icon:"el-icon-close",text:"",onClick:Re(K=>b(P),["stop"])},null,8,["onClick"])):(I(),$(O,{key:1,type:"primary",size:"small",icon:"el-icon-plus",text:"",onClick:Re(K=>v(P),["stop"])},null,8,["onClick"]))]),_:2},1024)]),_:2},1024)]),_:1},8,["data","allow-drop"])]),_:1},8,["visible"])}}}),Rt=W({__name:"approval-tree",props:{modelValue:{},data:{},autoCheck:{type:Boolean}},setup(e){const t=e,{modelValue:a}=me(t),i=E(),o={class(u){return`node-${u.type}`}},f=S(()=>Be(t.data??[],(u,_,d)=>{const v=ze();return u.taskNodeKey=(d==null?void 0:d.taskNodeKey)??u.taskNodeKey,u.incoming=(d==null?void 0:d.incoming)??u.incoming,u.multiple=(d==null?void 0:d.multiple)??u.multiple,{...u,id:v,label:u.title,disabled:u.type!=="user"}})),n={element:"ep:flag",post:"ep:share",dept:"ep:share",user:"ep:user"};Ye(()=>[f.value,i.value],async()=>{if(!i.value||!f.value.length)return;if(t.autoCheck){const _=s(f.value);_&&w([_])}we(f.value,_=>{var d;return!!((d=_.children)!=null&&d.length)}).map(async _=>{var v;await Nt(100);const d=(v=i.value)==null?void 0:v.getNode(_);d==null||d.expand()})},{immediate:!0,debounce:100});function s(u){var _;if(u.length===1)return(_=u[0].children)!=null&&_.length?s(u[0].children):u[0]}async function c(u,{checkedNodes:_}){var b;let d=_.filter(g=>g.type==="user");const v=d.some(g=>g.id===u.id);if(f.value.every(g=>!g.multiple)&&v)d=[u];else if(!u.multiple&&v){const m=((b=i.value)==null?void 0:b.getNode(u)).parent.data.children.filter(p=>p.id!==u.id);d=Dt(d,m,"id")}w(d)}function r(u){const _=a.value.filter(d=>d.id!==u.id);w(_)}function w(u){var _;a.value=u,(_=i.value)==null||_.setCheckedNodes(u)}return(u,_)=>{const d=R("el-tag"),v=R("Icon"),b=R("el-tree");return I(),M(H,null,[(I(!0),M(H,null,ae(V(a),g=>(I(),$(d,{key:g.id,type:"info",closable:"",onClose:l=>r(g)},{default:L(()=>[Y(z(g.title),1)]),_:2},1032,["onClose"]))),128)),A(b,{ref_key:"treeRef",ref:i,class:"approval-tree",data:f.value,props:o,"node-key":"id","check-on-click-node":"","show-checkbox":"",onCheck:c},{default:L(({data:g})=>[ee("div",null,[A(v,{icon:n[g.type]||n.element,style:{display:"inline-block"}},null,8,["icon"]),ee("span",null,z(g.title),1)])]),_:1},8,["data"])],64)}}});const Se=Ne(Rt,[["__scopeId","data-v-e8348616"]]),At={key:0},Ue=W({__name:"assignee-setter",props:{modelValue:{},tableData:{},placeholder:{}},emits:["update:modelValue"],setup(e,{emit:t}){const a=e,i=S({get(){return typeof a.modelValue=="string"?a.modelValue?a.modelValue.split(","):[]:a.modelValue},set(v){var b;t("update:modelValue",v.join(",")),(b=a.tableData)!=null&&b.row&&(a.tableData.row.idVal=we(s.value,g=>v==null?void 0:v.includes(g.id)).map(g=>g[`${n.value}Id`]).join(","))}}),o=S({get(){return Array.isArray(a.modelValue)?a.modelValue.join(","):a.modelValue},set(v){t("update:modelValue",v)}}),f=E(!1),n=S(()=>{var v,b;return(b=(v=a.tableData)==null?void 0:v.row)==null?void 0:b.type}),s=E([]),c=E([]),{request:r}=Q(),{getUserTree:w}=La(r),{getParam:u}=ve(r);pe(n,v=>{["dept","post","user"].includes(v)?(f.value=!0,w(v==="user"?"":v).then(b=>{s.value=Be(b.data,g=>({...g,label:g.title,value:g.id,disabled:v==="user"?g.type!=="user":!1}))}).finally(()=>f.value=!1)):n.value==="dynamic"&&(f.value=!0,u("flow.trends.user").then(b=>{c.value=b.data}).finally(()=>f.value=!1))},{immediate:!0});const _=E();function d(){i.value=we(s.value,v=>v.type===n.value).map(v=>v.id)}return(v,b)=>{const g=R("ElTreeSelect"),l=R("el-button"),m=R("el-input");return["dept","post","user"].includes(n.value)?(I(),M("div",At,[A(g,{ref_key:"treeRef",ref:_,modelValue:i.value,"onUpdate:modelValue":b[0]||(b[0]=p=>i.value=p),"check-on-click-node":"","check-strictly":"",clearable:"","collapse-tags":"","collapse-tags-tooltip":"",data:s.value,filterable:"",loading:f.value,"max-collapse-tags":3,multiple:"",placeholder:"请选择","show-checkbox":"",style:{width:"75%"}},null,8,["modelValue","data","loading"]),A(l,{text:"",type:"primary",icon:"el-icon-check",style:{width:"20%"},onClick:d},{default:L(()=>[Y(" 全选 ")]),_:1})])):n.value==="dynamic"?(I(),$(g,{key:1,modelValue:o.value,"onUpdate:modelValue":b[1]||(b[1]=p=>o.value=p),clearable:"",data:c.value,filterable:"",loading:f.value,placeholder:"请选择",style:{width:"100%"}},null,8,["modelValue","data","loading"])):n.value==="userTask"?(I(),$(V(ut),{key:2,modelValue:o.value,"onUpdate:modelValue":b[2]||(b[2]=p=>o.value=p),"filter-type":"userTask",placeholder:"请选择"},null,8,["modelValue"])):(I(),$(m,{key:3,modelValue:o.value,"onUpdate:modelValue":b[3]||(b[3]=p=>o.value=p),clearable:"",placeholder:"请输入"},null,8,["modelValue"]))}}}),St={key:0,class:"flow-viewer"},Ut={key:0,class:"flow-status-legend"},$t=W({__name:"index",props:{modelValue:{},view:{type:Boolean},flowFormOption:{},flowHistory:{},showLegend:{type:Boolean}},emits:["update:modelValue","nodeClick"],setup(e,{emit:t}){const a=e,i=ue();kt(i,()=>{var l;(l=i.value)==null||l.on("node:click",m=>t("nodeClick",m))});const o=S({get(){let l=ct();return typeof a.modelValue=="string"&&a.modelValue?l=JSON.parse(a.modelValue):typeof a.modelValue=="object"&&Object.keys(a.modelValue)&&(l=a.modelValue),l},set(l){t("update:modelValue",JSON.stringify(l))}}),f=S(()=>{const{column:l=[],group:m=[]}=JSON.parse(a.flowFormOption||"{}");return[...l,...m.map(y=>y.column??[]).flat()]}),{FlowDesign:n,tabs:s,request:c}=Q(),{data:r}=et(c).useList(),w=S(()=>(s==null?void 0:s.map(l=>({...l,display:!0})))??[]),u=S(()=>{var l;return{formPropertyList:[...f.value,...w.value],buttonList:(l=r.value)==null?void 0:l.filter(m=>m.status===1),fieldsDic:f.value.map(m=>({label:m.label,value:`\${${m.prop}}`,desc:`\${${m.prop}}`})),flowButtonDisplayDic:G(xe),flowButtonApprovalDic:G(Ie)}}),_=E({}),d=E({});Ye(d,l=>{var m,p,y,h,T,D;l&&((y=(p=(m=l.assignee)==null?void 0:m.children)==null?void 0:p.column)!=null&&y[1]&&(l.assignee.children.column[1].component=Ue),(D=(T=(h=l.circulate)==null?void 0:h.children)==null?void 0:T.column)!=null&&D[1]&&(l.circulate.children.column[1].component=Ue))},{debounce:1});const{data:v}=ve(c).useParam("flow.task.status"),b=S(()=>{var l;return(l=a.flowHistory)==null?void 0:l.map(m=>{var y,h;const p=(h=(y=v.value)==null?void 0:y.find(T=>T.value===m.status))==null?void 0:h.style;return{id:m.taskNodeKey,style:p}})}),g=S(()=>{var l,m;return(m=(l=a.flowHistory)==null?void 0:l.filter(p=>p.taskNodeType==="userTask"))==null?void 0:m.map(p=>{var y;return{id:p.taskNodeKey,content:`<div>${p.assigneeName}</div>
        <div>${p.endTime??""}</div>
        <div>${((y=p.comment)==null?void 0:y.handleComment)??""}</div>`}})});return(l,m)=>l.view?(I(),M("div",St,[l.showLegend!==!1?(I(),M("div",Ut,[(I(!0),M(H,null,ae(V(v),p=>{var y;return I(),M("div",{key:p.label,class:"legend-item"},[ee("div",{class:"legend-color",style:mt({backgroundColor:(y=p.style)==null?void 0:y.fill})},null,4),ee("span",null,z(p.label),1)])}),128))])):Z("",!0),A(V(n),{lf:i.value,"onUpdate:lf":m[0]||(m[0]=p=>i.value=p),"model-value":o.value,styles:b.value,tooltips:g.value,type:"viewer"},null,8,["lf","model-value","styles","tooltips"])])):(I(),$(V(n),{key:1,modelValue:o.value,"onUpdate:modelValue":m[1]||(m[1]=p=>o.value=p),formData:_.value,"onUpdate:formData":m[2]||(m[2]=p=>_.value=p),formDefaults:d.value,"onUpdate:formDefaults":m[3]||(m[3]=p=>d.value=p),"form-options":V(it),"data-options":u.value,"form-width":"30%"},null,8,["modelValue","formData","formDefaults","form-options","data-options"]))}});const We=Ne($t,[["__scopeId","data-v-fc890812"]]),jt=W({__name:"node-select",props:{modelValue:{}},setup(e){const t=e,{modelValue:a}=me(t),{flowDetail:i}=te(),o=E(!1);function f({data:n}){n.type==="userTask"&&(o.value=!1,a.value=n.id)}return(n,s)=>{const c=R("el-button"),r=R("el-popover");return I(),$(r,{visible:o.value,"onUpdate:visible":s[0]||(s[0]=w=>o.value=w),placement:"bottom-start",width:"800px",trigger:"click"},{reference:L(()=>[A(c,null,{default:L(()=>[Y(" 点击选择节点 ")]),_:1})]),default:L(()=>{var w,u;return[A(We,{"model-value":(u=(w=V(i))==null?void 0:w.process)==null?void 0:u.flowData,view:"",style:{height:"600px"},onNodeClick:f},null,8,["model-value"])]}),_:1},8,["visible"])}}}),Kt=W({__name:"approval-form",emits:["submit"],setup(e,{emit:t}){const{request:a}=Q(),{getApprovalNode:i}=Le(a),{useParam:o}=ve(a),{formData:f,approvalFormData:n,activeBtn:s,approvalVisible:c,formVariables:r,flowDetail:w}=te(),u=E([]),_=E([]),d=E([]),v=E([]),b=E(!1),g=E(!1),l=E(),m=E(),p={menuBtn:!1,labelWidth:100,column:[{label:"指定节点",prop:"jumpTaskNodeKey",span:24,rules:[{required:!0,message:"请选择指定节点"}]},{label:"审批人",prop:"assignee",span:24,rules:[{required:!0,validator:y}]},{label:"传阅人",prop:"circulate",span:24},{label:"意见",prop:"comment",span:24,rules:[{required:!0,message:"请填写意见"}]}]};function y(x,C,P){var B,j,Pe;const K=((B=u.value[0])==null?void 0:B.type)==="parallelGateway",U=(Pe=(j=u.value[0])==null?void 0:j.children)==null?void 0:Pe.every(lt=>ht([lt],nt=>_.value.some(rt=>rt.id===nt.id)));if(_.value.length){if(K&&!U)return P("请在每个节点选择审批人")}else return P("请选择审批人");return!0}const{data:h}=o("flow.default.comment"),{data:T}=o("flow.approval.autocheck");X(async()=>{var C;if(!c.value||!l.value||!m.value)return;D();const{taskId:x}=((C=w.value)==null?void 0:C.task)||{};ke(()=>{l.value.resetFields(),n.value.comment=f.value.comment||(x?"":h.value)||"",m.value.jumpTaskNodeKey.display=N("specifyNode"),m.value.assignee.display=N("assignee"),m.value.circulate.display=N("circulate"),m.value.comment.display=N("comment")})}),X(async()=>{var P,K;if(!c.value||!N("assignee")||N("specifyNode")&&!n.value.jumpTaskNodeKey)return;D();const{flowKey:x}=((P=w.value)==null?void 0:P.process)||{},{taskId:C}=((K=w.value)==null?void 0:K.task)||{};try{g.value=!0;const U=await i({flowKey:x,taskId:C,variables:r.value,buttonType:s.value.buttonKey,jumpTaskNodeKey:n.value.jumpTaskNodeKey});u.value=U.data.approvalNodeList,d.value=U.data.circulateNodeList}finally{g.value=!1}});function D(){u.value=[],_.value=[],d.value=[],v.value=[]}function N(x){var C,P;return(P=(C=s.value)==null?void 0:C.approval)==null?void 0:P.includes(x)}async function O(){await ot(l),b.value=!0;const{data:x,outgoing:C}=k(_.value),{data:P}=k(v.value);n.value.assignee=x,n.value.outgoing=[...C],n.value.circulate=P,console.log("🚀 ~ file: approval-form.vue:133 ~ onConfirm ~ formData:",f),t("submit")}function k(x){const C={},P={},K=new Set;return x.forEach(U=>{const{taskNodeKey:B,incoming:j}=U;C[B]||(C[B]=new Set),U.userId&&C[B].add(U.userId),P[B]=[...C[B]].join(","),j&&K.add(j)}),{set:C,data:P,outgoing:K}}return(x,C)=>{const P=R("el-skeleton"),K=R("avue-form"),U=R("el-button"),B=R("el-dialog");return I(),$(B,{modelValue:V(c),"onUpdate:modelValue":C[7]||(C[7]=j=>ne(c)?c.value=j:null),class:"approlval-form",title:V(s).name,width:"900px","append-to-body":""},{footer:L(()=>[A(U,{onClick:C[6]||(C[6]=j=>c.value=!1)},{default:L(()=>[Y(" 取 消 ")]),_:1}),A(U,{type:"primary",onClick:O},{default:L(()=>[Y(" 确 定 ")]),_:1})]),default:L(()=>[A(K,{ref_key:"formRef",ref:l,modelValue:V(n),"onUpdate:modelValue":C[4]||(C[4]=j=>ne(n)?n.value=j:null),defaults:m.value,"onUpdate:defaults":C[5]||(C[5]=j=>m.value=j),option:p},{jumpTaskNodeKey:L(()=>[A(jt,{modelValue:V(n).jumpTaskNodeKey,"onUpdate:modelValue":C[0]||(C[0]=j=>V(n).jumpTaskNodeKey=j)},null,8,["modelValue"])]),assignee:L(()=>[g.value?(I(),$(P,{key:0})):(I(),$(Se,{key:"AssigneeTree",modelValue:_.value,"onUpdate:modelValue":C[1]||(C[1]=j=>_.value=j),data:u.value,"auto-check":V(T)==="true"},null,8,["modelValue","data","auto-check"]))]),circulate:L(()=>[g.value?(I(),$(P,{key:0})):(I(),$(Se,{key:"CirculateTree",modelValue:v.value,"onUpdate:modelValue":C[2]||(C[2]=j=>v.value=j),data:d.value},null,8,["modelValue","data"]))]),comment:L(()=>[A(Pt,{modelValue:V(n).comment,"onUpdate:modelValue":C[3]||(C[3]=j=>V(n).comment=j)},null,8,["modelValue"])]),_:1},8,["modelValue","defaults"])]),_:1},8,["modelValue","title"])}}}),Mt={class:"flow-form__title"},Bt=W({__name:"index",props:It,emits:Lt,setup(e,{emit:t}){const i=Ot(e,t),{ApprovalForm:o,tabsProps:f}=Q(),n=o??Kt,{title:s,detail:c,flowDetail:r,tabRefs:w,tabList:u,activeTab:_,activeBtn:d,formLoading:v,formTabComponent:b,approvalVisible:g,submitLoading:l,beforeClick:m,beforeSubmit:p}=i;async function y(D){var N,O;d.value=D;for(const k of Object.values(w.value))await((N=k==null?void 0:k.validate)==null?void 0:N.call(k));await((O=m==null?void 0:m.value)==null?void 0:O.call(m,D)),(D==null?void 0:D.approval)!=="false"?g.value=!0:T()}const h=Vt(i);async function T(){var D;try{const{buttonKey:N}=d.value;l.value=!0,await((D=p==null?void 0:p.value)==null?void 0:D.call(p,d.value));const O=h[N];O?(await(O==null?void 0:O()),le.success("操作成功"),g.value=!1,t("complete",d.value)):le.error("无法找到相应的操作")}finally{l.value=!1}}return(D,N)=>{const O=R("el-skeleton"),k=R("el-main"),x=R("el-header"),C=R("el-tab-pane"),P=R("el-tabs"),K=R("el-container");return V(v)?(I(),$(k,{key:0},{default:L(()=>[A(O)]),_:1})):(I(),$(K,{key:1,class:"flow-form"},{default:L(()=>[A(x,{class:"flow-form__header",height:"auto"},{default:L(()=>{var U;return[ee("div",Mt,z(V(s)??((U=V(r).flowInstance)==null?void 0:U.title)),1),V(c)?Z("",!0):(I(),$(Et,{key:0,onClick:y}))]}),_:1}),A(k,{class:"flow-form__main"},{default:L(()=>[A(P,vt({modelValue:V(_),"onUpdate:modelValue":N[0]||(N[0]=U=>ne(_)?_.value=U:null)},V(f)),{default:L(()=>[(I(!0),M(H,null,ae(V(u),U=>(I(),$(C,{key:U.prop,label:U.label,name:U.prop,lazy:U.lazy,disabled:U.disabled,closable:U.closable},{default:L(()=>[U.prop==="formTab"?(I(),$(Ae(V(b)),{key:0,ref_for:!0,ref:B=>V(w)[U.prop]=B},null,512)):(I(),$(Ae(U.component),{key:1,ref_for:!0,ref:B=>V(w)[U.prop]=B},null,512))]),_:2},1032,["label","name","lazy","disabled","closable"]))),128))]),_:1},16,["modelValue"])]),_:1}),A(V(n),{onSubmit:T})]),_:1}))}}});const Yt=W({setup(){const{flowDetail:e,formData:t,detail:a}=te(),i=xt(e.value),{proxy:o}=gt(),f=E({});X(()=>{const{formOption:c}=e.value.process??{};f.value=wt.bind(o)(c||'{"menuBtn":false}'),f.value.detail=!!a.value});const n=E();function s(){return ot(n)}return{form:t,option:f,defaults:i,formRef:n,validate:s}},render(){return bt(R("avue-form"),{ref:"formRef",modelValue:this.form,defaults:this.defaults,option:this.option,class:this.option.class,"onUpdate:modelValue":e=>this.form=e,"onUpdate:defaults":e=>this.defaults=e})}}),zt=W({__name:"upload-table",setup(e){const{flowDetail:t,fileIds:a}=te(),{upload:{action:i,headers:o,preview:f,download:n,props:s}={},request:c}=Q(),r=typeof o=="function"?o():o,w=S(()=>{var p,y;return((y=(p=t.value)==null?void 0:p.task)==null?void 0:y.flowInstanceId)??ze()}),u={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,addBtn:!1,editBtn:!1,delBtn:!1,menuWidth:200,column:[{label:"文件名",prop:"fileName"},{label:"文件类型",prop:"fileType"},{label:"文件大小",prop:"fileSize"},{label:"版本",prop:"version"},{label:"上传时间",prop:"createTime"}]},{bindVal:_,getDataList:d,handleDel:v,handleSave:b,afterGetList:g,crudStateRefs:{tableData:l}}=Tt({crudOption:{...Da(c),saveSuccessMsg:"上传成功"},tableOption:u,queryForm:{isLatest:1,flowInstanceId:w.value}});g(()=>{a.value=l.value.map(p=>p.id).join(",")}),d();async function m(p,y){var x,C;const{fileName:h,fileType:T,fileSize:D,fileUrl:N,res:O}=s,k={fileName:se({res:p},`${O}.${h}`),fileType:se({res:p},`${O}.${T}`),fileSize:se({res:p},`${O}.${D}`),fileUrl:se({res:p},`${O}.${N}`),taskId:(C=(x=t.value)==null?void 0:x.task)==null?void 0:C.taskId,flowInstanceId:w.value,rootMark:(y==null?void 0:y.rootMark)||"",version:typeof(y==null?void 0:y.version)=="number"?y.version+1:1};await b(k,d,()=>{})}return(p,y)=>{const h=R("el-button"),T=R("el-upload"),D=R("avue-crud");return I(),$(D,_t(yt(V(_))),{"menu-left":L(()=>[A(T,{action:V(i),headers:V(r),"show-file-list":!1,onSuccess:y[0]||(y[0]=N=>m(N))},{default:L(()=>[A(h,{type:"primary",icon:"el-icon-upload"},{default:L(()=>[Y(" 点击上传 ")]),_:1})]),_:1},8,["action","headers"])]),menu:L(({row:N,index:O})=>[A(h,{type:"primary",text:"",icon:"el-icon-view",onClick:k=>{var x;return(x=V(f))==null?void 0:x(N,V(l))}},{default:L(()=>[Y(" 预览 ")]),_:2},1032,["onClick"]),A(h,{type:"primary",text:"",icon:"el-icon-download",onClick:k=>{var x;return(x=V(n))==null?void 0:x(N,V(l))}},{default:L(()=>[Y(" 下载 ")]),_:2},1032,["onClick"]),A(T,{action:V(i),headers:V(r),"show-file-list":!1,style:{display:"inline","vertical-align":"middle","margin-right":"10px"},onSuccess:k=>m(k,N)},{default:L(()=>[A(h,{type:"primary",text:"",icon:"el-icon-upload"},{default:L(()=>[Y(" 更新版本 ")]),_:1})]),_:2},1032,["action","headers","onSuccess"]),A(h,{type:"primary",text:"",icon:"el-icon-delete",onClick:k=>V(v)(N,O)},{default:L(()=>[Y(" 删除 ")]),_:2},1032,["onClick"])]),_:1},16)}}}),Gt={class:"flow-track"},Wt={key:0},Ft={key:1},Qt=W({__name:"flow-track",setup(e){const{flowDetail:t}=te(),a=E("table"),i=[{label:"table",icon:"ep:grid"},{label:"graph",icon:"ep:picture"},{label:"timeline",icon:"ep:finished"}],o=S(()=>{var r,w,u;return((u=(w=(r=t.value)==null?void 0:r.flowHistory)==null?void 0:w.filter(_=>_.taskNodeType==="userTask"))==null?void 0:u.map(_=>({..._,duration:st(_.duration)})))??[]}),f={addBtn:!1,menu:!1,border:!0,column:[{label:"节点名称",prop:"taskNodeName"},{label:"处理人",prop:"assigneeName"},{label:"接收时间",prop:"startTime"},{label:"处理时间",prop:"endTime"},{label:"办理时长",prop:"duration"},{label:"操作类型",prop:"type",dicUrl:"/sapier-flow/flow-param/getParam",dicQuery:{paramKey:"flow.handle.type"}},{label:"办理意见",prop:"comment",bind:"comment.handleComment"}]},{request:n}=Q(),{data:s}=ve(n).useParam("flow.handle.type");function c(r){var w;return(w=s.value)==null?void 0:w.find(u=>u.value===r)}return(r,w)=>{var m,p,y;const u=R("el-radio-button"),_=R("el-radio-group"),d=R("avue-crud"),v=R("el-card"),b=R("el-timeline-item"),g=R("el-timeline"),l=R("el-empty");return I(),M(H,null,[A(_,{modelValue:a.value,"onUpdate:modelValue":w[0]||(w[0]=h=>a.value=h)},{default:L(()=>[(I(),M(H,null,ae(i,h=>A(u,{key:h.label,label:h.label},{default:L(()=>[A(V(Me),{icon:h.icon},null,8,["icon"])]),_:2},1032,["label"])),64))]),_:1},8,["modelValue"]),ee("div",Gt,[a.value==="table"?(I(),$(d,{key:0,data:o.value,option:f},null,8,["data"])):Z("",!0),a.value==="graph"?(I(),$(We,{key:1,"model-value":(p=(m=V(t))==null?void 0:m.process)==null?void 0:p.flowData,"flow-history":(y=V(t))==null?void 0:y.flowHistory,view:"","show-legend":""},null,8,["model-value","flow-history"])):Z("",!0),a.value==="timeline"?(I(),M(H,{key:2},[o.value.length?(I(),$(g,{key:0},{default:L(()=>[(I(!0),M(H,null,ae([...o.value].reverse(),h=>(I(),$(b,{key:h.id,timestamp:h.endTime,placement:"top"},{default:L(()=>[A(v,null,{default:L(()=>{var T,D,N;return[ee("div",null,z(h.assigneeName)+" 开始处理 ["+z(h.taskNodeName)+"] 环节 ",1),h.duration?(I(),M("div",Wt," 办理时长："+z(h.duration),1)):Z("",!0),h.type&&((T=h.comment)!=null&&T.handleComment)?(I(),M("div",Ft,z((D=c(h.type))==null?void 0:D.label)+"意见："+z((N=h.comment)==null?void 0:N.handleComment),1)):Z("",!0)]}),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})):(I(),$(l,{key:1}))],64)):Z("",!0)])],64)}}});const Ht=Ne(Qt,[["__scopeId","data-v-ff68835f"]]),$e=Symbol("flowPagesConfig"),Jt={FlowDesign:{},FormDesign:{},FlowForm:Bt,tabs:[{label:"审批表单",prop:"formTab",component:Yt},{label:"附件资料",prop:"fileTab",component:zt},{label:"流程跟踪",prop:"trackTab",component:Ht}],request:()=>{},useFlowFormOptions:{type:"drawer",window:["","flow-form","left=0,top=0,width=1600,height=900"],overlay:{width:"80%",size:"80%",top:"100px",fullscreen:!0,destroyOnClose:!0}},upload:{props:{fileName:"fileOriginalName",fileType:"fileType",fileSize:"fileSize",fileUrl:"fileUrl",res:"res.data"}}},Xt={},Zt=Symbol("GLOBAL_OPTIONS_PROVIDE_KEY"),qt=()=>Xt,J=e=>e,he=e=>Array.isArray(e),Te=e=>e!==null&&typeof e=="object",De=e=>e instanceof Function,re=e=>e==null,Ve=typeof window>"u",Fe=()=>{var e;return Ve||re((e=window.document)===null||e===void 0?void 0:e.visibilityState)?!0:window.document.visibilityState==="visible"},ea=()=>{var e,t;return(e=!Ve&&((t=window.navigator)===null||t===void 0?void 0:t.onLine))!==null&&e!==void 0?e:!0},be=()=>new Promise(()=>{}),F=e=>ne(e)?e.value:e,ta=e=>Te(e)?Object.assign(he(e)?[]:{},e):e,ie=new Map,aa=e=>re(e)?void 0:ie.get(e),oa=(e,t,a)=>{const i=ie.get(e);i!=null&&i.timer&&clearTimeout(i.timer);const o=setTimeout(()=>ie.delete(e),t);ie.set(e,{...a,timer:o})};function Qe(e,t,a){let i,o,f,n,s,c,r=0,w=!1,u=!1,_=!0;const d=!t&&t!==0&&typeof window.requestAnimationFrame=="function";if(typeof e!="function")throw new TypeError("Expected a function");t=+t||0,Te(a)&&(w=!!a.leading,u="maxWait"in a,f=u?Math.max(+a.maxWait||0,t):f,_="trailing"in a?!!a.trailing:_);function v(k){const x=i,C=o;return i=o=void 0,r=k,n=e.apply(C,x),n}function b(k,x){return d?(window.cancelAnimationFrame(s),window.requestAnimationFrame(k)):setTimeout(k,x)}function g(k){if(d)return window.cancelAnimationFrame(k);clearTimeout(k)}function l(k){return r=k,s=b(y,t),w?v(k):n}function m(k){const x=k-c,C=k-r,P=t-x;return u?Math.min(P,f-C):P}function p(k){const x=k-c,C=k-r;return c===void 0||x>=t||x<0||u&&C>=f}function y(){const k=Date.now();if(p(k))return h(k);s=b(y,m(k))}function h(k){return s=void 0,_&&i?v(k):(i=o=void 0,n)}function T(){s!==void 0&&g(s),r=0,i=c=o=s=void 0}function D(){return s===void 0?n:h(Date.now())}function N(){return s!==void 0}function O(){const k=Date.now(),x=p(k);for(var C=arguments.length,P=new Array(C),K=0;K<C;K++)P[K]=arguments[K];if(i=P,o=this,c=k,x){if(s===void 0)return l(c);if(u)return s=b(y,t),v(c)}return s===void 0&&(s=b(y,t)),n}return O.cancel=T,O.flush=D,O.pending=N,O}function la(e,t,a){let i=!0,o=!0;if(typeof e!="function")throw new TypeError("Expected a function");return Te(a)&&(i="leading"in a?!!a.leading:i,o="trailing"in a?!!a.trailing:o),Qe(e,t,{leading:i,trailing:o,maxWait:t})}var na=J((e,t)=>{let{debounceInterval:a,debounceOptions:i,manual:o}=t;const f=E(!1),n=E(),s=S(()=>i),c=S(()=>F(a)),r=E(e.context.runAsync);return o||(f.value=!0),X(w=>{re(c.value)||(n.value=Qe(u=>u(),c.value,s.value),e.context.runAsync=function(){for(var u=arguments.length,_=new Array(u),d=0;d<u;d++)_[d]=arguments[d];return new Promise((v,b)=>{f.value?(f.value=!1,r.value(..._).then(v).catch(b)):n.value(()=>{r.value(..._).then(v).catch(b)})})},w(()=>{var u;(u=n.value)===null||u===void 0||u.cancel(),e.context.runAsync=r.value}))}),{onCancel(){var w;(w=n.value)===null||w===void 0||w.cancel()}}}),ra=J((e,t)=>{let{errorRetryCount:a=0,errorRetryInterval:i=0}=t;const o=E(),f=E(0),n=S(()=>F(a)),s=S(()=>F(i));let c=!1;const r=()=>{f.value=0},w=S(()=>{if(s.value)return s.value;const d=1e3,v=1,b=9,g=Math.floor(Math.random()*2**Math.min(f.value,b)+v);return d*g}),u=()=>{let d;const v=n.value===-1,b=f.value<n.value;return(v||b)&&(v||(f.value+=1),d=setTimeout(()=>{c=!0,e.context.refresh()},w.value)),()=>d&&clearTimeout(d)},_=()=>{o.value&&o.value()};return{onBefore(){c||r(),c=!1,_()},onSuccess(){r()},onError(){o.value=u()},onCancel(){r(),_()}}}),sa=J((e,t)=>{let{ready:a=E(!0),manual:i,defaultParams:o=[]}=t;return pe(a,f=>{!i&&f&&e.context.run(...o)},{flush:"sync"}),{onBefore(){if(!(De(a)?a():a.value))return e.loading.value=!1,{isBreak:!0}}}}),ua=J((e,t)=>{let{refreshDeps:a,refreshDepsAction:i,manual:o}=t;if(a===void 0||he(a)&&a.length===0)return{};const f=he(a)?a:[a];return pe(f,()=>{i?i():!o&&e.context.refresh()}),{}}),ia=J((e,t)=>{let{throttleInterval:a,throttleOptions:i}=t;const o=E(),f=S(()=>F(a)),n=S(()=>i),s=E(e.context.runAsync);return X(c=>{if(re(a))return{};o.value=la(r=>r(),f.value,n.value),e.context.runAsync=function(){for(var r=arguments.length,w=new Array(r),u=0;u<r;u++)w[u]=arguments[u];return new Promise((_,d)=>{o.value(()=>{s.value(...w).then(_).catch(d)})})},c(()=>{var r;(r=o.value)===null||r===void 0||r.cancel(),e.context.runAsync=s.value})}),{onCancel(){var c;(c=o.value)===null||c===void 0||c.cancel()}}});const ca=(e,t)=>a=>{Object.keys(a).forEach(i=>{e[i].value=a[i]}),t.forEach(i=>i(e))},da=(e,t)=>()=>{let a=t;for(let i=e.length;i-- >0;)a=e[i](a);return a()},pa=(e,t,a)=>{var i,o;const{initialData:f,onSuccess:n,onError:s,onBefore:c,onAfter:r}=t,w=E((i=a==null?void 0:a.loading)!==null&&i!==void 0?i:!1),u=ue((o=a==null?void 0:a.data)!==null&&o!==void 0?o:f),_=ue(a==null?void 0:a.error),d=E(a==null?void 0:a.params),v=E([]),b=ue("pending"),g={},l=ca({status:b,loading:w,data:u,error:_,params:d},[]),m=function(y){for(var h=arguments.length,T=new Array(h>1?h-1:0),D=1;D<h;D++)T[D-1]=arguments[D];if(y==="onQuery"){const N=v.value.map(O=>O.onQuery).filter(Boolean);return{servicePromise:da(N,T[0])()}}else{const N=v.value.map(O=>{var k;return(k=O[y])===null||k===void 0?void 0:k.call(O,...T)});return Object.assign({},...N)}},p=E(0);return g.runAsync=async function(){for(var y=arguments.length,h=new Array(y),T=0;T<y;T++)h[T]=arguments[T];l({loading:!0,params:h,status:"pending"}),p.value+=1;const D=p.value,{isBreak:N,breakResult:O=be()}=m("onBefore",h);if(N)return l({status:"settled"}),O;c==null||c(h);try{const k=()=>new Promise(P=>P(e(...d.value)));let{servicePromise:x}=m("onQuery",k);x||(x=k());const C=await x;return D!==p.value?be():(l({data:C,loading:!1,error:void 0,status:"settled"}),m("onSuccess",C,h),n==null||n(C,h),D===p.value&&m("onAfter",h,C,void 0),r==null||r(h),C)}catch(k){if(D!==p.value)return be();throw l({loading:!1,error:k,status:"settled"}),m("onError",k,h),s==null||s(k,h),D===p.value&&m("onAfter",h,void 0,k),r==null||r(h),k}},g.run=function(){g.runAsync(...arguments).catch(y=>{s||console.error(y)})},g.cancel=()=>{p.value+=1,l({loading:!1}),m("onCancel")},g.refresh=()=>{g.run(...d.value||[])},g.refreshAsync=()=>g.runAsync(...d.value||[]),g.mutate=y=>{const h=De(y)?y(u.value):y,T=ta(h);l({data:T}),m("onMutate",T)},{status:b,loading:w,data:u,error:_,params:d,plugins:v,context:g}};function fa(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=arguments.length>2?arguments[2]:void 0;const i=Ce(Zt,{}),o={...qt(),...i,...t},{manual:f=!1,defaultParams:n=[]}=o,s=pa(e,o);if(s.plugins.value=a.map(c=>c(s,o)),!f){const c=s.params.value||n;s.context.run(...c)}return fe(()=>{s.context.cancel()}),{loading:s.loading,data:s.data,error:s.error,params:s.params,cancel:s.context.cancel,refresh:s.context.refresh,refreshAsync:s.context.refreshAsync,mutate:s.context.mutate,run:s.context.run,runAsync:s.context.runAsync}}const ce=new Map,ma=(e,t)=>{ce.set(e,t),t.then(a=>(ce.delete(e),a)).catch(()=>{ce.delete(e)})},va=e=>ce.get(e),q=new Map,ba=(e,t)=>{q.has(e)&&q.get(e).forEach(a=>a(t))},ga=(e,t)=>(q.has(e)?q.get(e).push(t):q.set(e,[t]),()=>{const a=q.get(e).indexOf(t);q.get(e).splice(a,1)});var _a=J((e,t)=>{let{cacheKey:a,cacheTime:i=6e5,staleTime:o=0,getCache:f,setCache:n}=t;if(!a)return{};const s=De(a)?a:()=>a,c=E(()=>{});let r;const w=l=>f?f(l):aa(l),u=(l,m,p)=>{n?n(l,p):oa(l,m,p),ba(l,p.data)},_=l=>o===-1||l+o>new Date().getTime(),d=(l,m)=>Object.prototype.hasOwnProperty.call(l,m),v=l=>{const m=s(l);return ga(m,p=>{e.data.value=p})},b=s(),g=w(b);return g&&d(g,"data")&&(e.data.value=g.data,e.params.value=g.params),b&&(c.value=v()),fe(()=>{c.value()}),{onBefore(l){const m=s(l),p=w(m);if(!p||!d(p,"data"))return{};if(_(p.time))return e.data.value=p.data,e.loading.value=!1,{isBreak:!0,breakResult:p.data};e.data.value=p.data},onQuery(l){const m=e.params.value,p=s(m);let y=va(p);return y&&y!==r?()=>y:(y=l(),r=y,ma(p,y),()=>y)},onSuccess(l,m){const p=s(m);p&&(c.value(),u(p,i,{data:l,params:m,time:new Date().getTime()}),c.value=v(m))},onMutate(l){const m=s(e.params.value);m&&(c.value(),u(m,i,{data:l,params:e.params.value,time:new Date().getTime()}),c.value=v(e.params.value))}}});function ya(e){let t,a;class i extends Promise{constructor(f){super(f),this.cancel=()=>{a(),clearTimeout(t)}}}return new i(o=>{a=o,t=setTimeout(a,e)})}function ge(){return new Date().getTime()}var wa=J((e,t)=>{let{loadingDelay:a=0,loadingKeep:i=0}=t;const o=E(()=>{}),f=S(()=>F(a)),n=S(()=>F(i));let s=0,c={};const r=()=>{let w;return f.value&&(w=setTimeout(()=>{e.status.value==="pending"&&(e.loading.value=!0)},f.value)),()=>w&&clearTimeout(w)};return{onBefore(){e.loading.value=!f.value,o.value(),o.value=r(),s=ge()},onQuery(w){if(!n.value)return()=>w();c=ya(n.value+f.value);const u=async()=>{try{const d=await w();return ge()-s<=f.value&&c.cancel(),Promise.resolve(d)}catch(d){return ge()-s<=f.value&&c.cancel(),Promise.reject(d)}},_=Promise.allSettled([u(),c]).then(d=>{const v=d[0];return v.status==="fulfilled"?v.value:Promise.reject(v.reason)});return()=>_},onCancel(){o.value()},onAfter(){o.value()}}}),_e;const He=new Set,Je=new Set,Xe=new Set,de=(e,t)=>{let a;switch(e){case"FOCUS_LISTENER":a=He;break;case"RECONNECT_LISTENER":a=Xe;break;case"VISIBLE_LISTENER":a=Je;break}if(!a.has(t))return a.add(t),()=>{a.delete(t)}},ye=e=>{e.forEach(t=>{t()})};!Ve&&(_e=window)!==null&&_e!==void 0&&_e.addEventListener&&(window.addEventListener("visibilitychange",()=>{Fe()&&ye(Je)},!1),window.addEventListener("focus",()=>ye(He),!1),window.addEventListener("online",()=>ye(Xe),!1));var ha=J((e,t)=>{let{pollingInterval:a,pollingWhenHidden:i=!1,pollingWhenOffline:o=!1,errorRetryCount:f=0}=t;const n=E(),s=E(!1),c=S(()=>F(a)),r=S(()=>F(f)),w=[],u=b=>{b&&w.push(b)},_=()=>(i||Fe())&&(o||ea()),d=b=>{if(e.error.value&&r.value!==0)return;let g;if(!re(c.value)&&c.value>=0)if(_())g=setTimeout(b,c.value);else{s.value=!0;return}return()=>g&&clearTimeout(g)},v=()=>{s.value&&_()&&(e.context.refresh(),s.value=!1)};return pe(c,()=>{n.value&&(n.value(),n.value=d(()=>e.context.refresh()))}),i||u(de("VISIBLE_LISTENER",v)),o||u(de("RECONNECT_LISTENER",v)),fe(()=>{w.forEach(b=>b())}),{onBefore(){var b;(b=n.value)===null||b===void 0||b.call(n)},onCancel(){var b;(b=n.value)===null||b===void 0||b.call(n)},onAfter(){n.value=d(()=>e.context.refresh())}}});const ka=(e,t)=>{let a=!1;return function(){a||(a=!0,e(...arguments),setTimeout(()=>{a=!1},t))}};var Ca=J((e,t)=>{let{refreshOnWindowFocus:a=!1,refocusTimespan:i=5e3}=t;const o=S(()=>F(a)),f=S(()=>F(i)),n=[],s=r=>{r&&n.push(r)},c=()=>{n.forEach(r=>r())};return X(()=>{if(c(),o.value){const r=ka(e.context.refresh,f.value);s(de("VISIBLE_LISTENER",r)),s(de("FOCUS_LISTENER",r))}}),fe(()=>{c()}),{}});function oe(e,t){return fa(e,t,[wa,ra,na,ha,ia,Ca,ua,sa,_a])}function Na(e){const t={list:"/sapier-flow/flow-user-common/list",save:"/sapier-flow/flow-user-common/save",update:"/sapier-flow/flow-user-common/update",remove:"/sapier-flow/flow-user-common/remove",batchUpdate:"/sapier-flow/flow-user-common/batchUpdate"},a=c=>e.get(t.list,{params:{type:c,ascs:"sort"}});return{url:t,getList:a,useList:c=>oe(()=>a(c.value).then(r=>r.data.records),{refreshDeps:[c]}),create:c=>e.post(t.save,c),update:c=>e.post(t.update,c),remove:c=>e.post(t.remove,{},{params:{ids:c}}),batchUpdate:c=>e.post(t.batchUpdate,c)}}var Ze=(e=>(e.默认="default",e.主要="primary",e.成功="success",e.警告="warning",e.危险="danger",e.信息="info",e.文字="text",e))(Ze||{}),Ta=(e=>(e.保存草稿="flow_draft",e.发送="flow_pass",e.退回="flow_reject",e.终止="flow_terminate",e.撤销="flow_revoke",e.撤回到发起="flow_withdraw",e.打印="flow_print",e.转办="flow_transfer",e.加签="flow_add_instance",e.减签="flow_del_instance",e.指定回退="flow_rollback",e.绿色通道="flow_green",e.传阅="flow_circulate",e))(Ta||{}),xe=(e=>(e.显示="true",e.隐藏="false",e.发起人="startUser",e.处理人="assignee",e.已办="done",e.待办="todo",e.未发起="notstarted",e.已发起="started",e.未办结="unfinished",e.已办结="finished",e))(xe||{}),Ie=(e=>(e.不显示="false",e.指定节点="specifyNode",e.审批人="assignee",e.传阅人="circulate",e.意见="comment",e))(Ie||{}),qe=(e=>(e[e.禁用=0]="禁用",e[e.正常=1]="正常",e))(qe||{});function et(e){const t={list:"/sapier-flow/dev-button/list",save:"/sapier-flow/dev-button/save",update:"/sapier-flow/dev-button/update",remove:"/sapier-flow/dev-button/remove"},a=s=>e.get(t.list,{params:s});return{url:t,getList:a,useList:()=>oe(()=>a({size:-1,ascs:"sort"}).then(s=>s.data.records)),create:s=>e.post(t.save,s),update:s=>e.post(t.update,s),remove:s=>e.post(t.remove,{},{params:{ids:s}})}}function Da(e){const t={list:"/sapier-flow/flow-file/list",save:"/sapier-flow/flow-file/save",remove:"/sapier-flow/flow-file/remove"};return{getList:f=>e.get(t.list,{params:f}),create:f=>e.post(t.save,f),remove:f=>e.post(t.remove,{},{params:{ids:f}})}}function ve(e){const t={list:"/sapier-flow/flow-param/list",save:"/sapier-flow/flow-param/save",update:"/sapier-flow/flow-param/update",remove:"/sapier-flow/flow-param/remove",all:"/sapier-flow/flow-param/getAllParam",key:"/sapier-flow/flow-param/getParam"},a=r=>e.get(t.list,{params:r}),i=()=>e.get(t.all),o=r=>e.get(t.key,{params:{paramKey:r}});return{url:t,getList:a,getAllParam:i,getParam:o,useParam:r=>oe(()=>o(r).then(w=>w.data)),create:r=>e.post(t.save,r),update:r=>e.post(t.update,r),remove:r=>e.post(t.remove,{},{params:{ids:r}})}}var Va=(e=>(e[e.已办=1]="已办",e[e.待办=2]="待办",e[e.失败=3]="失败",e[e.撤销=4]="撤销",e[e.终止=5]="终止",e))(Va||{}),xa=(e=>(e[e.已办结=1]="已办结",e[e.未办结=2]="未办结",e[e.已终止=3]="已终止",e))(xa||{}),Ia=(e=>(e[e.系统执行=1]="系统执行",e[e.用户办理=2]="用户办理",e[e.任务撤销=3]="任务撤销",e[e.任务退回=4]="任务退回",e[e.流程终止=5]="流程终止",e[e.任务转办=6]="任务转办",e[e.绿色通道=7]="绿色通道",e))(Ia||{});function Le(e){const t={publishList:"/sapier-flow/flow-run/queryPublishFlowList",taskList:"/sapier-flow/flow-run/userTaskList",detail:"/sapier-flow/flow-run/queryPublishFlowDetail",approvalNode:"/sapier-flow/flow-run/queryApprovalNode",start:"/sapier-flow/flow-run/startProcess",commit:"/sapier-flow/flow-run/commitTask",draft:"/sapier-flow/flow-run/saveDraft",revoke:"/sapier-flow/flow-run/revokeTask",terminate:"/sapier-flow/flow-run/terminateFlow",withdraw:"/sapier-flow/flow-run/withdrawToStart",transfer:"/sapier-flow/flow-run/transferTask",reject:"/sapier-flow/flow-run/rollbackTask",green:"/sapier-flow/flow-run/greenTask",circulate:"/sapier-flow/flow-circulate/commitTask"},a=l=>e.get(t.detail,{params:l}),i=l=>e.post(t.approvalNode,l),o=l=>e.post(t.start,l),f=l=>e.post(t.commit,l),n=l=>e.post(t.draft,l),s=l=>e.post(t.revoke,l),c=l=>e.post(t.terminate,l),r=l=>e.post(t.withdraw,l),w=l=>e.post(t.transfer,l),u=l=>e.post(t.reject,l),_=l=>e.post(t.circulate,l),d=l=>e.post(t.green,l),v=()=>e.get(t.publishList);return{url:t,getFlowDetail:a,getApprovalNode:i,startTask:o,commitTask:f,saveDraft:n,revokeTask:s,terminateTask:c,withdrawTask:r,transferTask:w,rejectTask:u,greenChannel:d,circulateTask:_,getPublishList:v,usePublishList:()=>oe(()=>v().then(l=>l.data)),getTaskList:l=>e.get(t.taskList,{params:l})}}function La(e){const t={tree:"/sapier-flow/flow-user/tree"},a=o=>e.get(t.tree,{params:{filter:o}});return{url:t,getUserTree:a,useUserTree:()=>oe(()=>a().then(o=>o.data))}}var Oe=(e=>(e.ASSIGN_ID="ASSIGN_ID",e.ASSIGN_UUID="ASSIGN_UUID",e.AUTO="AUTO",e.INPUT="INPUT",e.NONE="NONE",e))(Oe||{}),Ee=(e=>(e.bigint="bigint",e.blob="blob",e.char="char",e.date="date",e.datetime="datetime",e.decimal="decimal",e.double="double",e.enum="enum",e.float="float",e.int="int",e.longblob="longblob",e.longtext="longtext",e.mediumblob="mediumblob",e.mediumint="mediumint",e.mediumtext="mediumtext",e.set="set",e.smallint="smallint",e.text="text",e.time="time",e.timestamp="timestamp",e.tinyblob="tinyblob",e.tinyint="tinyint",e.tinytext="tinytext",e.varbinary="varbinary",e.varchar="varchar",e.year="year",e))(Ee||{});function Wa(e){const t={list:"/sapier-flow/dev-table/list",save:"/sapier-flow/dev-table/save",update:"/sapier-flow/dev-table/update",remove:"/sapier-flow/dev-table/remove",deploy:"/sapier-flow/dev-table/deploy",getFields:"/sapier-flow/dev-table/getTableFields"},a=r=>e.get(t.list,{params:r});return{url:t,getList:a,useList:()=>oe(()=>a({size:-1}).then(r=>r.data.records)),create:r=>e.post(t.save,r),update:r=>e.post(t.update,r),remove:r=>e.post(t.remove,{},{params:{ids:r}}),deploy:r=>e.post(t.deploy,r),getFields:r=>e.get(t.getFields,{params:r})}}var tt=(e=>(e[e.否=0]="否",e[e.是=1]="是",e))(tt||{});const je=G(tt),Fa=G(Ee),Qa=G(Oe);function Q(e,t){return e&&t?(e.provide($e,dt(Jt,t)),t):Ce($e)}const Ha={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:6,labelWidth:150,span:24,column:[{label:"按钮名称",prop:"name",search:!0},{label:"按钮标识",prop:"buttonKey",search:!0},{label:"按钮图标",prop:"icon",component:"icon-select"},{label:"按钮类型",prop:"buttonType",type:"select",dicData:G(Ze)},{label:"默认显示条件",prop:"display",type:"select",multiple:!0,dataType:"string",value:"false",dicData:G(xe),tip:"选择多个时,所有条件都满足才显示",labelTip:`显示: 始终显示;<br/>隐藏: 始终隐藏;<br/>
      发起人: 用户为发起人时显示;<br/>处理人: 用户为处理人时显示;<br/>
      已办: 任务状态为已办时显示;<br/>待办: 任务状态为待办时显示;<br/>
      未发起: 流程未发起时显示;<br/>已发起: 流程已发起时显示;<br/>
      未办结: 流程未办结时显示;<br/>已办结: 流程已办结时显示;`},{label:"默认审批窗口显示",prop:"approval",type:"select",multiple:!0,dataType:"string",value:"false",dicData:G(Ie),labelTip:`不显示: 不显示审批窗口;<br/>指定节点: 显示指定节点选择框(常用于绿色通道等);<br/>
      审批人: 显示审批人选择框;<br/>传阅人: 显示传阅人选择框;<br/>意见: 显示意见输入框;`},{label:"排序",prop:"sort",type:"number",value:0},{label:"状态",prop:"status",type:"switch",value:1,dicData:G(qe)},{label:"按钮预览",prop:"buttonPreview",width:150}]},at={menuBtn:!1,span:24,column:[{label:"流程名称",prop:"flowName",rules:[{required:!0,message:"请输入流程名称"}]},{label:"流程标识",prop:"flowKey",editDisabled:!0,rules:[{required:!0,message:"请输入流程标识"}]},{label:"流程分类",prop:"categoryId",type:"select",dicUrl:"/sapier-flow/flow-category/list",dicQuery:{size:-1},props:{label:"name",value:"id"}},{label:"流程图标",prop:"flowIcon",component:"icon-select"},{label:"流程描述",prop:"remarks"},{label:"自定义表单",prop:"formPath"},{label:"关联表",prop:"formDataTable",type:"select",filterable:!0,allowCreate:!0,defaultFirstOption:!0,dicUrl:"/sapier-flow/dev-table/list",dicQuery:{size:-1},props:{label:"tableComment",value:"tableName",desc:"tableName",res:"data.records"}},{label:"表单设计",prop:"formOption",display:!1,hide:!0},{label:"模型设计",prop:"flowData",display:!1,hide:!0}]},Ja={rowKey:"flowModuleId",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:6,tabs:!0,dialogFullscreen:!0,addBtn:!1,editBtn:!1,delBtn:!1,menuWidth:100,menuType:"menu",menuBtnTitle:"操作",column:[...at.column.map((e,t)=>({...e,search:t<2})),{label:"流程主版本",prop:"mainVersion",formatter(e,t){return t?`V${t||""}`:""}}]},Xa={rowKey:"flowDeloyId",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:6,tabs:!0,dialogFullscreen:!0,addBtn:!1,editBtn:!1,delBtn:!1,menuWidth:100,menuType:"menu",menuBtnTitle:"操作",column:[...at.column,{label:"流程版本",prop:"version",formatter(e,t){return t?`V${t||""}`:""}},{label:"是否主版本",prop:"mainVersion",type:"select",dicData:[{label:"否",value:0},{label:"是",value:1}]}]},Oa=[{label:"流程名称",prop:"flowName"},{label:"流程标识",prop:"flowKey"},{label:"流程分类",prop:"categoryId",type:"select",search:!0,dicUrl:"/sapier-flow/flow-category/list",props:{label:"name",value:"id"}},{label:"标题",prop:"processTitle",search:!0},{label:"流水号",prop:"serialNumber"},{label:"当前节点",prop:"taskNodeName"},{label:"审批人",prop:"assigneeName"},{label:"申请人",prop:"applyUserName"},{label:"接收时间",prop:"startTime"},{label:"任务状态",prop:"status",type:"select",search:!0,searchValue:2,dicUrl:"/sapier-flow/flow-param/getParam",dicQuery:{paramKey:"flow.task.status"}}].map(e=>({...e,display:!1})),Ea=[{label:"审批人",prop:"assignee"},{label:"节点名称",prop:"taskNodeName"},{label:"接收时间",prop:"startTime",type:"datetime",format:"YYYY-MM-DD HH:mm:ss",valueFormat:"YYYY-MM-DD HH:mm:ss"},{label:"结束时间",prop:"endTime",type:"datetime",format:"YYYY-MM-DD HH:mm:ss",valueFormat:"YYYY-MM-DD HH:mm:ss"},{label:"耗时",prop:"duration"},{label:"传阅意见",prop:"comment"}].map(e=>({...e,hide:!0})),Za={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:6,menu:!0,addBtn:!1,column:[...Oa,...Ea]};const Ke=[{label:"字段名称",prop:"name"},{label:"字段备注",prop:"comment"},{label:"字段类型",prop:"type",type:"select",filterable:!0,allowCreate:!0,defaultFirstOption:!0,dicData:G(Ee)},{label:"字段长度",prop:"size",type:"number"},{label:"小数位",prop:"point",type:"number"},{label:"默认值",prop:"default"},{label:"是否主键",prop:"primary",type:"switch",dicData:je,value:0},{label:"是否允许为空",prop:"permitNull",type:"switch",dicData:je,value:1}],qa={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:6,span:24,dialogFullscreen:!0,column:[{label:"表名",prop:"tableName",search:!0},{label:"表注释",prop:"tableComment",search:!0},{label:"表引擎",prop:"tableEngine"},{label:"表主键策略",prop:"tablePrimary",type:"select",filterable:!0,allowCreate:!0,defaultFirstOption:!0,dicData:G(Oe)},{label:"数据库字段",prop:"editFields",hide:!0,type:"dynamic",children:{column:Ke}},{label:"默认字段",prop:"defaultFields",hide:!0,type:"dynamic",children:{addBtn:!1,delBtn:!1,column:Ke}}]};function ot(e){return new Promise((t,a)=>{V(e).validate((o,f,n)=>{o?(f(),t(n)):a(n)})})}export{Kt as A,Et as B,Jt as C,Ht as D,Yt as E,We as F,zt as G,Ia as H,Vt as I,xt as J,It as K,Lt as L,Ge as M,Ot as N,$e as O,Fa as P,Qa as Q,Va as T,tt as W,Bt as _,ot as a,oe as b,Q as c,et as d,Ja as e,Xa as f,Wa as g,at as h,Za as i,ve as j,Le as k,qa as l,Na as m,Ze as n,Ta as o,xe as p,Ie as q,qe as r,Da as s,Ha as t,te as u,xa as v,je as w,La as x,Oe as y,Ee as z};
