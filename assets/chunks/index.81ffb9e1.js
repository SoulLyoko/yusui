import{q as Q,ab as W,d as X,ac as Y,r as Z}from"./framework.93e84c5c.js";import"./index.e825d1f5.js";import{u as _}from"./index.386fc70b.js";import{o as ee,a as q}from"./omitBy.496be11f.js";import{o as ae,a as N,s as te}from"./snakeCase.f05f4dc6.js";import{m as re}from"./merge.0f542de0.js";import{t as A,s as se}from"./index.0246ace1.js";import{c as z}from"./cloneDeep.6b1411dd.js";import{g as T}from"./get.51c768ca.js";import{E as M,a as V}from"./index.e327f3f4.js";import{i as I}from"./isNil.990ccdb3.js";function oe(t){return{all:t=t||new Map,on:function(r,s){var o=t.get(r);o?o.push(s):t.set(r,[s])},off:function(r,s){var o=t.get(r);o&&(s?o.splice(o.indexOf(s)>>>0,1):t.set(r,[]))},emit:function(r,s){var o=t.get(r);o&&o.slice().map(function(l){l(s)}),(o=t.get("*"))&&o.slice().map(function(l){l(r,s)})}}}function ne(t){const r=oe(t);return r.emitAsync=async function(s,o){const l=this.all.get(s);if(l)for(const c of l)await c(o);const n=this.all.get("*");if(n)for(const c of n)await c(s,o)},r}function ce({crudState:t}){if(t.mockCache)try{const c=`mock-${t.mockCache}`,f=localStorage.getItem(c);t.mockData=f?JSON.parse(f):t.mockData,Q(()=>t.mockData,()=>localStorage.setItem(c,JSON.stringify(t.mockData)),{immediate:!0,deep:!0})}catch(n){console.log(n)}function r(n){const{currKey:c,sizeKey:f}=t.crudOption,O=n[c],C=n[f],{descs:P,ascs:k}=n,F=ee(n,[c,f,"descs","ascs"]),U=t.mockData.filter(v=>Object.entries(F).every(([D,b])=>typeof v[D]=="string"?v[D].includes(b):v[D]==b)),K=ae(U,P||k||void 0,P?"desc":k?"asc":void 0).filter((v,D)=>D>=(O-1)*C&&D<O*C);return Promise.resolve({code:200,msg:"操作成功",data:{records:K,total:U.length}})}function s(n){const{crudOption:{rowKey:c}}=t;return t.mockData.push({[c]:_(16,10),...n}),Promise.resolve({code:200,msg:"操作成功"})}function o(n){const{crudOption:{rowKey:c}}=t;return t.mockData=t.mockData.map(f=>f[c]===n[c]?n:f),Promise.resolve({code:200,msg:"操作成功"})}function l(n){const{crudOption:{rowKey:c}}=t;if(typeof n=="string"){const f=n.split(",");t.mockData=t.mockData.filter(O=>!f.some(C=>C==O[c]))}else t.mockData=t.mockData.filter(f=>n!=f[c]);return Promise.resolve({code:200,msg:"操作成功"})}return{getList:r,create:s,update:o,remove:l}}function fe(t){var c;const r=W(re({crudOption:{rowKey:((c=t==null?void 0:t.tableOption)==null?void 0:c.rowKey)??"id",getList:f=>s(f),create:f=>o(f),update:f=>l(f),remove:f=>n(f),dataPath:"res.data.records",totalPath:"res.data.total",currKey:"current",sizeKey:"size",isPage:!0,isSort:!0,delConfirm:!0,clearSelection:!0,saveSuccessMsg:"保存成功",updateSuccessMsg:"保存成功",delSuccessMsg:"删除成功"},pageOption:{total:0,currentPage:1,pageSize:10},sortOption:{},tableLoading:!1,tableOption:{},tableData:[],dataSelections:[],searchForm:{},queryForm:{},formData:{},formType:"",defaults:{},mockData:[],mockCache:""},t)),{getList:s,create:o,update:l,remove:n}=ce({crudState:r});return r}function ie({crudRef:t,crudState:r,emitter:s,options:o}){const l=o.getDataList??(async()=>{var R,j;const{dataPath:e,totalPath:a,currKey:h,sizeKey:i,isPage:m,isSort:g,clearSelection:y}=r.crudOption,{currentPage:u,pageSize:p}=r.pageOption,w=m?{[h]:u,[i]:p}:{},x=g?r.sortOption:{},E=z({...r.searchForm,...w,...x,...r.queryForm}),[$]=await A(s.emitAsync("beforeGetList",E));if($!==null)return;const{getList:H}=r.crudOption;if(H){r.tableLoading=!0,await se(100);try{const L=await H(F(E));console.log("getDataList ~ res",L),r.tableData=T({res:L},e,[]),r.pageOption.total=T({res:L},a,0),await s.emitAsync("afterGetList",L)}catch(L){console.error("getDataList ~ err",L),r.tableData=[],r.pageOption.total=0}finally{y&&((j=(R=t==null?void 0:t.value)==null?void 0:R.selectClear)==null||j.call(R)),r.tableLoading=!1}}}),n=o.handleSave??(async(e,a,h)=>{const i=z({...r.formData,...e}),[m]=await A(s.emitAsync("beforeSave",i)),[g]=await A(s.emitAsync("beforeSubmit",i));if(m!==null||g!==null)return h==null?void 0:h();const{rowKey:y,create:u,saveSuccessMsg:p}=r.crudOption;if(!u)return h==null?void 0:h();delete i[y];try{const w=await u(k(i));return p&&M.success(p),await s.emitAsync("afterSave",w),await s.emitAsync("afterSubmit",w),a==null||a(),l()}catch(w){console.error("handleSave ~ err",w),h==null||h()}}),c=o.handleUpdate??(async(e,a,h,i)=>{const m=z({...r.formData,...e}),[g]=await A(s.emitAsync("beforeUpdate",m)),[y]=await A(s.emitAsync("beforeSubmit",m));if(g!==null||y!==null)return i==null?void 0:i();const{update:u,updateSuccessMsg:p}=r.crudOption;if(!u)return i==null?void 0:i();try{const w=await u(k(m));return p&&M.success(p),await s.emitAsync("afterUpdate",w),await s.emitAsync("afterSubmit",w),h==null||h(),l()}catch(w){console.error("handleUpdate ~ err",w),i==null||i()}}),f=o.handleDel??(async e=>{const a=z(e),[h]=await A(s.emitAsync("beforeDel",a));if(h!==null)return;const{rowKey:i,remove:m,delConfirm:g,delSuccessMsg:y}=r.crudOption;if(m){g&&await V.confirm("确认进行删除操作？","提示",{type:"warning"});try{const u=await m(a[i]);return y&&M.success(y),await s.emitAsync("afterDel",u),l()}catch(u){console.error("handleDel ~ err",u)}}}),O=o.batchDel??(async()=>{const e=z(r.dataSelections),[a]=await A(s.emitAsync("beforeBatchDel",e));if(a!==null)return;const{rowKey:h,remove:i,delConfirm:m,delSuccessMsg:g}=r.crudOption;if(!i)return;const y=e.length;if(!y)return M.warning("请选择删除项");m&&await V.confirm(`确认删除所选的${y}条数据？`,"提示",{type:"warning"});const u=e.map(p=>p[h]).join(",");try{const p=await i(u);return g&&M.success(g),await s.emitAsync("afterBatchDel",p),l()}catch(p){console.error("batchDel ~ err",p)}}),C=(e,a)=>a.includes("$"),P=e=>e==="",k=o.filterRow??(e=>q(e,N(I,C))),F=o.filterParams??(e=>q(e,N(I,P,C))),U=o.searchChange??(async(e,a)=>{r.pageOption.currentPage=1,Object.keys(r.searchForm).forEach(m=>{delete r.searchForm[m]}),Object.keys(e).forEach(m=>{r.searchForm[m]=e[m]});const[h]=await A(s.emitAsync("beforeSearch",r.searchForm));if(h!==null)return a==null?void 0:a();await l();const[i]=await A(s.emitAsync("afterSearch",r.searchForm));if(i!==null)return a==null?void 0:a();a==null||a()}),B=o.searchReset??(async()=>{Object.keys(r.searchForm).forEach(e=>{delete r.searchForm[e]}),await s.emitAsync("beforeSearchReset",r.searchForm),await l(),await s.emitAsync("afterSearchReset",r.searchForm)}),K=o.selectionChange??(e=>{r.dataSelections=e}),v=o.pageSizeChange??(e=>(r.pageOption.pageSize=e,l())),D=o.pageCurrentChange??(e=>(r.pageOption.currentPage=e,l())),b=o.sortChange??(({order:e,prop:a})=>(e&&a?r.sortOption={[e.replace("ending","s")]:te(a)}:r.sortOption={},l())),G=o.beforeOpen??(async(e,a)=>{r.formType=a,await s.emitAsync("beforeOpen",a),e(),await s.emitAsync("afterOpen",a)}),d=o.beforeClose??(async(e,a)=>{r.formType=a,await s.emitAsync("beforeClose",a),e(),await s.emitAsync("afterClose",a)});return{getDataList:l,handleSave:n,handleUpdate:c,handleDel:f,batchDel:O,searchChange:U,searchReset:B,selectionChange:K,pageSizeChange:v,pageCurrentChange:D,sortChange:b,beforeOpen:G,beforeClose:d}}function le(){const t=ne();return{emitter:t,beforeGetList:e=>{t.on("beforeGetList",async(...a)=>await(e==null?void 0:e(...a)))},afterGetList:e=>{t.on("afterGetList",async(...a)=>await(e==null?void 0:e(...a)))},beforeSave:e=>{t.on("beforeSave",async(...a)=>await(e==null?void 0:e(...a)))},afterSave:e=>{t.on("afterSave",async(...a)=>await(e==null?void 0:e(...a)))},beforeUpdate:e=>{t.on("beforeUpdate",async(...a)=>await(e==null?void 0:e(...a)))},afterUpdate:e=>{t.on("afterUpdate",async(...a)=>await(e==null?void 0:e(...a)))},beforeSubmit:e=>{t.on("beforeSubmit",async(...a)=>await(e==null?void 0:e(...a)))},afterSubmit:e=>{t.on("afterSubmit",async(...a)=>await(e==null?void 0:e(...a)))},beforeDel:e=>{t.on("beforeDel",async(...a)=>await(e==null?void 0:e(...a)))},afterDel:e=>{t.on("afterDel",async(...a)=>await(e==null?void 0:e(...a)))},beforeBatchDel:e=>{t.on("beforeBatchDel",async(...a)=>await(e==null?void 0:e(...a)))},afterBatchDel:e=>{t.on("afterBatchDel",async(...a)=>await(e==null?void 0:e(...a)))},beforeSearch:e=>{t.on("beforeSearch",async()=>await(e==null?void 0:e()))},afterSearch:e=>{t.on("afterSearch",async()=>await(e==null?void 0:e()))},beforeSearchReset:e=>{t.on("beforeSearch",async()=>await(e==null?void 0:e()))},afterSearchReset:e=>{t.on("afterSearch",async()=>await(e==null?void 0:e()))},beforeOpen:e=>{t.on("beforeOpen",async(...a)=>await(e==null?void 0:e(...a)))},afterOpen:e=>{t.on("afterOpen",async(...a)=>await(e==null?void 0:e(...a)))},beforeClose:e=>{t.on("beforeClose",async(...a)=>await(e==null?void 0:e(...a)))},afterClose:e=>{t.on("afterClose",async(...a)=>await(e==null?void 0:e(...a)))}}}function Se(t){const r=X(),s=fe(t),o=Y(s),{emitter:l,beforeGetList:n,afterGetList:c,beforeSave:f,afterSave:O,beforeUpdate:C,afterUpdate:P,beforeSubmit:k,afterSubmit:F,beforeDel:U,afterDel:B,beforeBatchDel:K,afterBatchDel:v,beforeSearch:D,afterSearch:b,beforeSearchReset:G,afterSearchReset:d,beforeOpen:e,afterOpen:a,beforeClose:h,afterClose:i}=le(),{getDataList:m,handleSave:g,handleUpdate:y,handleDel:u,batchDel:p,searchChange:w,searchReset:x,selectionChange:E,pageSizeChange:$,pageCurrentChange:H,sortChange:R,beforeOpen:j,beforeClose:L}=ie({crudRef:r,crudState:s,emitter:l,options:t}),J=Z(()=>({ref:S=>r.value=S,modelValue:s.formData,tableLoading:s.tableLoading,option:t.tableOption??{},data:s.tableData,page:s.pageOption,search:s.searchForm,defaults:s.defaults,"before-open":j,"before-close":L,onRowSave:g,onRowUpdate:y,onRowDel:u,onRefreshChange:m,onSelectionChange:E,onCurrentChange:H,onSizeChange:$,onSortChange:R,onSearchChange:w,onSearchReset:x,"onUpdate:search":S=>s.searchForm=S,"onUpdate:page":S=>s.pageOption=S,"onUpdate:modelValue":S=>s.formData=S,"onUpdate:defaults":S=>s.defaults=S}));return{crudRef:r,crudState:s,crudStateRefs:o,bindVal:J,getDataList:m,handleSave:g,handleUpdate:y,handleDel:u,batchDel:p,beforeGetList:n,afterGetList:c,beforeSave:f,afterSave:O,beforeUpdate:C,afterUpdate:P,beforeSubmit:k,afterSubmit:F,beforeDel:U,afterDel:B,beforeBatchDel:K,afterBatchDel:v,beforeSearch:D,afterSearch:b,beforeSearchReset:G,afterSearchReset:d,beforeOpen:e,afterOpen:a,beforeClose:h,afterClose:i}}export{ne as m,Se as u};
