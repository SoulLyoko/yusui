import"./index.288677a1.js";import{u as Q}from"./index.386fc70b.js";import{o as W}from"./omit.b387bec1.js";import{o as X,a as $,s as Y}from"./snakeCase.f63bc639.js";import{z as Z,ab as _,h as ee,ac as ae,g as te}from"./framework.f01dabf7.js";import{m as re}from"./index.es.e5378d01.js";import{c as d}from"./cloneDeep.72f77c29.js";import{g as x}from"./get.c8715fa2.js";import{E as z,a as V}from"./index.22b43a78.js";import{o as q}from"./omitBy.d8a4eded.js";import{i as I}from"./index.b86440c3.js";function se(a){return{all:a=a||new Map,on:function(r,s){var o=a.get(r);o?o.push(s):a.set(r,[s])},off:function(r,s){var o=a.get(r);o&&(s?o.splice(o.indexOf(s)>>>0,1):a.set(r,[]))},emit:function(r,s){var o=a.get(r);o&&o.slice().map(function(n){n(s)}),(o=a.get("*"))&&o.slice().map(function(n){n(r,s)})}}}function oe(a){const r=se(a);return r.emitAsync=async function(s,o){const n=this.all.get(s);if(n)for(const i of n)await i(o);const c=this.all.get("*");if(c)for(const i of c)await i(s,o)},r}function ne(a){return new Promise(r=>setTimeout(r,a))}function ce(a,r){return a.then(s=>[null,s]).catch(s=>r?[Object.assign({},s,r),void 0]:[s,void 0])}const A=ce;function Ae(a,r){const{label:s="label",value:o="value"}=r||{};return Object.entries(a??{}).map(([n,c])=>({[s]:n,[o]:c})).filter(n=>Number.isNaN(Number(n[s])))}function ie({crudState:a}){if(a.mockCache)try{const i=`mock-${a.mockCache}`,f=localStorage.getItem(i);a.mockData=f?JSON.parse(f):a.mockData,Z(()=>a.mockData,()=>localStorage.setItem(i,JSON.stringify(a.mockData)),{immediate:!0,deep:!0})}catch(c){console.log(c)}function r(c){const{currKey:i,sizeKey:f}=a.crudOption,O=c[i],C=c[f],{descs:L,ascs:b}=c,K=W(c,[i,f,"descs","ascs"]),P=a.mockData.filter(v=>Object.entries(K).every(([D,U])=>typeof v[D]=="string"?v[D].includes(U):v[D]==U)),R=X(P,L||b||void 0,L?"desc":b?"asc":void 0).filter((v,D)=>D>=(O-1)*C&&D<O*C);return Promise.resolve({code:200,msg:"操作成功",data:{records:R,total:P.length}})}function s(c){const{crudOption:{rowKey:i}}=a;return a.mockData.push({[i]:Q(16,10),...c}),Promise.resolve({code:200,msg:"操作成功"})}function o(c){const{crudOption:{rowKey:i}}=a;return a.mockData=a.mockData.map(f=>f[i]===c[i]?c:f),Promise.resolve({code:200,msg:"操作成功"})}function n(c){const{crudOption:{rowKey:i}}=a;if(typeof c=="string"){const f=c.split(",");a.mockData=a.mockData.filter(O=>!f.some(C=>C==O[i]))}else a.mockData=a.mockData.filter(f=>c!=f[i]);return Promise.resolve({code:200,msg:"操作成功"})}return{getList:r,create:s,update:o,remove:n}}function fe(a){var i;const r=_(re({crudOption:{rowKey:((i=a==null?void 0:a.tableOption)==null?void 0:i.rowKey)??"id",getList:f=>s(f),create:f=>o(f),update:f=>n(f),remove:f=>c(f),dataPath:"res.data.records",totalPath:"res.data.total",currKey:"current",sizeKey:"size",isPage:!0,isSort:!0,delConfirm:!0,clearSelection:!0,saveSuccessMsg:"保存成功",updateSuccessMsg:"保存成功",delSuccessMsg:"删除成功"},pageOption:{total:0,currentPage:1,pageSize:10},sortOption:{},tableLoading:!1,tableOption:{},tableData:[],dataSelections:[],searchForm:{},queryForm:{},formData:{},formType:"",defaults:{},mockData:[],mockCache:""},a)),{getList:s,create:o,update:n,remove:c}=ie({crudState:r});return r}function le({crudRef:a,crudState:r,emitter:s,options:o}){const n=o.getDataList??(async()=>{var F,H;const{dataPath:e,totalPath:t,currKey:h,sizeKey:l,isPage:m,isSort:g,clearSelection:y}=r.crudOption,{currentPage:u,pageSize:p}=r.pageOption,w=m?{[h]:u,[l]:p}:{},N=g?r.sortOption:{},E=d({...r.searchForm,...w,...N,...r.queryForm}),[T]=await A(s.emitAsync("beforeGetList",E));if(T!==null)return;const{getList:j}=r.crudOption;if(j){r.tableLoading=!0,await ne(100);try{const k=await j(K(E));console.log("getDataList ~ res",k),r.tableData=x({res:k},e,[]),r.pageOption.total=x({res:k},t,0),await s.emitAsync("afterGetList",k)}catch(k){console.error("getDataList ~ err",k),r.tableData=[],r.pageOption.total=0}finally{y&&((H=(F=a==null?void 0:a.value)==null?void 0:F.selectClear)==null||H.call(F)),r.tableLoading=!1}}}),c=o.handleSave??(async(e,t,h)=>{const l=d({...r.formData,...e}),[m]=await A(s.emitAsync("beforeSave",l)),[g]=await A(s.emitAsync("beforeSubmit",l));if(m!==null||g!==null)return h==null?void 0:h();const{rowKey:y,create:u,saveSuccessMsg:p}=r.crudOption;if(!u)return h==null?void 0:h();delete l[y];try{const w=await u(b(l));return p&&z.success(p),await s.emitAsync("afterSave",w),await s.emitAsync("afterSubmit",w),t==null||t(),n()}catch(w){console.error("handleSave ~ err",w),h==null||h()}}),i=o.handleUpdate??(async(e,t,h,l)=>{const m=d({...r.formData,...e}),[g]=await A(s.emitAsync("beforeUpdate",m)),[y]=await A(s.emitAsync("beforeSubmit",m));if(g!==null||y!==null)return l==null?void 0:l();const{update:u,updateSuccessMsg:p}=r.crudOption;if(!u)return l==null?void 0:l();try{const w=await u(b(m));return p&&z.success(p),await s.emitAsync("afterUpdate",w),await s.emitAsync("afterSubmit",w),h==null||h(),n()}catch(w){console.error("handleUpdate ~ err",w),l==null||l()}}),f=o.handleDel??(async e=>{const t=d(e),[h]=await A(s.emitAsync("beforeDel",t));if(h!==null)return;const{rowKey:l,remove:m,delConfirm:g,delSuccessMsg:y}=r.crudOption;if(m){g&&await V.confirm("确认进行删除操作？","提示",{type:"warning"});try{const u=await m(t[l]);return y&&z.success(y),await s.emitAsync("afterDel",u),n()}catch(u){console.error("handleDel ~ err",u)}}}),O=o.batchDel??(async()=>{const e=d(r.dataSelections),[t]=await A(s.emitAsync("beforeBatchDel",e));if(t!==null)return;const{rowKey:h,remove:l,delConfirm:m,delSuccessMsg:g}=r.crudOption;if(!l)return;const y=e.length;if(!y)return z.warning("请选择删除项");m&&await V.confirm(`确认删除所选的${y}条数据？`,"提示",{type:"warning"});const u=e.map(p=>p[h]).join(",");try{const p=await l(u);return g&&z.success(g),await s.emitAsync("afterBatchDel",p),n()}catch(p){console.error("batchDel ~ err",p)}}),C=(e,t)=>t.includes("$"),L=e=>e==="",b=o.filterRow??(e=>q(e,$(I,C))),K=o.filterParams??(e=>q(e,$(I,L,C))),P=o.searchChange??(async(e,t)=>{r.pageOption.currentPage=1,Object.keys(r.searchForm).forEach(m=>{delete r.searchForm[m]}),Object.keys(e).forEach(m=>{r.searchForm[m]=e[m]});const[h]=await A(s.emitAsync("beforeSearch",r.searchForm));if(h!==null)return t==null?void 0:t();await n();const[l]=await A(s.emitAsync("afterSearch",r.searchForm));if(l!==null)return t==null?void 0:t();t==null||t()}),B=o.searchReset??(async()=>{Object.keys(r.searchForm).forEach(e=>{delete r.searchForm[e]}),await s.emitAsync("beforeSearchReset",r.searchForm),await n(),await s.emitAsync("afterSearchReset",r.searchForm)}),R=o.selectionChange??(e=>{r.dataSelections=e}),v=o.pageSizeChange??(e=>(r.pageOption.pageSize=e,n())),D=o.pageCurrentChange??(e=>(r.pageOption.currentPage=e,n())),U=o.sortChange??(({order:e,prop:t})=>(e&&t?r.sortOption={[e.replace("ending","s")]:Y(t)}:r.sortOption={},n())),M=o.beforeOpen??(async(e,t)=>{r.formType=t,await s.emitAsync("beforeOpen",t),e(),await s.emitAsync("afterOpen",t)}),G=o.beforeClose??(async(e,t)=>{r.formType=t,await s.emitAsync("beforeClose",t),e(),await s.emitAsync("afterClose",t)});return{getDataList:n,handleSave:c,handleUpdate:i,handleDel:f,batchDel:O,searchChange:P,searchReset:B,selectionChange:R,pageSizeChange:v,pageCurrentChange:D,sortChange:U,beforeOpen:M,beforeClose:G}}function he(){const a=oe();return{emitter:a,beforeGetList:e=>{a.on("beforeGetList",async(...t)=>await(e==null?void 0:e(...t)))},afterGetList:e=>{a.on("afterGetList",async(...t)=>await(e==null?void 0:e(...t)))},beforeSave:e=>{a.on("beforeSave",async(...t)=>await(e==null?void 0:e(...t)))},afterSave:e=>{a.on("afterSave",async(...t)=>await(e==null?void 0:e(...t)))},beforeUpdate:e=>{a.on("beforeUpdate",async(...t)=>await(e==null?void 0:e(...t)))},afterUpdate:e=>{a.on("afterUpdate",async(...t)=>await(e==null?void 0:e(...t)))},beforeSubmit:e=>{a.on("beforeSubmit",async(...t)=>await(e==null?void 0:e(...t)))},afterSubmit:e=>{a.on("afterSubmit",async(...t)=>await(e==null?void 0:e(...t)))},beforeDel:e=>{a.on("beforeDel",async(...t)=>await(e==null?void 0:e(...t)))},afterDel:e=>{a.on("afterDel",async(...t)=>await(e==null?void 0:e(...t)))},beforeBatchDel:e=>{a.on("beforeBatchDel",async(...t)=>await(e==null?void 0:e(...t)))},afterBatchDel:e=>{a.on("afterBatchDel",async(...t)=>await(e==null?void 0:e(...t)))},beforeSearch:e=>{a.on("beforeSearch",async()=>await(e==null?void 0:e()))},afterSearch:e=>{a.on("afterSearch",async()=>await(e==null?void 0:e()))},beforeSearchReset:e=>{a.on("beforeSearch",async()=>await(e==null?void 0:e()))},afterSearchReset:e=>{a.on("afterSearch",async()=>await(e==null?void 0:e()))},beforeOpen:e=>{a.on("beforeOpen",async(...t)=>await(e==null?void 0:e(...t)))},afterOpen:e=>{a.on("afterOpen",async(...t)=>await(e==null?void 0:e(...t)))},beforeClose:e=>{a.on("beforeClose",async(...t)=>await(e==null?void 0:e(...t)))},afterClose:e=>{a.on("afterClose",async(...t)=>await(e==null?void 0:e(...t)))}}}function be(a){const r=ee(),s=fe(a),o=ae(s),{emitter:n,beforeGetList:c,afterGetList:i,beforeSave:f,afterSave:O,beforeUpdate:C,afterUpdate:L,beforeSubmit:b,afterSubmit:K,beforeDel:P,afterDel:B,beforeBatchDel:R,afterBatchDel:v,beforeSearch:D,afterSearch:U,beforeSearchReset:M,afterSearchReset:G,beforeOpen:e,afterOpen:t,beforeClose:h,afterClose:l}=he(),{getDataList:m,handleSave:g,handleUpdate:y,handleDel:u,batchDel:p,searchChange:w,searchReset:N,selectionChange:E,pageSizeChange:T,pageCurrentChange:j,sortChange:F,beforeOpen:H,beforeClose:k}=le({crudRef:r,crudState:s,emitter:n,options:a}),J=te(()=>({ref:S=>r.value=S,modelValue:s.formData,tableLoading:s.tableLoading,option:a.tableOption??{},data:s.tableData,page:s.pageOption,search:s.searchForm,defaults:s.defaults,"before-open":H,"before-close":k,onRowSave:g,onRowUpdate:y,onRowDel:u,onRefreshChange:m,onSelectionChange:E,onCurrentChange:j,onSizeChange:T,onSortChange:F,onSearchChange:w,onSearchReset:N,"onUpdate:search":S=>s.searchForm=S,"onUpdate:page":S=>s.pageOption=S,"onUpdate:modelValue":S=>s.formData=S,"onUpdate:defaults":S=>s.defaults=S}));return{crudRef:r,crudState:s,crudStateRefs:o,bindVal:J,getDataList:m,handleSave:g,handleUpdate:y,handleDel:u,batchDel:p,beforeGetList:c,afterGetList:i,beforeSave:f,afterSave:O,beforeUpdate:C,afterUpdate:L,beforeSubmit:b,afterSubmit:K,beforeDel:P,afterDel:B,beforeBatchDel:R,afterBatchDel:v,beforeSearch:D,afterSearch:U,beforeSearchReset:M,afterSearchReset:G,beforeOpen:e,afterOpen:t,beforeClose:h,afterClose:l}}export{Ae as e,be as u};
