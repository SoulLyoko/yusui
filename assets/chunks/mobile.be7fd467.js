import{d as dt}from"./index.deecc6ab.js";import{E as ne,m as pt}from"./index.ce0b877c.js";import{g as A,h as O,A as Z,l as D,E as Te,$ as ft,S as De,Y as mt,d as W,J as P,c as M,L as oe,K as J,o as V,b as $,w as I,N as U,a as z,t as Y,B as re,a3 as Ue,k as te,n as vt,_ as Ve,z as me,C as ie,e as B,U as bt,O as Ye,R as gt,a9 as _t,D as yt,a7 as wt,a8 as ht,H as ve}from"./framework.c2983551.js";import{I as Ge}from"./iconify.4639d8e3.js";import{a as be,d as kt,e as Ct,w as We,f as Nt}from"./index.d990ce32.js";import{_ as Tt,a as Dt,d as Vt}from"./index.038acb2e.js";import"./index.ebd85431.js";import{j as It}from"./tree.82fe43ad.js";import{f as ke,t as Qe,a as xt}from"./vuedraggable.umd.482073e4.js";import{p as Lt}from"./index.vue_vue_type_script_setup_true_lang.c9440674.js";import{s as Ot,a as Fe,e as G,u as Rt}from"./index.b928f55e.js";import{d as Pt}from"./differenceBy.22dbfb8b.js";import{B as ue}from"./index.2fcafa0b.js";function Et(e){const{buttonHandler:t,request:a}=H(),{commitTask:i,revokeTask:l,saveDraft:p,startTask:n,terminateTask:s,transferTask:c,withdrawTask:u,rejectTask:w,greenChannel:r,circulateTask:b}=Pe(a),d=A(()=>{const{flowDetail:_,formVariables:h,approvalFormData:o,debug:f,fileIds:m}=e,{flowDeployId:y}=_.value.process??{},{taskId:g,flowInstanceId:N}=_.value.task??{};return{flowDeployId:y,taskId:g,flowInstanceId:N,variables:h.value,debug:f.value,fileIds:m==null?void 0:m.value,...o.value}}),v=()=>d.value.taskId&&d.value.flowInstanceId;return{flow_draft(){if(v())return p(d.value)},flow_pass(){return v()?i(d.value):n(d.value)},flow_revoke(){if(v())return l(d.value)},flow_withdraw(){if(v())return u(d.value)},flow_terminate(){if(v())return s(d.value)},flow_transfer(){if(v())return c(d.value)},flow_reject(){if(v())return w(d.value)},flow_green(){if(v())return r(d.value)},flow_circulate(){if(v()){const{approvalFormData:_,circulateId:h}=e;return b({id:h==null?void 0:h.value,comment:_==null?void 0:_.value.comment})}},...t==null?void 0:t(e)}}function St(e){const t=O({});return Z(async()=>{var i;const{formProperty:a}=((i=D(e))==null?void 0:i.properties)||{};a!=null&&a.length&&(await Te(),Object.keys(t.value).forEach(l=>{var s,c,u,w;const p=((s=t.value[l])==null?void 0:s.label)||"",n=a==null?void 0:a.find(r=>r.prop===l);if(t.value[l].display=n==null?void 0:n.display,t.value[l].disabled=n==null?void 0:n.disabled,t.value[l].detail=n==null?void 0:n.detail,t.value[l].readonly=n==null?void 0:n.readonly,t.value[l].rules=t.value[l].rules??[],n!=null&&n.required&&((c=t.value[l].rules)!=null&&c.some(r=>r.required)))return null;n!=null&&n.required?(u=t.value[l].rules)==null||u.push({required:!0,message:`${p}为必填项`}):t.value[l].rules=(w=t.value[l].rules)==null?void 0:w.filter(r=>!r.required)}))}),t}const At={modelValue:{type:Object,default:()=>({})},title:{type:String},flowDetail:{type:Object,default:()=>({})},formLoading:{type:Boolean},submitLoading:{type:Boolean},activeTab:{type:String,default:"formTab"},activeBtn:{type:Object,default:()=>({})},approvalVisible:{type:Boolean},approvalFormData:{type:Object,default:()=>({})},flowKey:{type:String},taskId:{type:String},instanceId:{type:String},formId:{type:String},fileIds:{type:String},permission:{type:Object},beforeClick:{type:Function},beforeSubmit:{type:Function},detail:{type:[Boolean,String],default:!1},debug:{type:[Boolean,String],default:!1},circulateId:{type:String}},Ut={complete:e=>e},He=Symbol("flowFormState");function $t(e,t){const a=be(e,void 0,{passive:!0,deep:!0}),{flowDetail:i,modelValue:l,formLoading:p,activeTab:n}=a,{tabs:s,customForm:c,request:u}=H(),w=O({}),r=A(()=>(s==null?void 0:s.filter(o=>{var m,y,g;const f=(g=(y=(m=i.value)==null?void 0:m.properties)==null?void 0:y.formProperty)==null?void 0:g.find(N=>N.prop===o.prop);return(f==null?void 0:f.display)!==!1}).map(o=>{var m,y;let f=o.component;if(o.prop==="formTab"){const g=c==null?void 0:c[((y=(m=i==null?void 0:i.value)==null?void 0:m.process)==null?void 0:y.formPath)??""];typeof g=="function"?f=mt(g):g&&(f=g)}return{...o,component:f}}))??[]),b=O();Q()&&kt(b,{onSwipeEnd(o,f){if(!["left","right"].includes(f))return;const m=r.value.findIndex(g=>g.prop===n.value),y=Ct(m+(f==="right"?-1:1),0,r.value.length-1);n.value=r.value[y].prop}});const{getFlowDetail:d}=Pe(u);Z(()=>{const{flowKey:o,taskId:f,instanceId:m}=e;!o&&!f&&!m||(p.value=!0,d({flowKey:o,taskId:f,flowInstanceId:m}).then(y=>{i.value=y.data,l.value=y.data.formData||{}}).finally(()=>{p.value=!1}))});const v=A(()=>Object.entries(l.value||{}).filter(([o])=>!o.startsWith("$")).map(([o,f])=>({key:o,value:f}))),_=A(()=>e.detail===!0||e.detail==="true"),h={...a,formData:l,formVariables:v,tabRefs:w,tabList:r,detail:_,tabsRef:b,emit:t};return ft(He,h),h}function ae(){return De(He)}const $e=W({__name:"button-list",emits:["click"],setup(e,{emit:t}){const{userInfo:a,request:i}=H(),{flowDetail:l,circulateId:p}=ae(),{data:n}=lt(i).useList();function s(u,w){return u.map(r=>{const b=w.find(v=>v.buttonKey===r.buttonKey);return{...r,...Lt(b,["display","approval"])}})}const c=A(()=>{var m,y,g,N,T,x;if(p!=null&&p.value){const R=(m=n.value)==null?void 0:m.find(C=>C.buttonKey==="flow_circulate");return R?[R]:[]}const u=typeof a=="function"?a():a,{assignee:w,status:r}=((y=l.value)==null?void 0:y.task)||{},{createUser:b,flowInstanceId:d,status:v}=((g=l.value)==null?void 0:g.flowInstance)||{},_={true:!0,false:!1,startUser:b==(u==null?void 0:u.userId),assignee:w==(u==null?void 0:u.userId),todo:r==fe.待办,done:r==fe.已办,notstarted:!d,started:!!d,finished:v===Ne.已办结,unfinished:v===Ne.未办结},h=((N=n.value)==null?void 0:N.filter(R=>R.buttonKey!=="flow_circulate"))??[],{button:o}=((T=l.value)==null?void 0:T.properties)||{};return((x=s(h,o??[]))==null?void 0:x.filter(R=>{var C,E;return(E=(C=R.display)==null?void 0:C.split(","))==null?void 0:E.every(k=>_[k])}))??[]});return(u,w)=>{const r=P("el-button");return V(!0),M(J,null,oe(c.value,b=>(V(),$(r,{key:b.buttonKey,type:b.buttonType,onClick:d=>t("click",b)},{default:I(()=>[U(D(Ge),{icon:b.icon},null,8,["icon"]),z(" "+Y(b.name),1)]),_:2},1032,["type","onClick"]))),128)}}}),jt=W({__name:"common-comments",props:{modelValue:{}},setup(e){const t=e,{modelValue:a}=be(t),{request:i}=H(),{batchUpdate:l,create:p,remove:n,useList:s}=La(i),c=O(!1),{activeBtn:u}=ae(),w=A(()=>{var y;return(y=u.value)==null?void 0:y.buttonKey}),{data:r,refresh:b}=s(w),d=A(()=>{var g,N,T;const y=a.value;if(y&&!((g=r.value)!=null&&g.some(x=>x.content===y))){const x=(((T=(N=r.value)==null?void 0:N[0])==null?void 0:T.sort)||1)-1;return[{content:y,sort:x},...r.value||[]]}return r.value});async function v(y){var g;await p({...y,type:(g=u.value)==null?void 0:g.buttonKey}),ne.success("添加成功"),b()}async function _(y){await n(y.id),ne.success("删除成功"),b()}async function h(y,g){let N=g.parent.data;N=N.map((T,x)=>({id:T.id,sort:x+1})),await l(N),ne.success("修改排序成功"),b(),c.value=!1}function o(){c.value=!0}const f=O();async function m(y){var g;a.value=y.content??"",await Te(),(g=f.value)==null||g.blur()}return(y,g)=>{const N=P("el-input"),T=P("el-text"),x=P("el-col"),R=P("el-button"),C=P("el-row"),E=P("el-tree"),k=P("el-popover");return V(),$(k,{visible:c.value,placement:"bottom",title:"常用意见",width:D(Q)()?"98%":"600px"},{reference:I(()=>[U(N,{ref_key:"inputRef",ref:f,modelValue:D(a),"onUpdate:modelValue":g[0]||(g[0]=L=>re(a)?a.value=L:null),type:"textarea",placeholder:"请输入意见",rows:"5",onFocus:g[1]||(g[1]=L=>c.value=!0),onBlur:g[2]||(g[2]=L=>c.value=!1)},null,8,["modelValue"])]),default:I(()=>[U(E,{data:d.value,"node-key":"content",draggable:"","allow-drop":(L,j,K)=>K!=="inner",props:{label:"content"},onNodeClick:m,onNodeDrop:h,onNodeDragStart:o},{default:I(({data:L})=>[U(C,{style:{width:"100%"}},{default:I(()=>[U(x,{span:22},{default:I(()=>[U(T,{truncated:"",title:L.content},{default:I(()=>[z(Y(L.content),1)]),_:2},1032,["title"])]),_:2},1024),U(x,{span:2},{default:I(()=>[L.id?(V(),$(R,{key:0,type:"danger",size:"small",icon:"el-icon-close",text:"",onClick:Ue(j=>_(L),["stop"])},null,8,["onClick"])):(V(),$(R,{key:1,type:"primary",size:"small",icon:"el-icon-plus",text:"",onClick:Ue(j=>v(L),["stop"])},null,8,["onClick"]))]),_:2},1024)]),_:2},1024)]),_:1},8,["data","allow-drop"])]),_:1},8,["visible","width"])}}}),Kt=W({__name:"approval-tree",props:{modelValue:{},data:{},autoCheck:{type:Boolean},mode:{}},setup(e){const t=e,{modelValue:a}=be(t),i=O(),l={class(r){return`node-${r.type}`}},p=A(()=>Qe(t.data??[],(r,b,d)=>{const v=Fe();return r.taskNodeKey=(d==null?void 0:d.taskNodeKey)??r.taskNodeKey,r.incoming=(d==null?void 0:d.incoming)??r.incoming,r.multiple=(d==null?void 0:d.multiple)??r.multiple,{...r,id:v,label:r.title,disabled:r.type!=="user"}})),n={element:"ep:flag",post:"ep:share",dept:"ep:share",user:"ep:user"};We(()=>[p.value,i.value],async()=>{if(!i.value||!p.value.length)return;if(t.autoCheck){const b=s(p.value);b&&w([b])}ke(p.value,b=>{var d;return!!((d=b.children)!=null&&d.length)}).map(async b=>{var v;await Ot(100);const d=(v=i.value)==null?void 0:v.getNode(b);d==null||d.expand()})},{immediate:!0,debounce:100});function s(r){var b;if(r.length===1)return(b=r[0].children)!=null&&b.length?s(r[0].children):r[0]}async function c(r,{checkedNodes:b}){var _;let d=b.filter(h=>h.type==="user");const v=d.some(h=>h.id===r.id);if(p.value.every(h=>!h.multiple)&&v)d=[r];else if(!r.multiple&&v){const f=((_=i.value)==null?void 0:_.getNode(r)).parent.data.children.filter(m=>m.id!==r.id);d=Pt(d,f,"id")}w(d)}function u(r){const b=a.value.filter(d=>d.id!==r.id);w(b)}function w(r){var b;a.value=r,(b=i.value)==null||b.setCheckedNodes(r)}return(r,b)=>{const d=P("el-tag"),v=P("Icon"),_=P("el-tree");return V(),M(J,null,[(V(!0),M(J,null,oe(D(a),h=>(V(),$(d,{key:h.id,type:"info",closable:"",onClose:o=>u(h)},{default:I(()=>[z(Y(h.title),1)]),_:2},1032,["onClose"]))),128)),U(_,{ref_key:"treeRef",ref:i,class:vt(["approval-tree",`mode-${r.mode}`]),data:p.value,props:l,"node-key":"id","check-on-click-node":"","show-checkbox":"",onCheck:c},{default:I(({data:h})=>[te("div",null,[U(v,{icon:n[h.type]||n.element,style:{display:"inline-block"}},null,8,["icon"]),te("span",null,Y(h.title),1)])]),_:1},8,["class","data"])],64)}}});const je=Ve(Kt,[["__scopeId","data-v-323231a5"]]),Mt={key:0},Ke=W({__name:"assignee-setter",props:{modelValue:{},tableData:{},placeholder:{}},emits:["update:modelValue"],setup(e,{emit:t}){const a=e,i=A({get(){return typeof a.modelValue=="string"?a.modelValue?a.modelValue.split(","):[]:a.modelValue},set(v){var _;t("update:modelValue",v.join(",")),(_=a.tableData)!=null&&_.row&&(a.tableData.row.idVal=ke(s.value,h=>v==null?void 0:v.includes(h.id)).map(h=>h[`${n.value}Id`]).join(","))}}),l=A({get(){return Array.isArray(a.modelValue)?a.modelValue.join(","):a.modelValue},set(v){t("update:modelValue",v)}}),p=O(!1),n=A(()=>{var v,_;return(_=(v=a.tableData)==null?void 0:v.row)==null?void 0:_.type}),s=O([]),c=O([]),{request:u}=H(),{getUserTree:w}=Ea(u),{getParam:r}=ge(u);me(n,v=>{["dept","post","user"].includes(v)?(p.value=!0,w(v==="user"?"":v).then(_=>{s.value=Qe(_.data,h=>({...h,label:h.title,value:h.id,disabled:v==="user"?h.type!=="user":!1}))}).finally(()=>p.value=!1)):n.value==="dynamic"&&(p.value=!0,r("flow.trends.user").then(_=>{c.value=_.data}).finally(()=>p.value=!1))},{immediate:!0});const b=O();function d(){i.value=ke(s.value,v=>v.type===n.value).map(v=>v.id)}return(v,_)=>{const h=P("ElTreeSelect"),o=P("el-button"),f=P("el-input");return["dept","post","user"].includes(n.value)?(V(),M("div",Mt,[U(h,{ref_key:"treeRef",ref:b,modelValue:i.value,"onUpdate:modelValue":_[0]||(_[0]=m=>i.value=m),"check-on-click-node":"","check-strictly":"",clearable:"","collapse-tags":"","collapse-tags-tooltip":"",data:s.value,filterable:"",loading:p.value,"max-collapse-tags":3,multiple:"",placeholder:"请选择","show-checkbox":"",style:{width:"75%"}},null,8,["modelValue","data","loading"]),U(o,{text:"",type:"primary",icon:"el-icon-check",style:{width:"20%"},onClick:d},{default:I(()=>[z(" 全选 ")]),_:1})])):n.value==="dynamic"?(V(),$(h,{key:1,modelValue:l.value,"onUpdate:modelValue":_[1]||(_[1]=m=>l.value=m),clearable:"",data:c.value,filterable:"",loading:p.value,placeholder:"请选择",style:{width:"100%"}},null,8,["modelValue","data","loading"])):n.value==="userTask"?(V(),$(D(Tt),{key:2,modelValue:l.value,"onUpdate:modelValue":_[2]||(_[2]=m=>l.value=m),"filter-type":"userTask",placeholder:"请选择"},null,8,["modelValue"])):(V(),$(f,{key:3,modelValue:l.value,"onUpdate:modelValue":_[3]||(_[3]=m=>l.value=m),clearable:"",placeholder:"请输入"},null,8,["modelValue"]))}}}),Bt={key:0,class:"flow-viewer"},zt={key:0,class:"flow-status-legend"},Yt=W({__name:"index",props:{modelValue:{},view:{type:Boolean},flowFormOption:{},flowHistory:{},showLegend:{type:Boolean}},emits:["update:modelValue","nodeClick"],setup(e,{emit:t}){const a=e,i=ie();Nt(i,()=>{var o;(o=i.value)==null||o.on("node:click",f=>t("nodeClick",f))});const l=A({get(){let o=Vt();return typeof a.modelValue=="string"&&a.modelValue?o=JSON.parse(a.modelValue):typeof a.modelValue=="object"&&Object.keys(a.modelValue)&&(o=a.modelValue),o},set(o){t("update:modelValue",JSON.stringify(o))}}),p=A(()=>{const{column:o=[],group:f=[]}=JSON.parse(a.flowFormOption||"{}");return[...o,...f.map(y=>y.column??[]).flat()]}),{FlowDesign:n,tabs:s,request:c}=H(),{data:u}=lt(c).useList(),w=A(()=>(s==null?void 0:s.map(o=>({...o,display:!0})))??[]),r=A(()=>{var o;return{formPropertyList:[...p.value,...w.value],buttonList:(o=u.value)==null?void 0:o.filter(f=>f.status===1),fieldsDic:p.value.map(f=>({label:f.label,value:`\${${f.prop}}`,desc:`\${${f.prop}}`})),flowButtonDisplayDic:G(Oe),flowButtonApprovalDic:G(Re)}}),b=O({}),d=O({});We(d,o=>{var f,m,y,g,N,T;o&&((y=(m=(f=o.assignee)==null?void 0:f.children)==null?void 0:m.column)!=null&&y[1]&&(o.assignee.children.column[1].component=Ke),(T=(N=(g=o.circulate)==null?void 0:g.children)==null?void 0:N.column)!=null&&T[1]&&(o.circulate.children.column[1].component=Ke))},{debounce:1});const{data:v}=ge(c).useParam("flow.task.status"),_=A(()=>{var o;return(o=a.flowHistory)==null?void 0:o.map(f=>{var y,g;const m=(g=(y=v.value)==null?void 0:y.find(N=>N.value===f.status))==null?void 0:g.style;return{id:f.taskNodeKey,style:m}})}),h=A(()=>{var o,f;return(f=(o=a.flowHistory)==null?void 0:o.filter(m=>m.taskNodeType==="userTask"))==null?void 0:f.map(m=>{var y;return{id:m.taskNodeKey,content:`<div>${m.assigneeName}</div>
        <div>${m.endTime??""}</div>
        <div>${((y=m.comment)==null?void 0:y.handleComment)??""}</div>`}})});return(o,f)=>o.view?(V(),M("div",Bt,[o.showLegend!==!1?(V(),M("div",zt,[(V(!0),M(J,null,oe(D(v),m=>{var y;return V(),M("div",{key:m.label,class:"legend-item"},[te("div",{class:"legend-color",style:bt({backgroundColor:(y=m.style)==null?void 0:y.fill})},null,4),te("span",null,Y(m.label),1)])}),128))])):B("",!0),U(D(n),{lf:i.value,"onUpdate:lf":f[0]||(f[0]=m=>i.value=m),"model-value":l.value,styles:_.value,tooltips:h.value,type:"viewer"},null,8,["lf","model-value","styles","tooltips"])])):(V(),$(D(n),{key:1,modelValue:l.value,"onUpdate:modelValue":f[1]||(f[1]=m=>l.value=m),formData:b.value,"onUpdate:formData":f[2]||(f[2]=m=>b.value=m),formDefaults:d.value,"onUpdate:formDefaults":f[3]||(f[3]=m=>d.value=m),"form-options":D(Dt),"data-options":r.value,"form-width":"30%"},null,8,["modelValue","formData","formDefaults","form-options","data-options"]))}});const Je=Ve(Yt,[["__scopeId","data-v-fc890812"]]),Gt=W({__name:"node-select",props:{modelValue:{}},setup(e){const t=e,{modelValue:a}=be(t),{flowDetail:i}=ae(),l=O(!1);function p({data:n}){n.type==="userTask"&&(l.value=!1,a.value=n.id)}return(n,s)=>{const c=P("el-button"),u=P("el-popover");return V(),$(u,{visible:l.value,"onUpdate:visible":s[0]||(s[0]=w=>l.value=w),placement:"bottom-start",width:"800px",trigger:"click"},{reference:I(()=>[U(c,null,{default:I(()=>[z(" 点击选择节点 ")]),_:1})]),default:I(()=>{var w,r;return[U(Je,{"model-value":(r=(w=D(i))==null?void 0:w.process)==null?void 0:r.flowData,view:"",style:{height:"600px"},onNodeClick:p},null,8,["model-value"])]}),_:1},8,["visible"])}}}),Wt=W({__name:"approval-form",emits:["submit"],setup(e,{emit:t}){const{request:a}=H(),{getApprovalNode:i}=Pe(a),{useParam:l}=ge(a),{formData:p,approvalFormData:n,activeBtn:s,approvalVisible:c,formVariables:u,flowDetail:w}=ae(),r=O([]),b=O([]),d=O([]),v=O([]),_=O(!1),h=O(!1),o=O(),f=O(),m={menuBtn:!1,labelWidth:"auto",column:[{label:"指定节点",prop:"jumpTaskNodeKey",span:24,rules:[{required:!0,message:"请选择指定节点"}]},{label:"审批人",prop:"assignee",span:24,rules:[{required:!0,validator:y}]},{label:"传阅人",prop:"circulate",span:24},{label:"意见",prop:"comment",span:24,rules:[{required:!0,message:"请填写意见"}]}]};function y(E,k,L){var S,q,Ae;const j=((S=r.value[0])==null?void 0:S.type)==="parallelGateway",K=(Ae=(q=r.value[0])==null?void 0:q.children)==null?void 0:Ae.every(ut=>xt([ut],it=>b.value.some(ct=>ct.id===it.id)));if(b.value.length){if(j&&!K)return L("请在每个节点选择审批人")}else return L("请选择审批人");return!0}const{data:g}=l("flow.default.comment"),{data:N}=l("flow.approval.autocheck");Z(async()=>{var k;if(!c.value||!o.value||!f.value)return;T();const{taskId:E}=((k=w.value)==null?void 0:k.task)||{};Te(()=>{o.value.resetFields(),n.value.comment=p.value.comment||(E?"":g.value)||"",f.value.jumpTaskNodeKey.display=x("specifyNode"),f.value.assignee.display=x("assignee"),f.value.circulate.display=x("circulate"),f.value.comment.display=x("comment")})}),Z(async()=>{var L,j;if(!c.value||!x("assignee")||x("specifyNode")&&!n.value.jumpTaskNodeKey)return;T();const{flowKey:E}=((L=w.value)==null?void 0:L.process)||{},{taskId:k}=((j=w.value)==null?void 0:j.task)||{};try{h.value=!0;const K=await i({flowKey:E,taskId:k,variables:u.value,buttonType:s.value.buttonKey,jumpTaskNodeKey:n.value.jumpTaskNodeKey});r.value=K.data.approvalNodeList,d.value=K.data.circulateNodeList}finally{h.value=!1}});function T(){r.value=[],b.value=[],d.value=[],v.value=[]}function x(E){var k,L;return(L=(k=s.value)==null?void 0:k.approval)==null?void 0:L.includes(E)}async function R(){await st(o),_.value=!0;const{data:E,outgoing:k}=C(b.value),{data:L}=C(v.value);n.value.assignee=E,n.value.outgoing=[...k],n.value.circulate=L,console.log("🚀 ~ file: approval-form.vue:133 ~ onConfirm ~ formData:",p),t("submit")}function C(E){const k={},L={},j=new Set;return E.forEach(K=>{const{taskNodeKey:S,incoming:q}=K;k[S]||(k[S]=new Set),K.userId&&k[S].add(K.userId),L[S]=[...k[S]].join(","),q&&j.add(q)}),{set:k,data:L,outgoing:j}}return(E,k)=>{const L=P("el-skeleton"),j=P("avue-form"),K=P("el-button");return V(),$(Ye(D(Q)()?"el-drawer":"el-dialog"),{modelValue:D(c),"onUpdate:modelValue":k[7]||(k[7]=S=>re(c)?c.value=S:null),class:"approlval-form-overlay",title:D(s).name,"append-to-body":"",width:"900px",size:"50%",direction:"btt"},{footer:I(()=>[U(K,{onClick:k[6]||(k[6]=S=>c.value=!1)},{default:I(()=>[z(" 取 消 ")]),_:1}),U(K,{type:"primary",onClick:R},{default:I(()=>[z(" 确 定 ")]),_:1})]),default:I(()=>[U(j,{ref_key:"formRef",ref:o,modelValue:D(n),"onUpdate:modelValue":k[4]||(k[4]=S=>re(n)?n.value=S:null),defaults:f.value,"onUpdate:defaults":k[5]||(k[5]=S=>f.value=S),class:"approlval-form",option:m,style:{padding:"0"}},{jumpTaskNodeKey:I(()=>[U(Gt,{modelValue:D(n).jumpTaskNodeKey,"onUpdate:modelValue":k[0]||(k[0]=S=>D(n).jumpTaskNodeKey=S)},null,8,["modelValue"])]),assignee:I(()=>[h.value?(V(),$(L,{key:0})):(V(),$(je,{key:"AssigneeTree",modelValue:b.value,"onUpdate:modelValue":k[1]||(k[1]=S=>b.value=S),data:r.value,"auto-check":D(N)==="true",mode:D(Q)()?"vertical":"horizontal"},null,8,["modelValue","data","auto-check","mode"]))]),circulate:I(()=>[h.value?(V(),$(L,{key:0})):(V(),$(je,{key:"CirculateTree",modelValue:v.value,"onUpdate:modelValue":k[2]||(k[2]=S=>v.value=S),data:d.value,mode:D(Q)()?"vertical":"horizontal"},null,8,["modelValue","data","mode"]))]),comment:I(()=>[U(jt,{modelValue:D(n).comment,"onUpdate:modelValue":k[3]||(k[3]=S=>D(n).comment=S)},null,8,["modelValue"])]),_:1},8,["modelValue","defaults"])]),_:1},8,["modelValue","title"])}}});const Qt={class:"flow-form__title"},Ft=W({__name:"index",props:At,emits:Ut,setup(e,{emit:t}){const i=$t(e,t),{ApprovalForm:l,tabsProps:p}=H(),n=l??Wt,{title:s,detail:c,flowDetail:u,tabRefs:w,tabList:r,activeTab:b,activeBtn:d,formLoading:v,approvalVisible:_,submitLoading:h,beforeClick:o,beforeSubmit:f,tabsRef:m}=i;async function y(T){var x,R;d.value=T;for(const C of Object.values(w.value))await((x=C==null?void 0:C.validate)==null?void 0:x.call(C));await((R=o==null?void 0:o.value)==null?void 0:R.call(o,T)),(T==null?void 0:T.approval)!=="false"?_.value=!0:N()}const g=Et(i);async function N(){var T;try{const{buttonKey:x}=d.value;h.value=!0,await((T=f==null?void 0:f.value)==null?void 0:T.call(f,d.value));const R=g[x];R?(await(R==null?void 0:R()),ne.success("操作成功"),_.value=!1,t("complete",d.value)):ne.error("无法找到相应的操作")}finally{h.value=!1}}return(T,x)=>{const R=P("el-skeleton"),C=P("el-main"),E=P("el-header"),k=P("el-tab-pane"),L=P("el-tabs"),j=P("el-footer"),K=P("el-container");return D(v)?(V(),$(C,{key:0},{default:I(()=>[U(R)]),_:1})):(V(),$(K,{key:1,class:"flow-form"},{default:I(()=>[U(E,{class:"flow-form__header",height:"auto"},{default:I(()=>{var S;return[te("div",Qt,Y(D(s)??((S=D(u).flowInstance)==null?void 0:S.title)),1),!D(c)&&!D(Q)()?(V(),$($e,{key:0,onClick:y})):B("",!0)]}),_:1}),U(C,{class:"flow-form__main"},{default:I(()=>[U(L,gt({ref_key:"tabsRef",ref:m,modelValue:D(b),"onUpdate:modelValue":x[0]||(x[0]=S=>re(b)?b.value=S:null)},D(p)),{default:I(()=>[(V(!0),M(J,null,oe(D(r),S=>(V(),$(k,{key:S.prop,label:S.label,name:S.prop,lazy:S.lazy,disabled:S.disabled,closable:S.closable},{default:I(()=>[(V(),$(Ye(S.component),{ref_for:!0,ref:q=>D(w)[S.prop]=q},null,512))]),_:2},1032,["label","name","lazy","disabled","closable"]))),128))]),_:1},16,["modelValue"])]),_:1}),!D(c)&&D(Q)()?(V(),$(j,{key:0,class:"flow-form__footer",height:"auto"},{default:I(()=>[U($e,{onClick:y})]),_:1})):B("",!0),U(D(n),{onSubmit:N})]),_:1}))}}});const Ht=W({setup(){const{flowDetail:e,formData:t,detail:a}=ae(),i=St(e.value),{proxy:l}=yt(),p=O({});Z(()=>{const{formOption:c}=e.value.process??{};p.value=It.bind(l)(c||'{"menuBtn":false}'),p.value.detail=!!a.value});const n=O();function s(){return st(n)}return{form:t,option:p,defaults:i,formRef:n,validate:s}},render(){return _t(P("avue-form"),{ref:"formRef",modelValue:this.form,defaults:this.defaults,option:this.option,class:this.option.class,"onUpdate:modelValue":e=>this.form=e,"onUpdate:defaults":e=>this.defaults=e})}}),Jt=W({__name:"upload-table",setup(e){const{flowDetail:t,fileIds:a,detail:i}=ae(),{upload:{action:l,headers:p,preview:n,download:s,props:c}={},request:u}=H(),w=typeof p=="function"?p():p,r=A(()=>{var N,T;return((T=(N=t.value)==null?void 0:N.task)==null?void 0:T.flowInstanceId)??Fe()}),b=[{label:"文件名",prop:"fileName"},{label:"文件类型",prop:"fileType"},{label:"文件大小",prop:"fileSize"},{label:"版本",prop:"version"},{label:"上传时间",prop:"createTime"}],d=b.filter(N=>N.prop==="fileName"),v={rowKey:"id",align:"center",index:!1,border:!0,stripe:!0,addBtn:!1,editBtn:!1,delBtn:!1,menuType:"menu",column:Q()?d:b},{bindVal:_,getDataList:h,handleDel:o,handleSave:f,afterGetList:m,crudStateRefs:{tableData:y}}=Rt({crudOption:{...Ra(u),saveSuccessMsg:"上传成功"},tableOption:v,queryForm:{isLatest:1,flowInstanceId:r.value}});m(()=>{a.value=y.value.map(N=>N.id).join(",")}),h();async function g(N,T){var j,K;const{fileName:x,fileType:R,fileSize:C,fileUrl:E,res:k}=c,L={fileName:ue({res:N},`${k}.${x}`),fileType:ue({res:N},`${k}.${R}`),fileSize:ue({res:N},`${k}.${C}`),fileUrl:ue({res:N},`${k}.${E}`),taskId:(K=(j=t.value)==null?void 0:j.task)==null?void 0:K.taskId,flowInstanceId:r.value,rootMark:(T==null?void 0:T.rootMark)||"",version:typeof(T==null?void 0:T.version)=="number"?T.version+1:1};await f(L,h,()=>{})}return(N,T)=>{const x=P("el-button"),R=P("el-upload"),C=P("el-dropdown-item"),E=P("avue-crud");return V(),$(E,wt(ht(D(_))),{"menu-left":I(()=>[D(i)?B("",!0):(V(),$(R,{key:0,action:D(l),headers:D(w),"show-file-list":!1,onSuccess:T[0]||(T[0]=k=>g(k))},{default:I(()=>[U(x,{type:"primary",icon:"el-icon-upload"},{default:I(()=>[z(" 点击上传 ")]),_:1})]),_:1},8,["action","headers"]))]),"menu-btn":I(({row:k,index:L})=>[U(C,{icon:"el-icon-view",onClick:j=>{var K;return(K=D(n))==null?void 0:K(k,D(y))}},{default:I(()=>[z(" 预览 ")]),_:2},1032,["onClick"]),U(C,{icon:"el-icon-download",onClick:j=>{var K;return(K=D(s))==null?void 0:K(k,D(y))}},{default:I(()=>[z(" 下载 ")]),_:2},1032,["onClick"]),D(i)?B("",!0):(V(),$(C,{key:0,icon:"el-icon-upload"},{default:I(()=>[U(R,{action:D(l),headers:D(w),"show-file-list":!1,onSuccess:j=>g(j,k)},{default:I(()=>[z(" 更新版本 ")]),_:2},1032,["action","headers","onSuccess"])]),_:2},1024)),D(i)?B("",!0):(V(),$(C,{key:1,icon:"el-icon-delete",onClick:j=>D(o)(k,L)},{default:I(()=>[z(" 删除 ")]),_:2},1032,["onClick"]))]),_:1},16)}}}),Xt={class:"flow-track"},Zt={key:0},qt={key:1},ea=W({__name:"flow-track",setup(e){const{flowDetail:t}=ae(),a=O(Q()?"timeline":"table"),i=[{label:"table",icon:"ep:grid"},{label:"graph",icon:"ep:picture"},{label:"timeline",icon:"ep:finished"}],l=A(()=>{var u,w,r;return((r=(w=(u=t.value)==null?void 0:u.flowHistory)==null?void 0:w.filter(b=>b.taskNodeType==="userTask"))==null?void 0:r.map(b=>({...b,duration:dt(b.duration)})))??[]}),p={addBtn:!1,menu:!1,border:!0,column:[{label:"节点名称",prop:"taskNodeName"},{label:"处理人",prop:"assigneeName"},{label:"接收时间",prop:"startTime"},{label:"处理时间",prop:"endTime"},{label:"办理时长",prop:"duration"},{label:"操作类型",prop:"type",dicUrl:"/sapier-flow/flow-param/getParam",dicQuery:{paramKey:"flow.handle.type"}},{label:"办理意见",prop:"comment",bind:"comment.handleComment"}]},{request:n}=H(),{data:s}=ge(n).useParam("flow.handle.type");function c(u){var w;return(w=s.value)==null?void 0:w.find(r=>r.value===u)}return(u,w)=>{var f,m,y;const r=P("el-radio-button"),b=P("el-radio-group"),d=P("avue-crud"),v=P("el-card"),_=P("el-timeline-item"),h=P("el-timeline"),o=P("el-empty");return V(),M(J,null,[D(Q)?B("",!0):(V(),$(b,{key:0,modelValue:a.value,"onUpdate:modelValue":w[0]||(w[0]=g=>a.value=g)},{default:I(()=>[(V(),M(J,null,oe(i,g=>U(r,{key:g.label,label:g.label},{default:I(()=>[U(D(Ge),{icon:g.icon},null,8,["icon"])]),_:2},1032,["label"])),64))]),_:1},8,["modelValue"])),te("div",Xt,[a.value==="table"?(V(),$(d,{key:0,data:l.value,option:p},null,8,["data"])):B("",!0),a.value==="graph"?(V(),$(Je,{key:1,"model-value":(m=(f=D(t))==null?void 0:f.process)==null?void 0:m.flowData,"flow-history":(y=D(t))==null?void 0:y.flowHistory,view:"","show-legend":""},null,8,["model-value","flow-history"])):B("",!0),a.value==="timeline"?(V(),M(J,{key:2},[l.value.length?(V(),$(h,{key:0},{default:I(()=>[(V(!0),M(J,null,oe([...l.value].reverse(),g=>(V(),$(_,{key:g.id,timestamp:g.endTime,placement:"top"},{default:I(()=>[U(v,null,{default:I(()=>{var N,T,x;return[te("div",null,Y(g.assigneeName)+" 开始处理 ["+Y(g.taskNodeName)+"] 环节 ",1),g.duration?(V(),M("div",Zt," 办理时长："+Y(g.duration),1)):B("",!0),g.type&&((N=g.comment)!=null&&N.handleComment)?(V(),M("div",qt,Y((T=c(g.type))==null?void 0:T.label)+"意见："+Y((x=g.comment)==null?void 0:x.handleComment),1)):B("",!0)]}),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})):(V(),$(o,{key:1}))],64)):B("",!0)])],64)}}});const ta=Ve(ea,[["__scopeId","data-v-cd461541"]]),Me=Symbol("flowPagesConfig"),aa={FlowDesign:{},FormDesign:{},FlowForm:Ft,tabs:[{label:"审批表单",prop:"formTab",component:Ht},{label:"附件资料",prop:"fileTab",component:Jt},{label:"流程跟踪",prop:"trackTab",component:ta}],request:()=>{},useFlowFormOptions:{type:"drawer",window:["","flow-form","left=0,top=0,width=1600,height=900"],overlay:{width:"80%",size:"80%",top:"100px",fullscreen:!0,destroyOnClose:!0}},upload:{props:{fileName:"fileOriginalName",fileType:"fileType",fileSize:"fileSize",fileUrl:"fileUrl",res:"res.data"}}},oa={},la=Symbol("GLOBAL_OPTIONS_PROVIDE_KEY"),na=()=>oa,X=e=>e,Ce=e=>Array.isArray(e),Ie=e=>e!==null&&typeof e=="object",xe=e=>e instanceof Function,se=e=>e==null,Le=typeof window>"u",Xe=()=>{var e;return Le||se((e=window.document)===null||e===void 0?void 0:e.visibilityState)?!0:window.document.visibilityState==="visible"},ra=()=>{var e,t;return(e=!Le&&((t=window.navigator)===null||t===void 0?void 0:t.onLine))!==null&&e!==void 0?e:!0},_e=()=>new Promise(()=>{}),F=e=>re(e)?e.value:e,sa=e=>Ie(e)?Object.assign(Ce(e)?[]:{},e):e,ce=new Map,ua=e=>se(e)?void 0:ce.get(e),ia=(e,t,a)=>{const i=ce.get(e);i!=null&&i.timer&&clearTimeout(i.timer);const l=setTimeout(()=>ce.delete(e),t);ce.set(e,{...a,timer:l})};function Ze(e,t,a){let i,l,p,n,s,c,u=0,w=!1,r=!1,b=!0;const d=!t&&t!==0&&typeof window.requestAnimationFrame=="function";if(typeof e!="function")throw new TypeError("Expected a function");t=+t||0,Ie(a)&&(w=!!a.leading,r="maxWait"in a,p=r?Math.max(+a.maxWait||0,t):p,b="trailing"in a?!!a.trailing:b);function v(C){const E=i,k=l;return i=l=void 0,u=C,n=e.apply(k,E),n}function _(C,E){return d?(window.cancelAnimationFrame(s),window.requestAnimationFrame(C)):setTimeout(C,E)}function h(C){if(d)return window.cancelAnimationFrame(C);clearTimeout(C)}function o(C){return u=C,s=_(y,t),w?v(C):n}function f(C){const E=C-c,k=C-u,L=t-E;return r?Math.min(L,p-k):L}function m(C){const E=C-c,k=C-u;return c===void 0||E>=t||E<0||r&&k>=p}function y(){const C=Date.now();if(m(C))return g(C);s=_(y,f(C))}function g(C){return s=void 0,b&&i?v(C):(i=l=void 0,n)}function N(){s!==void 0&&h(s),u=0,i=c=l=s=void 0}function T(){return s===void 0?n:g(Date.now())}function x(){return s!==void 0}function R(){const C=Date.now(),E=m(C);for(var k=arguments.length,L=new Array(k),j=0;j<k;j++)L[j]=arguments[j];if(i=L,l=this,c=C,E){if(s===void 0)return o(c);if(r)return s=_(y,t),v(c)}return s===void 0&&(s=_(y,t)),n}return R.cancel=N,R.flush=T,R.pending=x,R}function ca(e,t,a){let i=!0,l=!0;if(typeof e!="function")throw new TypeError("Expected a function");return Ie(a)&&(i="leading"in a?!!a.leading:i,l="trailing"in a?!!a.trailing:l),Ze(e,t,{leading:i,trailing:l,maxWait:t})}var da=X((e,t)=>{let{debounceInterval:a,debounceOptions:i,manual:l}=t;const p=O(!1),n=O(),s=A(()=>i),c=A(()=>F(a)),u=O(e.context.runAsync);return l||(p.value=!0),Z(w=>{se(c.value)||(n.value=Ze(r=>r(),c.value,s.value),e.context.runAsync=function(){for(var r=arguments.length,b=new Array(r),d=0;d<r;d++)b[d]=arguments[d];return new Promise((v,_)=>{p.value?(p.value=!1,u.value(...b).then(v).catch(_)):n.value(()=>{u.value(...b).then(v).catch(_)})})},w(()=>{var r;(r=n.value)===null||r===void 0||r.cancel(),e.context.runAsync=u.value}))}),{onCancel(){var w;(w=n.value)===null||w===void 0||w.cancel()}}}),pa=X((e,t)=>{let{errorRetryCount:a=0,errorRetryInterval:i=0}=t;const l=O(),p=O(0),n=A(()=>F(a)),s=A(()=>F(i));let c=!1;const u=()=>{p.value=0},w=A(()=>{if(s.value)return s.value;const d=1e3,v=1,_=9,h=Math.floor(Math.random()*2**Math.min(p.value,_)+v);return d*h}),r=()=>{let d;const v=n.value===-1,_=p.value<n.value;return(v||_)&&(v||(p.value+=1),d=setTimeout(()=>{c=!0,e.context.refresh()},w.value)),()=>d&&clearTimeout(d)},b=()=>{l.value&&l.value()};return{onBefore(){c||u(),c=!1,b()},onSuccess(){u()},onError(){l.value=r()},onCancel(){u(),b()}}}),fa=X((e,t)=>{let{ready:a=O(!0),manual:i,defaultParams:l=[]}=t;return me(a,p=>{!i&&p&&e.context.run(...l)},{flush:"sync"}),{onBefore(){if(!(xe(a)?a():a.value))return e.loading.value=!1,{isBreak:!0}}}}),ma=X((e,t)=>{let{refreshDeps:a,refreshDepsAction:i,manual:l}=t;if(a===void 0||Ce(a)&&a.length===0)return{};const p=Ce(a)?a:[a];return me(p,()=>{i?i():!l&&e.context.refresh()}),{}}),va=X((e,t)=>{let{throttleInterval:a,throttleOptions:i}=t;const l=O(),p=A(()=>F(a)),n=A(()=>i),s=O(e.context.runAsync);return Z(c=>{if(se(a))return{};l.value=ca(u=>u(),p.value,n.value),e.context.runAsync=function(){for(var u=arguments.length,w=new Array(u),r=0;r<u;r++)w[r]=arguments[r];return new Promise((b,d)=>{l.value(()=>{s.value(...w).then(b).catch(d)})})},c(()=>{var u;(u=l.value)===null||u===void 0||u.cancel(),e.context.runAsync=s.value})}),{onCancel(){var c;(c=l.value)===null||c===void 0||c.cancel()}}});const ba=(e,t)=>a=>{Object.keys(a).forEach(i=>{e[i].value=a[i]}),t.forEach(i=>i(e))},ga=(e,t)=>()=>{let a=t;for(let i=e.length;i-- >0;)a=e[i](a);return a()},_a=(e,t,a)=>{var i,l;const{initialData:p,onSuccess:n,onError:s,onBefore:c,onAfter:u}=t,w=O((i=a==null?void 0:a.loading)!==null&&i!==void 0?i:!1),r=ie((l=a==null?void 0:a.data)!==null&&l!==void 0?l:p),b=ie(a==null?void 0:a.error),d=O(a==null?void 0:a.params),v=O([]),_=ie("pending"),h={},o=ba({status:_,loading:w,data:r,error:b,params:d},[]),f=function(y){for(var g=arguments.length,N=new Array(g>1?g-1:0),T=1;T<g;T++)N[T-1]=arguments[T];if(y==="onQuery"){const x=v.value.map(R=>R.onQuery).filter(Boolean);return{servicePromise:ga(x,N[0])()}}else{const x=v.value.map(R=>{var C;return(C=R[y])===null||C===void 0?void 0:C.call(R,...N)});return Object.assign({},...x)}},m=O(0);return h.runAsync=async function(){for(var y=arguments.length,g=new Array(y),N=0;N<y;N++)g[N]=arguments[N];o({loading:!0,params:g,status:"pending"}),m.value+=1;const T=m.value,{isBreak:x,breakResult:R=_e()}=f("onBefore",g);if(x)return o({status:"settled"}),R;c==null||c(g);try{const C=()=>new Promise(L=>L(e(...d.value)));let{servicePromise:E}=f("onQuery",C);E||(E=C());const k=await E;return T!==m.value?_e():(o({data:k,loading:!1,error:void 0,status:"settled"}),f("onSuccess",k,g),n==null||n(k,g),T===m.value&&f("onAfter",g,k,void 0),u==null||u(g),k)}catch(C){if(T!==m.value)return _e();throw o({loading:!1,error:C,status:"settled"}),f("onError",C,g),s==null||s(C,g),T===m.value&&f("onAfter",g,void 0,C),u==null||u(g),C}},h.run=function(){h.runAsync(...arguments).catch(y=>{s||console.error(y)})},h.cancel=()=>{m.value+=1,o({loading:!1}),f("onCancel")},h.refresh=()=>{h.run(...d.value||[])},h.refreshAsync=()=>h.runAsync(...d.value||[]),h.mutate=y=>{const g=xe(y)?y(r.value):y,N=sa(g);o({data:N}),f("onMutate",N)},{status:_,loading:w,data:r,error:b,params:d,plugins:v,context:h}};function ya(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=arguments.length>2?arguments[2]:void 0;const i=De(la,{}),l={...na(),...i,...t},{manual:p=!1,defaultParams:n=[]}=l,s=_a(e,l);if(s.plugins.value=a.map(c=>c(s,l)),!p){const c=s.params.value||n;s.context.run(...c)}return ve(()=>{s.context.cancel()}),{loading:s.loading,data:s.data,error:s.error,params:s.params,cancel:s.context.cancel,refresh:s.context.refresh,refreshAsync:s.context.refreshAsync,mutate:s.context.mutate,run:s.context.run,runAsync:s.context.runAsync}}const de=new Map,wa=(e,t)=>{de.set(e,t),t.then(a=>(de.delete(e),a)).catch(()=>{de.delete(e)})},ha=e=>de.get(e),ee=new Map,ka=(e,t)=>{ee.has(e)&&ee.get(e).forEach(a=>a(t))},Ca=(e,t)=>(ee.has(e)?ee.get(e).push(t):ee.set(e,[t]),()=>{const a=ee.get(e).indexOf(t);ee.get(e).splice(a,1)});var Na=X((e,t)=>{let{cacheKey:a,cacheTime:i=6e5,staleTime:l=0,getCache:p,setCache:n}=t;if(!a)return{};const s=xe(a)?a:()=>a,c=O(()=>{});let u;const w=o=>p?p(o):ua(o),r=(o,f,m)=>{n?n(o,m):ia(o,f,m),ka(o,m.data)},b=o=>l===-1||o+l>new Date().getTime(),d=(o,f)=>Object.prototype.hasOwnProperty.call(o,f),v=o=>{const f=s(o);return Ca(f,m=>{e.data.value=m})},_=s(),h=w(_);return h&&d(h,"data")&&(e.data.value=h.data,e.params.value=h.params),_&&(c.value=v()),ve(()=>{c.value()}),{onBefore(o){const f=s(o),m=w(f);if(!m||!d(m,"data"))return{};if(b(m.time))return e.data.value=m.data,e.loading.value=!1,{isBreak:!0,breakResult:m.data};e.data.value=m.data},onQuery(o){const f=e.params.value,m=s(f);let y=ha(m);return y&&y!==u?()=>y:(y=o(),u=y,wa(m,y),()=>y)},onSuccess(o,f){const m=s(f);m&&(c.value(),r(m,i,{data:o,params:f,time:new Date().getTime()}),c.value=v(f))},onMutate(o){const f=s(e.params.value);f&&(c.value(),r(f,i,{data:o,params:e.params.value,time:new Date().getTime()}),c.value=v(e.params.value))}}});function Ta(e){let t,a;class i extends Promise{constructor(p){super(p),this.cancel=()=>{a(),clearTimeout(t)}}}return new i(l=>{a=l,t=setTimeout(a,e)})}function ye(){return new Date().getTime()}var Da=X((e,t)=>{let{loadingDelay:a=0,loadingKeep:i=0}=t;const l=O(()=>{}),p=A(()=>F(a)),n=A(()=>F(i));let s=0,c={};const u=()=>{let w;return p.value&&(w=setTimeout(()=>{e.status.value==="pending"&&(e.loading.value=!0)},p.value)),()=>w&&clearTimeout(w)};return{onBefore(){e.loading.value=!p.value,l.value(),l.value=u(),s=ye()},onQuery(w){if(!n.value)return()=>w();c=Ta(n.value+p.value);const r=async()=>{try{const d=await w();return ye()-s<=p.value&&c.cancel(),Promise.resolve(d)}catch(d){return ye()-s<=p.value&&c.cancel(),Promise.reject(d)}},b=Promise.allSettled([r(),c]).then(d=>{const v=d[0];return v.status==="fulfilled"?v.value:Promise.reject(v.reason)});return()=>b},onCancel(){l.value()},onAfter(){l.value()}}}),we;const qe=new Set,et=new Set,tt=new Set,pe=(e,t)=>{let a;switch(e){case"FOCUS_LISTENER":a=qe;break;case"RECONNECT_LISTENER":a=tt;break;case"VISIBLE_LISTENER":a=et;break}if(!a.has(t))return a.add(t),()=>{a.delete(t)}},he=e=>{e.forEach(t=>{t()})};!Le&&(we=window)!==null&&we!==void 0&&we.addEventListener&&(window.addEventListener("visibilitychange",()=>{Xe()&&he(et)},!1),window.addEventListener("focus",()=>he(qe),!1),window.addEventListener("online",()=>he(tt),!1));var Va=X((e,t)=>{let{pollingInterval:a,pollingWhenHidden:i=!1,pollingWhenOffline:l=!1,errorRetryCount:p=0}=t;const n=O(),s=O(!1),c=A(()=>F(a)),u=A(()=>F(p)),w=[],r=_=>{_&&w.push(_)},b=()=>(i||Xe())&&(l||ra()),d=_=>{if(e.error.value&&u.value!==0)return;let h;if(!se(c.value)&&c.value>=0)if(b())h=setTimeout(_,c.value);else{s.value=!0;return}return()=>h&&clearTimeout(h)},v=()=>{s.value&&b()&&(e.context.refresh(),s.value=!1)};return me(c,()=>{n.value&&(n.value(),n.value=d(()=>e.context.refresh()))}),i||r(pe("VISIBLE_LISTENER",v)),l||r(pe("RECONNECT_LISTENER",v)),ve(()=>{w.forEach(_=>_())}),{onBefore(){var _;(_=n.value)===null||_===void 0||_.call(n)},onCancel(){var _;(_=n.value)===null||_===void 0||_.call(n)},onAfter(){n.value=d(()=>e.context.refresh())}}});const Ia=(e,t)=>{let a=!1;return function(){a||(a=!0,e(...arguments),setTimeout(()=>{a=!1},t))}};var xa=X((e,t)=>{let{refreshOnWindowFocus:a=!1,refocusTimespan:i=5e3}=t;const l=A(()=>F(a)),p=A(()=>F(i)),n=[],s=u=>{u&&n.push(u)},c=()=>{n.forEach(u=>u())};return Z(()=>{if(c(),l.value){const u=Ia(e.context.refresh,p.value);s(pe("VISIBLE_LISTENER",u)),s(pe("FOCUS_LISTENER",u))}}),ve(()=>{c()}),{}});function le(e,t){return ya(e,t,[Da,pa,da,Va,va,xa,ma,fa,Na])}function La(e){const t={list:"/sapier-flow/flow-user-common/list",save:"/sapier-flow/flow-user-common/save",update:"/sapier-flow/flow-user-common/update",remove:"/sapier-flow/flow-user-common/remove",batchUpdate:"/sapier-flow/flow-user-common/batchUpdate"},a=c=>e.get(t.list,{params:{type:c,ascs:"sort"}});return{url:t,getList:a,useList:c=>le(()=>a(c.value).then(u=>u.data.records),{refreshDeps:[c]}),create:c=>e.post(t.save,c),update:c=>e.post(t.update,c),remove:c=>e.post(t.remove,{},{params:{ids:c}}),batchUpdate:c=>e.post(t.batchUpdate,c)}}var at=(e=>(e.默认="default",e.主要="primary",e.成功="success",e.警告="warning",e.危险="danger",e.信息="info",e.文字="text",e))(at||{}),Oa=(e=>(e.保存草稿="flow_draft",e.发送="flow_pass",e.退回="flow_reject",e.终止="flow_terminate",e.撤销="flow_revoke",e.撤回到发起="flow_withdraw",e.打印="flow_print",e.转办="flow_transfer",e.加签="flow_add_instance",e.减签="flow_del_instance",e.指定回退="flow_rollback",e.绿色通道="flow_green",e.传阅="flow_circulate",e))(Oa||{}),Oe=(e=>(e.显示="true",e.隐藏="false",e.发起人="startUser",e.处理人="assignee",e.已办="done",e.待办="todo",e.未发起="notstarted",e.已发起="started",e.未办结="unfinished",e.已办结="finished",e))(Oe||{}),Re=(e=>(e.不显示="false",e.指定节点="specifyNode",e.审批人="assignee",e.传阅人="circulate",e.意见="comment",e))(Re||{}),ot=(e=>(e[e.禁用=0]="禁用",e[e.正常=1]="正常",e))(ot||{});function lt(e){const t={list:"/sapier-flow/dev-button/list",save:"/sapier-flow/dev-button/save",update:"/sapier-flow/dev-button/update",remove:"/sapier-flow/dev-button/remove"},a=s=>e.get(t.list,{params:s});return{url:t,getList:a,useList:()=>le(()=>a({size:-1,ascs:"sort"}).then(s=>s.data.records)),create:s=>e.post(t.save,s),update:s=>e.post(t.update,s),remove:s=>e.post(t.remove,{},{params:{ids:s}})}}function Ra(e){const t={list:"/sapier-flow/flow-file/list",save:"/sapier-flow/flow-file/save",remove:"/sapier-flow/flow-file/remove"};return{getList:p=>e.get(t.list,{params:p}),create:p=>e.post(t.save,p),remove:p=>e.post(t.remove,{},{params:{ids:p}})}}function ge(e){const t={list:"/sapier-flow/flow-param/list",save:"/sapier-flow/flow-param/save",update:"/sapier-flow/flow-param/update",remove:"/sapier-flow/flow-param/remove",all:"/sapier-flow/flow-param/getAllParam",key:"/sapier-flow/flow-param/getParam"},a=u=>e.get(t.list,{params:u}),i=()=>e.get(t.all),l=u=>e.get(t.key,{params:{paramKey:u}});return{url:t,getList:a,getAllParam:i,getParam:l,useParam:u=>le(()=>l(u).then(w=>w.data)),create:u=>e.post(t.save,u),update:u=>e.post(t.update,u),remove:u=>e.post(t.remove,{},{params:{ids:u}})}}var fe=(e=>(e[e.已办=1]="已办",e[e.待办=2]="待办",e[e.失败=3]="失败",e[e.撤销=4]="撤销",e[e.终止=5]="终止",e))(fe||{}),Ne=(e=>(e[e.已办结=1]="已办结",e[e.未办结=2]="未办结",e[e.已终止=3]="已终止",e))(Ne||{}),Pa=(e=>(e[e.系统执行=1]="系统执行",e[e.用户办理=2]="用户办理",e[e.任务撤销=3]="任务撤销",e[e.任务退回=4]="任务退回",e[e.流程终止=5]="流程终止",e[e.任务转办=6]="任务转办",e[e.绿色通道=7]="绿色通道",e))(Pa||{});function Pe(e){const t={publishList:"/sapier-flow/flow-run/queryPublishFlowList",taskList:"/sapier-flow/flow-run/userTaskList",detail:"/sapier-flow/flow-run/queryPublishFlowDetail",approvalNode:"/sapier-flow/flow-run/queryApprovalNode",start:"/sapier-flow/flow-run/startProcess",commit:"/sapier-flow/flow-run/commitTask",draft:"/sapier-flow/flow-run/saveDraft",revoke:"/sapier-flow/flow-run/revokeTask",terminate:"/sapier-flow/flow-run/terminateFlow",withdraw:"/sapier-flow/flow-run/withdrawToStart",transfer:"/sapier-flow/flow-run/transferTask",reject:"/sapier-flow/flow-run/rollbackTask",green:"/sapier-flow/flow-run/greenTask",circulate:"/sapier-flow/flow-circulate/commitTask"},a=o=>e.get(t.detail,{params:o}),i=o=>e.post(t.approvalNode,o),l=o=>e.post(t.start,o),p=o=>e.post(t.commit,o),n=o=>e.post(t.draft,o),s=o=>e.post(t.revoke,o),c=o=>e.post(t.terminate,o),u=o=>e.post(t.withdraw,o),w=o=>e.post(t.transfer,o),r=o=>e.post(t.reject,o),b=o=>e.post(t.circulate,o),d=o=>e.post(t.green,o),v=()=>e.get(t.publishList);return{url:t,getFlowDetail:a,getApprovalNode:i,startTask:l,commitTask:p,saveDraft:n,revokeTask:s,terminateTask:c,withdrawTask:u,transferTask:w,rejectTask:r,greenChannel:d,circulateTask:b,getPublishList:v,usePublishList:()=>le(()=>v().then(o=>o.data)),getTaskList:o=>e.get(t.taskList,{params:o})}}function Ea(e){const t={tree:"/sapier-flow/flow-user/tree"},a=l=>e.get(t.tree,{params:{filter:l}});return{url:t,getUserTree:a,useUserTree:()=>le(()=>a().then(l=>l.data))}}var Ee=(e=>(e.ASSIGN_ID="ASSIGN_ID",e.ASSIGN_UUID="ASSIGN_UUID",e.AUTO="AUTO",e.INPUT="INPUT",e.NONE="NONE",e))(Ee||{}),Se=(e=>(e.bigint="bigint",e.blob="blob",e.char="char",e.date="date",e.datetime="datetime",e.decimal="decimal",e.double="double",e.enum="enum",e.float="float",e.int="int",e.longblob="longblob",e.longtext="longtext",e.mediumblob="mediumblob",e.mediumint="mediumint",e.mediumtext="mediumtext",e.set="set",e.smallint="smallint",e.text="text",e.time="time",e.timestamp="timestamp",e.tinyblob="tinyblob",e.tinyint="tinyint",e.tinytext="tinytext",e.varbinary="varbinary",e.varchar="varchar",e.year="year",e))(Se||{});function Ja(e){const t={list:"/sapier-flow/dev-table/list",save:"/sapier-flow/dev-table/save",update:"/sapier-flow/dev-table/update",remove:"/sapier-flow/dev-table/remove",deploy:"/sapier-flow/dev-table/deploy",getFields:"/sapier-flow/dev-table/getTableFields"},a=u=>e.get(t.list,{params:u});return{url:t,getList:a,useList:()=>le(()=>a({size:-1}).then(u=>u.data.records)),create:u=>e.post(t.save,u),update:u=>e.post(t.update,u),remove:u=>e.post(t.remove,{},{params:{ids:u}}),deploy:u=>e.post(t.deploy,u),getFields:u=>e.get(t.getFields,{params:u})}}var nt=(e=>(e[e.否=0]="否",e[e.是=1]="是",e))(nt||{});const Be=G(nt),Xa=G(Se),Za=G(Ee);function H(e,t){return e&&t?(e.provide(Me,pt(aa,t)),t):De(Me)}const qa={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:6,labelWidth:150,span:24,column:[{label:"按钮名称",prop:"name",search:!0},{label:"按钮标识",prop:"buttonKey",search:!0},{label:"按钮图标",prop:"icon",component:"icon-select"},{label:"按钮类型",prop:"buttonType",type:"select",dicData:G(at)},{label:"默认显示条件",prop:"display",type:"select",multiple:!0,dataType:"string",value:"false",dicData:G(Oe),tip:"选择多个时,所有条件都满足才显示",labelTip:`显示: 始终显示;<br/>隐藏: 始终隐藏;<br/>
      发起人: 用户为发起人时显示;<br/>处理人: 用户为处理人时显示;<br/>
      已办: 任务状态为已办时显示;<br/>待办: 任务状态为待办时显示;<br/>
      未发起: 流程未发起时显示;<br/>已发起: 流程已发起时显示;<br/>
      未办结: 流程未办结时显示;<br/>已办结: 流程已办结时显示;`},{label:"默认审批窗口显示",prop:"approval",type:"select",multiple:!0,dataType:"string",value:"false",dicData:G(Re),labelTip:`不显示: 不显示审批窗口;<br/>指定节点: 显示指定节点选择框(常用于绿色通道等);<br/>
      审批人: 显示审批人选择框;<br/>传阅人: 显示传阅人选择框;<br/>意见: 显示意见输入框;`},{label:"排序",prop:"sort",type:"number",value:0},{label:"状态",prop:"status",type:"switch",value:1,dicData:G(ot)},{label:"按钮预览",prop:"buttonPreview",width:150}]},rt={menuBtn:!1,span:24,column:[{label:"流程名称",prop:"flowName",rules:[{required:!0,message:"请输入流程名称"}]},{label:"流程标识",prop:"flowKey",editDisabled:!0,rules:[{required:!0,message:"请输入流程标识"}]},{label:"流程分类",prop:"categoryId",type:"select",dicUrl:"/sapier-flow/flow-category/list",dicQuery:{size:-1},props:{label:"name",value:"id"}},{label:"流程图标",prop:"flowIcon",component:"icon-select"},{label:"流程描述",prop:"remarks"},{label:"自定义表单",prop:"formPath"},{label:"关联表",prop:"formDataTable",type:"select",filterable:!0,allowCreate:!0,defaultFirstOption:!0,dicUrl:"/sapier-flow/dev-table/list",dicQuery:{size:-1},props:{label:"tableComment",value:"tableName",desc:"tableName",res:"data.records"}},{label:"表单设计",prop:"formOption",display:!1,hide:!0},{label:"模型设计",prop:"flowData",display:!1,hide:!0}]},eo={rowKey:"flowModuleId",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:6,tabs:!0,dialogFullscreen:!0,addBtn:!1,editBtn:!1,delBtn:!1,menuWidth:100,menuType:"menu",menuBtnTitle:"操作",column:[...rt.column.map((e,t)=>({...e,search:t<2})),{label:"流程主版本",prop:"mainVersion",formatter(e,t){return t?`V${t||""}`:""}}]},to={rowKey:"flowDeloyId",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:6,tabs:!0,dialogFullscreen:!0,addBtn:!1,editBtn:!1,delBtn:!1,menuWidth:100,menuType:"menu",menuBtnTitle:"操作",column:[...rt.column,{label:"流程版本",prop:"version",formatter(e,t){return t?`V${t||""}`:""}},{label:"是否主版本",prop:"mainVersion",type:"select",dicData:[{label:"否",value:0},{label:"是",value:1}]}]},Sa=[{label:"流程名称",prop:"flowName"},{label:"流程标识",prop:"flowKey"},{label:"流程分类",prop:"categoryId",type:"select",search:!0,dicUrl:"/sapier-flow/flow-category/list",props:{label:"name",value:"id"}},{label:"标题",prop:"processTitle",search:!0},{label:"流水号",prop:"serialNumber"},{label:"当前节点",prop:"taskNodeName"},{label:"审批人",prop:"assigneeName"},{label:"申请人",prop:"applyUserName"},{label:"接收时间",prop:"startTime"},{label:"任务状态",prop:"status",type:"select",search:!0,searchValue:fe.待办,dicUrl:"/sapier-flow/flow-param/getParam",dicQuery:{paramKey:"flow.task.status"}}].map(e=>({...e,display:!1})),Aa=[{label:"审批人",prop:"assignee"},{label:"节点名称",prop:"taskNodeName"},{label:"接收时间",prop:"startTime",type:"datetime",format:"YYYY-MM-DD HH:mm:ss",valueFormat:"YYYY-MM-DD HH:mm:ss"},{label:"结束时间",prop:"endTime",type:"datetime",format:"YYYY-MM-DD HH:mm:ss",valueFormat:"YYYY-MM-DD HH:mm:ss"},{label:"耗时",prop:"duration"},{label:"传阅意见",prop:"comment"}].map(e=>({...e,hide:!0})),ao={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:6,menu:!0,addBtn:!1,column:[...Sa,...Aa]};const ze=[{label:"字段名称",prop:"name"},{label:"字段备注",prop:"comment"},{label:"字段类型",prop:"type",type:"select",filterable:!0,allowCreate:!0,defaultFirstOption:!0,dicData:G(Se)},{label:"字段长度",prop:"size",type:"number"},{label:"小数位",prop:"point",type:"number"},{label:"默认值",prop:"default"},{label:"是否主键",prop:"primary",type:"switch",dicData:Be,value:0},{label:"是否允许为空",prop:"permitNull",type:"switch",dicData:Be,value:1}],oo={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:6,span:24,dialogFullscreen:!0,column:[{label:"表名",prop:"tableName",search:!0},{label:"表注释",prop:"tableComment",search:!0},{label:"表引擎",prop:"tableEngine"},{label:"表主键策略",prop:"tablePrimary",type:"select",filterable:!0,allowCreate:!0,defaultFirstOption:!0,dicData:G(Ee)},{label:"数据库字段",prop:"editFields",hide:!0,type:"dynamic",children:{column:ze}},{label:"默认字段",prop:"defaultFields",hide:!0,type:"dynamic",children:{addBtn:!1,delBtn:!1,column:ze}}]};function st(e){return new Promise((t,a)=>{D(e).validate((l,p,n)=>{l?(p(),t(n)):a(n)})})}function Q(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}export{Se as A,Me as B,aa as C,Xa as D,Za as E,Je as F,Wt as G,Pa as H,$e as I,ta as J,Ht as K,Jt as L,Et as M,At as N,Ut as O,He as P,$t as Q,Q as R,fe as T,nt as W,Ft as _,St as a,st as b,le as c,H as d,lt as e,eo as f,to as g,Ja as h,rt as i,ao as j,ge as k,Pe as l,oo as m,La as n,at as o,Oa as p,Oe as q,Re as r,ot as s,qa as t,ae as u,Ra as v,Be as w,Ne as x,Ea as y,Ee as z};
