import{K as I,h as J,q as Q,O as W,ah as X,a as Y}from"./framework.1859beb2.js";import"./index.b942cce0.js";import{u as Z}from"./index.386fc70b.js";import{o as _}from"./omit.c30a42ae.js";import{o as ee,a as E,s as ae}from"./snakeCase.6b706051.js";import{m as te}from"./merge.388a8cf7.js";import{t as v,s as re}from"./index.0246ace1.js";import{c as M}from"./cloneDeep.0df5a121.js";import{g as N}from"./get.45bf40f8.js";import{o as T}from"./omitBy.5165ced3.js";import{i as V}from"./isNil.c75b1b34.js";function se(t){return{all:t=t||new Map,on:function(r,s){var o=t.get(r);o?o.push(s):t.set(r,[s])},off:function(r,s){var o=t.get(r);o&&(s?o.splice(o.indexOf(s)>>>0,1):t.set(r,[]))},emit:function(r,s){var o=t.get(r);o&&o.slice().map(function(c){c(s)}),(o=t.get("*"))&&o.slice().map(function(c){c(r,s)})}}}function oe(t){const r=se(t);return r.emitAsync=async function(s,o){const c=this.all.get(s);if(c)for(const l of c)await l(o);const f=this.all.get("*");if(f)for(const l of f)await l(s,o)},r}function ne({crudState:t}){if(t.mockCache)try{const l=`mock-${t.mockCache}`,h=localStorage.getItem(l);t.mockData=h?JSON.parse(h):t.mockData,I(()=>t.mockData,()=>localStorage.setItem(l,JSON.stringify(t.mockData)),{immediate:!0,deep:!0})}catch(f){console.log(f)}function r(f){const{currKey:l,sizeKey:h}=t.crudOption,A=f[l],P=f[h],{descs:U,ascs:b}=f,F=_(f,[l,h,"descs","ascs"]),R=t.mockData.filter(k=>Object.entries(F).every(([O,B])=>typeof k[O]=="string"?k[O].includes(B):k[O]===B)),z=ee(R,U||b||void 0,U?"desc":b?"asc":void 0).filter((k,O)=>O>=(A-1)*P&&O<A*P);return Promise.resolve({code:200,msg:"操作成功",data:{records:z,total:R.length}})}function s(f){const{crudOption:{rowKey:l}}=t;return t.mockData.push({[l]:Z(16,10),...f}),Promise.resolve({code:200,msg:"操作成功"})}function o(f){const{crudOption:{rowKey:l}}=t;return t.mockData=t.mockData.map(h=>h[l]===f[l]?f:h),Promise.resolve({code:200,msg:"操作成功"})}function c(f){const{crudOption:{rowKey:l}}=t;if(typeof f=="string"){const h=f.split(",");t.mockData=t.mockData.filter(A=>!h.includes(A[l]))}else t.mockData=t.mockData.filter(h=>f!==h[l]);return Promise.resolve({code:200,msg:"操作成功"})}return{getList:r,create:s,update:o,remove:c}}function ce(t){var l;const r=J(te({crudOption:{rowKey:((l=t==null?void 0:t.tableOption)==null?void 0:l.rowKey)??"id",getList:h=>s(h),create:h=>o(h),update:h=>c(h),remove:h=>f(h),dataPath:"res.data.records",totalPath:"res.data.total",currKey:"current",sizeKey:"size",isPage:!0,isSort:!0,delConfirm:!0,clearSelection:!0,saveSuccessMsg:"保存成功",updateSuccessMsg:"保存成功",delSuccessMsg:"删除成功"},pageOption:{total:0,currentPage:1,pageSize:10},sortOption:{},tableLoading:!1,tableOption:{},tableData:[],dataSelections:[],searchForm:{},queryForm:{},formData:{},formType:"",defaults:{},mockData:[],mockCache:""},t)),{getList:s,create:o,update:c,remove:f}=ne({crudState:r});return r}function fe({crudRef:t,crudState:r,emitter:s,options:o}){const{proxy:c}=Q()??{},f=o.getDataList??(async()=>{var $,j;const{dataPath:a,totalPath:n,currKey:m,sizeKey:i,isPage:u,isSort:C,clearSelection:w}=r.crudOption,{currentPage:D,pageSize:g}=r.pageOption,p=u?{[m]:D,[i]:g}:{},y=C?r.sortOption:{},S=M({...r.searchForm,...p,...y,...r.queryForm}),[q]=await v(s.emitAsync("beforeGetList",S));if(q!==null)return;const{getList:H}=r.crudOption;if(H){r.tableLoading=!0,await re(100);try{const K=await H(R(S));console.log("getDataList ~ res",K),r.tableData=N({res:K},a,[]),r.pageOption.total=N({res:K},n,0),await s.emitAsync("afterGetList",K)}catch(K){console.error("getDataList ~ err",K),r.tableData=[],r.pageOption.total=0}finally{w&&((j=($=t==null?void 0:t.value)==null?void 0:$.selectClear)==null||j.call($)),r.tableLoading=!1}}}),l=o.handleSave??(async(a,n,m)=>{var p;const i=M({...r.formData,...a}),[u]=await v(s.emitAsync("beforeSave",i)),[C]=await v(s.emitAsync("beforeSubmit",i));if(u!==null||C!==null)return m==null?void 0:m();const{rowKey:w,create:D,saveSuccessMsg:g}=r.crudOption;if(!D)return m==null?void 0:m();delete i[w];try{const y=await D(F(i));return g&&((p=c==null?void 0:c.$message)==null||p.success(g)),await s.emitAsync("afterSave",y),await s.emitAsync("afterSubmit",y),n==null||n(),f()}catch(y){console.error("handleSave ~ err",y),m==null||m()}}),h=o.handleUpdate??(async(a,n,m,i)=>{var p;const u=M({...r.formData,...a}),[C]=await v(s.emitAsync("beforeUpdate",u)),[w]=await v(s.emitAsync("beforeSubmit",u));if(C!==null||w!==null)return i==null?void 0:i();const{update:D,updateSuccessMsg:g}=r.crudOption;if(!D)return i==null?void 0:i();try{const y=await D(F(u));return g&&((p=c==null?void 0:c.$message)==null||p.success(g)),await s.emitAsync("afterUpdate",y),await s.emitAsync("afterSubmit",y),m==null||m(),f()}catch(y){console.error("handleUpdate ~ err",y),i==null||i()}}),A=o.handleDel??(async a=>{var D,g;const n=M(a),[m]=await v(s.emitAsync("beforeDel",n));if(m!==null)return;const{rowKey:i,remove:u,delConfirm:C,delSuccessMsg:w}=r.crudOption;if(u){C&&await((D=c==null?void 0:c.$messageBox)==null?void 0:D.confirm("确认进行删除操作？","提示",{type:"warning"}));try{const p=await u(n[i]);return w&&((g=c==null?void 0:c.$message)==null||g.success(w)),await s.emitAsync("afterDel",p),f()}catch(p){console.error("handleDel ~ err",p)}}}),P=o.batchDel??(async()=>{var g,p,y;const a=M(r.dataSelections),[n]=await v(s.emitAsync("beforeBatchDel",a));if(n!==null)return;const{rowKey:m,remove:i,delConfirm:u,delSuccessMsg:C}=r.crudOption;if(!i)return;const w=a.length;if(!w)return(g=c==null?void 0:c.$message)==null?void 0:g.warning("请选择删除项");u&&await((p=c==null?void 0:c.$messageBox)==null?void 0:p.confirm(`确认删除所选的${w}条数据？`,"提示",{type:"warning"}));const D=a.map(S=>S[m]).join(",");try{const S=await i(D);return C&&((y=c==null?void 0:c.$message)==null||y.success(C)),await s.emitAsync("afterBatchDel",S),f()}catch(S){console.error("batchDel ~ err",S)}}),U=(a,n)=>n.includes("$"),b=a=>a==="",F=o.filterRow??(a=>T(a,E(V,U))),R=o.filterParams??(a=>T(a,E(V,b,U))),G=o.searchChange??(async(a,n)=>{r.pageOption.currentPage=1,Object.keys(r.searchForm).forEach(u=>{delete r.searchForm[u]}),Object.keys(a).forEach(u=>{r.searchForm[u]=a[u]});const[m]=await v(s.emitAsync("beforeSearch",r.searchForm));if(m!==null)return n==null?void 0:n();await f();const[i]=await v(s.emitAsync("afterSearch",r.searchForm));if(i!==null)return n==null?void 0:n();n==null||n()}),z=o.searchReset??(async()=>{Object.keys(r.searchForm).forEach(a=>{delete r.searchForm[a]}),await s.emitAsync("beforeSearchReset",r.searchForm),await f(),await s.emitAsync("afterSearchReset",r.searchForm)}),k=o.selectionChange??(a=>{r.dataSelections=a}),O=o.pageSizeChange??(a=>(r.pageOption.pageSize=a,f())),B=o.pageCurrentChange??(a=>(r.pageOption.currentPage=a,f())),d=o.sortChange??(({order:a,prop:n})=>(a&&n?r.sortOption={[a.replace("ending","s")]:ae(n)}:r.sortOption={},f())),x=o.beforeOpen??(async(a,n)=>{r.formType=n,await s.emitAsync("beforeOpen",n),a(),await s.emitAsync("afterOpen",n)}),e=o.beforeClose??(async(a,n)=>{r.formType=n,await s.emitAsync("beforeClose",n),a(),await s.emitAsync("afterClose",n)});return{getDataList:f,handleSave:l,handleUpdate:h,handleDel:A,batchDel:P,searchChange:G,searchReset:z,selectionChange:k,pageSizeChange:O,pageCurrentChange:B,sortChange:d,beforeOpen:x,beforeClose:e}}function ie(){const t=oe();return{emitter:t,beforeGetList:e=>{t.on("beforeGetList",async(...a)=>await(e==null?void 0:e(...a)))},afterGetList:e=>{t.on("afterGetList",async(...a)=>await(e==null?void 0:e(...a)))},beforeSave:e=>{t.on("beforeSave",async(...a)=>await(e==null?void 0:e(...a)))},afterSave:e=>{t.on("afterSave",async(...a)=>await(e==null?void 0:e(...a)))},beforeUpdate:e=>{t.on("beforeUpdate",async(...a)=>await(e==null?void 0:e(...a)))},afterUpdate:e=>{t.on("afterUpdate",async(...a)=>await(e==null?void 0:e(...a)))},beforeSubmit:e=>{t.on("beforeSubmit",async(...a)=>await(e==null?void 0:e(...a)))},afterSubmit:e=>{t.on("afterSubmit",async(...a)=>await(e==null?void 0:e(...a)))},beforeDel:e=>{t.on("beforeDel",async(...a)=>await(e==null?void 0:e(...a)))},afterDel:e=>{t.on("afterDel",async(...a)=>await(e==null?void 0:e(...a)))},beforeBatchDel:e=>{t.on("beforeBatchDel",async(...a)=>await(e==null?void 0:e(...a)))},afterBatchDel:e=>{t.on("afterBatchDel",async(...a)=>await(e==null?void 0:e(...a)))},beforeSearch:e=>{t.on("beforeSearch",async()=>await(e==null?void 0:e()))},afterSearch:e=>{t.on("afterSearch",async()=>await(e==null?void 0:e()))},beforeSearchReset:e=>{t.on("beforeSearch",async()=>await(e==null?void 0:e()))},afterSearchReset:e=>{t.on("afterSearch",async()=>await(e==null?void 0:e()))},beforeOpen:e=>{t.on("beforeOpen",async(...a)=>await(e==null?void 0:e(...a)))},afterOpen:e=>{t.on("afterOpen",async(...a)=>await(e==null?void 0:e(...a)))},beforeClose:e=>{t.on("beforeClose",async(...a)=>await(e==null?void 0:e(...a)))},afterClose:e=>{t.on("afterClose",async(...a)=>await(e==null?void 0:e(...a)))}}}function Se(t){const r=W(),s=ce(t),o=X(s),{emitter:c,beforeGetList:f,afterGetList:l,beforeSave:h,afterSave:A,beforeUpdate:P,afterUpdate:U,beforeSubmit:b,afterSubmit:F,beforeDel:R,afterDel:G,beforeBatchDel:z,afterBatchDel:k,beforeSearch:O,afterSearch:B,beforeSearchReset:d,afterSearchReset:x,beforeOpen:e,afterOpen:a,beforeClose:n,afterClose:m}=ie(),{getDataList:i,handleSave:u,handleUpdate:C,handleDel:w,batchDel:D,searchChange:g,searchReset:p,selectionChange:y,pageSizeChange:S,pageCurrentChange:q,sortChange:H,beforeOpen:$,beforeClose:j}=fe({crudRef:r,crudState:s,emitter:c,options:t}),K=Y(()=>({ref:L=>r.value=L,modelValue:s.formData,tableLoading:s.tableLoading,option:t.tableOption??{},data:s.tableData,page:s.pageOption,search:s.searchForm,defaults:s.defaults,"before-open":$,"before-close":j,onRowSave:u,onRowUpdate:C,onRowDel:w,onRefreshChange:i,onSelectionChange:y,onCurrentChange:q,onSizeChange:S,onSortChange:H,onSearchChange:g,onSearchReset:p,"onUpdate:search":L=>s.searchForm=L,"onUpdate:page":L=>s.pageOption=L,"onUpdate:modelValue":L=>s.formData=L,"onUpdate:defaults":L=>s.defaults=L}));return{crudRef:r,crudState:s,crudStateRefs:o,bindVal:K,getDataList:i,handleSave:u,handleUpdate:C,handleDel:w,batchDel:D,beforeGetList:f,afterGetList:l,beforeSave:h,afterSave:A,beforeUpdate:P,afterUpdate:U,beforeSubmit:b,afterSubmit:F,beforeDel:R,afterDel:G,beforeBatchDel:z,afterBatchDel:k,beforeSearch:O,afterSearch:B,beforeSearchReset:d,afterSearchReset:x,beforeOpen:e,afterOpen:a,beforeClose:n,afterClose:m}}export{oe as m,Se as u};
