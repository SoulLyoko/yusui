import{aq as dt,aQ as ae,aR as le,aS as q,aT as me,aU as pt}from"../composables_use-crud_index.md.0a124321.js";import{r as ft}from"./axios.c2f1d4a8.js";import{R as mt,y as ve,r as $,s as ce,c as M,b as Y,w as se,ac as j,f as A,D as V,h as D,A as S,B as v,G as h,k as U,t as z,u as g,ao as te,ap as oe,n as Z,S as vt,ai as _t,d as bt,z as J,C as B,i as F,L as ee,F as G,W as yt,_ as De,j as wt,l as gt,aI as Ee,a1 as Pe}from"./framework.ed7c4bc5.js";import{d as ue,x as ht}from"./theme.d963afc4.js";import{a5 as Ue,a7 as kt,a8 as Vt,a9 as xt,A as Ct,_ as Dt,a4 as $t}from"./index.vue_vue_type_script_setup_true_lang.6a2c3d64.js";import{a as Ot,_ as Nt}from"./index.vue_vue_type_script_setup_true_lang.a83b70b4.js";import{d as Tt}from"./data.4cb21f02.js";import{a as It}from"../flow-design_flow-modeler_index.md.2aa89884.js";import"../app.52e8ac55.js";import"../components_basic-container_index.md.2178b4aa.js";import"../components_icon-select_index.md.f07c8664.js";import"../components_index.md.fe52aca6.js";import"../components_v-text_index.md.5d28416e.js";import"../composables_index.md.8a6c0350.js";import"../flow-design_flow-viewer_index.md.31d4bbd1.js";import"../flow-design_index.md.5682e532.js";import"../flow-pages_flow-button_index.md.828e2b85.js";import"../flow-pages_flow-manage_index.md.1a8a0004.js";import"../flow-pages_flow-ops_index.md.f7003a39.js";import"../flow-pages_flow-param_index.md.a6f50752.js";import"../flow-pages_flow-template_index.md.0733e48e.js";import"../flow-pages_form-template_index.md.ce88b549.js";import"../flow-pages_index.md.1d3109f8.js";import"../flow-pages_table-template_index.md.89a96335.js";import"../flow-pages_workbench_index.md.d2e23754.js";import"../form-design_demo.md.00216990.js";import"../form-design_index.md.5b804000.js";import"../guide_changelog.md.5345fd84.js";import"../guide_start.md.2368c574.js";import"../index.md.ef0c3fbf.js";import"../plugins_avue-patch_index.md.1f413369.js";import"../plugins_env-dts_index.md.931f387d.js";import"../plugins_index.md.6b7b0f63.js";import"../plugins_load-proxy_index.md.7d1c25b9.js";import"../plugins_uni-ui-patch_index.md.6983f4e7.js";import"../plugins_uview-patch_index.md.1126a7cc.js";import"../types_avue_index.md.da777289.js";import"../utils_date_dateFormat.md.5cd5d9c6.js";import"../utils_date_durationFormat.md.b53cab9d.js";import"../utils_emitter_mittAsync.md.8b1edcbf.js";import"../utils_index.md.11924d61.js";import"../utils_math_index.md.6c0fdecf.js";import"../utils_object_filterObj.md.3d9cb1ce.js";import"../utils_object_filterObjDeep.md.5e211cdc.js";import"../utils_object_getDataType.md.e0d5bba5.js";import"../utils_string_deserialize.md.0fedc08a.js";import"../utils_string_serialize.md.59c39a15.js";import"../utils_string_uuid.md.e3615756.js";import"../utils_tool_awaitTo.md.3fc38388.js";import"../utils_tool_enumToDic.md.39956ff3.js";import"../utils_tool_sleep.md.96532c58.js";import"../utils_tree_buildTree.md.a465a66e.js";import"../utils_tree_filterTree.md.77b66616.js";import"../utils_tree_findTree.md.8a777391.js";import"../utils_tree_flatTree.md.80e26ea6.js";import"../utils_tree_treeMap.md.61c31513.js";import"./vue.runtime.esm-bundler.66d03a4b.js";var Lt=ft();const St=dt(Lt),Rt={},Et=Symbol("GLOBAL_OPTIONS_PROVIDE_KEY"),Pt=()=>Rt,Ut=e=>Array.isArray(e),$e=e=>e!==null&&typeof e=="object",Me=e=>e instanceof Function,ie=e=>e==null,Oe=typeof window>"u",Ke=()=>{var e;return Oe||ie((e=window.document)===null||e===void 0?void 0:e.visibilityState)?!0:window.document.visibilityState==="visible"},Mt=()=>{var e,t;return(e=!Oe&&((t=window.navigator)===null||t===void 0?void 0:t.onLine))!==null&&e!==void 0?e:!0},he=()=>new Promise(()=>{}),H=e=>j(e)?e.value:e,Kt=e=>$e(e)?Object.assign(Ut(e)?[]:{},e):e,de=new Map,Ft=e=>ie(e)?void 0:de.get(e),Bt=(e,t,o)=>{const n=de.get(e);n!=null&&n.timer&&clearTimeout(n.timer);const r=setTimeout(()=>de.delete(e),t);de.set(e,{...o,timer:r})},X=e=>e;function Fe(e,t,o){let n,r,u,s,l,c,i=0,_=!1,f=!1,w=!0;const k=!t&&t!==0&&typeof window.requestAnimationFrame=="function";if(typeof e!="function")throw new TypeError("Expected a function");t=+t||0,$e(o)&&(_=!!o.leading,f="maxWait"in o,u=f?Math.max(+o.maxWait||0,t):u,w="trailing"in o?!!o.trailing:w);function a(N){const E=n,T=r;return n=r=void 0,i=N,s=e.apply(T,E),s}function m(N,E){return k?(window.cancelAnimationFrame(l),window.requestAnimationFrame(N)):setTimeout(N,E)}function d(N){if(k)return window.cancelAnimationFrame(N);clearTimeout(N)}function b(N){return i=N,l=m(y,t),_?a(N):s}function p(N){const E=N-c,T=N-i,W=t-E;return f?Math.min(W,u-T):W}function x(N){const E=N-c,T=N-i;return c===void 0||E>=t||E<0||f&&T>=u}function y(){const N=Date.now();if(x(N))return C(N);l=m(y,p(N))}function C(N){return l=void 0,w&&n?a(N):(n=r=void 0,s)}function O(){l!==void 0&&d(l),i=0,n=c=r=l=void 0}function R(){return l===void 0?s:C(Date.now())}function L(){return l!==void 0}function P(...N){const E=Date.now(),T=x(E);if(n=N,r=this,c=E,T){if(l===void 0)return b(c);if(f)return l=m(y,t),a(c)}return l===void 0&&(l=m(y,t)),s}return P.cancel=O,P.flush=R,P.pending=L,P}function At(e,t,o){let n=!0,r=!0;if(typeof e!="function")throw new TypeError("Expected a function");return $e(o)&&(n="leading"in o?!!o.leading:n,r="trailing"in o?!!o.trailing:r),Fe(e,t,{leading:n,trailing:r,maxWait:t})}var jt=X((e,{debounceInterval:t,debounceOptions:o,manual:n})=>{const r=$(!1),u=$(),s=M(()=>o),l=M(()=>H(t)),c=$(e.context.runAsync);return n||(r.value=!0),Y(i=>{ie(l.value)||(u.value=Fe(_=>_(),l.value,s.value),e.context.runAsync=(..._)=>new Promise((f,w)=>{r.value?(r.value=!1,c.value(..._).then(f).catch(w)):u.value(()=>{c.value(..._).then(f).catch(w)})}),i(()=>{var _;(_=u.value)===null||_===void 0||_.cancel(),e.context.runAsync=c.value}))}),{onCancel(){var i;(i=u.value)===null||i===void 0||i.cancel()}}}),zt=X((e,{errorRetryCount:t=0,errorRetryInterval:o=0})=>{const n=$(),r=$(0),u=M(()=>H(t)),s=M(()=>H(o));let l=!1;const c=()=>{r.value=0},i=M(()=>{if(s.value)return s.value;const w=1e3,k=1,a=9,m=Math.floor(Math.random()*2**Math.min(r.value,a)+k);return w*m}),_=()=>{let w;const k=u.value===-1,a=r.value<u.value;return(k||a)&&(k||(r.value+=1),w=setTimeout(()=>{l=!0,e.context.refresh()},i.value)),()=>w&&clearTimeout(w)},f=()=>{n.value&&n.value()};return{onBefore(){l||c(),l=!1,f()},onSuccess(){c()},onError(){n.value=_()},onCancel(){c(),f()}}}),Wt=X((e,{ready:t=$(!0),manual:o,defaultParams:n=[]})=>(se(t,r=>{!o&&r&&e.context.run(...n)},{flush:"sync"}),{onBefore(){if(!t.value)return e.loading.value=!1,{isBreak:!0}}})),Qt=X((e,{refreshDeps:t=[],refreshDepsAction:o,manual:n})=>(t!=null&&t.length&&se(t,()=>{o?o():!n&&e.context.refresh()}),{})),Gt=X((e,{throttleInterval:t,throttleOptions:o})=>{const n=$(),r=M(()=>H(t)),u=M(()=>o),s=$(e.context.runAsync);return Y(l=>{if(ie(t))return{};n.value=At(c=>c(),r.value,u.value),e.context.runAsync=(...c)=>new Promise((i,_)=>{n.value(()=>{s.value(...c).then(i).catch(_)})}),l(()=>{var c;(c=n.value)===null||c===void 0||c.cancel(),e.context.runAsync=s.value})}),{onCancel(){var l;(l=n.value)===null||l===void 0||l.cancel()}}});const Jt=(e,t)=>o=>{Object.keys(o).forEach(n=>{e[n].value=o[n]}),t.forEach(n=>n(e))},Ht=(e,t)=>()=>{let o=t;for(let n=e.length;n-- >0;)o=e[n](o);return o()},qt=(e,t,o)=>{var n,r;const{initialData:u,onSuccess:s,onError:l,onBefore:c,onAfter:i}=t,_=$((n=o==null?void 0:o.loading)!==null&&n!==void 0?n:!1),f=ce((r=o==null?void 0:o.data)!==null&&r!==void 0?r:u),w=ce(o==null?void 0:o.error),k=$(o==null?void 0:o.params),a=$([]),m=ce("pending"),d={},b=Jt({status:m,loading:_,data:f,error:w,params:k},[]),p=(y,...C)=>{if(y==="onQuery"){const O=a.value.map(R=>R.onQuery).filter(Boolean);return{servicePromise:Ht(O,C[0])()}}else{const O=a.value.map(R=>{var L;return(L=R[y])===null||L===void 0?void 0:L.call(R,...C)});return Object.assign({},...O)}},x=$(0);return d.runAsync=async(...y)=>{b({loading:!0,params:y,status:"pending"}),x.value+=1;const C=x.value,{isBreak:O,breakResult:R=he()}=p("onBefore",y);if(O)return b({status:"settled"}),R;c==null||c(y);try{const L=()=>new Promise(E=>E(e(...k.value)));let{servicePromise:P}=p("onQuery",L);P||(P=L());const N=await P;return C!==x.value?he():(b({data:N,loading:!1,error:void 0,status:"settled"}),p("onSuccess",N,y),s==null||s(N,y),p("onAfter",y,N,void 0),i==null||i(y),N)}catch(L){if(C!==x.value)return he();throw b({loading:!1,error:L,status:"settled"}),p("onError",L,y),l==null||l(L,y),p("onAfter",y,void 0,L),i==null||i(y),L}},d.run=(...y)=>{d.runAsync(...y).catch(C=>{l||console.error(C)})},d.cancel=()=>{x.value+=1,b({loading:!1}),p("onCancel")},d.refresh=()=>{d.run(...k.value||[])},d.refreshAsync=()=>d.runAsync(...k.value||[]),d.mutate=y=>{const C=Me(y)?y(f.value):y,O=Kt(C);b({data:O}),p("onMutate",O)},{status:m,loading:_,data:f,error:w,params:k,plugins:a,context:d}};function Yt(e,t={},o){const n=mt(Et,{}),r={...Pt(),...n,...t},{manual:u=!1,defaultParams:s=[]}=r,l=qt(e,r);if(l.plugins.value=o.map(c=>c(l,r)),!u){const c=l.params.value||s;l.context.run(...c)}return ve(()=>{l.context.cancel()}),{loading:l.loading,data:l.data,error:l.error,params:l.params,cancel:l.context.cancel,refresh:l.context.refresh,refreshAsync:l.context.refreshAsync,mutate:l.context.mutate,run:l.context.run,runAsync:l.context.runAsync}}const pe=new Map,Xt=(e,t)=>{pe.set(e,t),t.then(o=>(pe.delete(e),o)).catch(()=>{pe.delete(e)})},Zt=e=>pe.get(e),ne=new Map,eo=(e,t)=>{ne.has(e)&&ne.get(e).forEach(o=>o(t))},to=(e,t)=>(ne.has(e)?ne.get(e).push(t):ne.set(e,[t]),()=>{const o=ne.get(e).indexOf(t);ne.get(e).splice(o,1)});var oo=X((e,{cacheKey:t,cacheTime:o=6e5,staleTime:n=0,getCache:r,setCache:u})=>{if(!t)return{};const s=Me(t)?t:()=>t,l=$(()=>{});let c;const i=d=>r?r(d):Ft(d),_=(d,b,p)=>{u?u(d,p):Bt(d,b,p),eo(d,p.data)},f=d=>n===-1||d+n>new Date().getTime(),w=(d,b)=>Object.prototype.hasOwnProperty.call(d,b),k=d=>{const b=s(d);return to(b,p=>{e.data.value=p})},a=s(),m=i(a);return m&&w(m,"data")&&(e.data.value=m.data,e.params.value=m.params),a&&(l.value=k()),ve(()=>{l.value()}),{onBefore(d){const b=s(d),p=i(b);if(!p||!w(p,"data"))return{};if(f(p.time))return e.data.value=p.data,e.loading.value=!1,{isBreak:!0,breakResult:p.data};e.data.value=p.data},onQuery(d){const b=e.params.value,p=s(b);let x=Zt(p);return x&&x!==c?()=>x:(x=d(),c=x,Xt(p,x),()=>x)},onSuccess(d,b){const p=s(b);p&&(l.value(),_(p,o,{data:d,params:b,time:new Date().getTime()}),l.value=k(b))},onMutate(d){const b=s(e.params.value);b&&(l.value(),_(b,o,{data:d,params:e.params.value,time:new Date().getTime()}),l.value=k(e.params.value))}}});function no(e){let t,o;class n extends Promise{constructor(u){super(u),this.cancel=()=>{o(),clearTimeout(t)}}}return new n(r=>{o=r,t=setTimeout(o,e)})}function ke(){return new Date().getTime()}var lo=X((e,{loadingDelay:t=0,loadingKeep:o=0})=>{const n=$(()=>{}),r=M(()=>H(t)),u=M(()=>H(o));let s=0,l={};const c=()=>{let i;return r.value&&(i=setTimeout(()=>{e.status.value==="pending"&&(e.loading.value=!0)},r.value)),()=>i&&clearTimeout(i)};return{onBefore(){e.loading.value=!r.value,n.value(),n.value=c(),s=ke()},onQuery(i){if(!u.value)return()=>i();l=no(u.value+r.value);const _=async()=>{try{const w=await i();return ke()-s<=r.value&&l.cancel(),Promise.resolve(w)}catch(w){return ke()-s<=r.value&&l.cancel(),Promise.reject(w)}},f=Promise.allSettled([_(),l]).then(w=>{const k=w[0];return k.status==="fulfilled"?k.value:Promise.reject(k.reason)});return()=>f},onCancel(){n.value()},onAfter(){n.value()}}}),Ve;const Be=new Set,Ae=new Set,je=new Set,fe=(e,t)=>{let o;switch(e){case"FOCUS_LISTENER":o=Be;break;case"RECONNECT_LISTENER":o=je;break;case"VISIBLE_LISTENER":o=Ae;break}if(!o.has(t))return o.add(t),()=>{o.delete(t)}},xe=e=>{e.forEach(t=>{t()})};!Oe&&(Ve=window)!==null&&Ve!==void 0&&Ve.addEventListener&&(window.addEventListener("visibilitychange",()=>{Ke()&&xe(Ae)},!1),window.addEventListener("focus",()=>xe(Be),!1),window.addEventListener("online",()=>xe(je),!1));var ao=X((e,{pollingInterval:t,pollingWhenHidden:o=!1,pollingWhenOffline:n=!1,errorRetryCount:r=0})=>{const u=$(),s=$(!1),l=M(()=>H(t)),c=M(()=>H(r)),i=[],_=a=>{a&&i.push(a)},f=()=>(o||Ke())&&(n||Mt()),w=a=>{if(e.error.value&&c.value!==0)return;let m;if(!ie(l.value)&&l.value>=0)if(f())m=setTimeout(a,l.value);else{s.value=!0;return}return()=>m&&clearTimeout(m)},k=()=>{s.value&&f()&&(e.context.refresh(),s.value=!1)};return se(l,()=>{u.value&&(u.value(),u.value=w(()=>e.context.refresh()))}),o||_(fe("VISIBLE_LISTENER",k)),n||_(fe("RECONNECT_LISTENER",k)),ve(()=>{i.forEach(a=>a())}),{onBefore(){var a;(a=u.value)===null||a===void 0||a.call(u)},onCancel(){var a;(a=u.value)===null||a===void 0||a.call(u)},onAfter(){u.value=w(()=>e.context.refresh())}}});const ro=(e,t)=>{let o=!1;return(...n)=>{o||(o=!0,e(...n),setTimeout(()=>{o=!1},t))}};var so=X((e,{refreshOnWindowFocus:t=!1,refocusTimespan:o=5e3})=>{const n=M(()=>H(t)),r=M(()=>H(o)),u=[],s=c=>{c&&u.push(c)},l=()=>{u.forEach(c=>c())};return Y(()=>{if(l(),n.value){const c=ro(e.context.refresh,r.value);s(fe("VISIBLE_LISTENER",c)),s(fe("FOCUS_LISTENER",c))}}),ve(()=>{l()}),{}});function _e(e,t){return Yt(e,t,[lo,zt,jt,ao,Gt,so,Qt,Wt,oo])}const I=St.create();I.interceptors.response.use(e=>{const t=e.data;return t.code!==200?(ae.error(t.msg),Promise.reject(t.msg)):t});var ze=(e=>(e.默认="default",e.主要="primary",e.成功="success",e.警告="warning",e.危险="danger",e.信息="info",e.文字="text",e))(ze||{}),We=(e=>(e.显示="true",e.隐藏="false",e.发起人="startUser",e.处理人="assignee",e.未发起="notstarted",e.已发起="started",e.未办结="unfinished",e.已办结="finished",e))(We||{}),Qe=(e=>(e.不显示="false",e.审批人="approver",e.抄送人="copyUser",e.意见="comment",e))(Qe||{}),Ge=(e=>(e[e.禁用=0]="禁用",e[e.正常=1]="正常",e))(Ge||{});function Je(e){return I.get("/sapier-flow/dev-button/list",{params:e})}function uo(){return _e(()=>Je({size:-1,ascs:"sort"}).then(e=>e.data.records))}function io(e){return I.post("/sapier-flow/dev-button/save",e)}function co(e){return I.post("/sapier-flow/dev-button/update",e)}function po(e){return I.post("/sapier-flow/dev-button/remove",{},{params:{ids:e}})}const fo={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,labelWidth:130,column:[{label:"按钮名称",prop:"name"},{label:"按钮标识",prop:"buttonKey"},{label:"按钮图标",prop:"icon",component:"icon-select"},{label:"按钮类型",prop:"buttonType",type:"select",dicData:le(ze)},{label:"默认显示条件",prop:"display",type:"select",multiple:!0,dataType:"string",value:"false",dicData:le(We)},{label:"默认审批窗口显示",prop:"approval",type:"select",multiple:!0,dataType:"string",value:"false",dicData:le(Qe)},{label:"状态",prop:"status",type:"switch",value:1,dicData:le(Ge)},{label:"排序",prop:"sort",type:"number",value:0},{label:"按钮预览",prop:"buttonPreview",width:200}]},mo=A({__name:"index",setup(e){const{bindVal:t,crudStateRefs:{formData:o},getDataList:n}=q({crudOption:{rowKey:"id",getList:Je,create:io,update:co,remove:po},tableOption:fo,sortOption:{ascs:"sort"}});return n(),(r,u)=>{const s=V("v-icon"),l=V("el-button"),c=V("avue-crud");return D(),S(c,te(oe(g(t))),{icon:v(({row:i})=>[h(s,{icon:i.icon,style:{display:"inline"}},null,8,["icon"])]),buttonPreview:v(({row:i})=>[h(l,{type:i.buttonType},{default:v(()=>[h(s,{icon:i.icon},null,8,["icon"]),U(" "+z(i.name),1)]),_:2},1032,["type"])]),"buttonPreview-form":v(()=>[h(l,{type:g(o).buttonType},{default:v(()=>[h(s,{icon:g(o).icon},null,8,["icon"]),U(" "+z(g(o).name),1)]),_:1},8,["type"])]),_:1},16)}}}),Ne={menuBtn:!1,span:24,column:[{label:"流程名称",prop:"flowName",rules:[{required:!0,message:"请输入流程名称"}]},{label:"流程标识",prop:"flowKey",rules:[{required:!0,message:"请输入流程标识"}]},{label:"流程分类",prop:"categoryId",type:"select",dicUrl:"/sapier-flow/flow-category/list",props:{label:"name",value:"id"}},{label:"流程图标",prop:"flowIcon",component:"icon-select"},{label:"流程描述",prop:"remarks"},{label:"关联表",prop:"formDataTable",type:"select",dicUrl:"/sapier-flow/dev-table/list",dicQuery:{size:-1},props:{label:"tableComment",value:"tableName",desc:"tableName",res:"data.records"}}]},vo={rowKey:"flowModuleId",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,tabs:!0,dialogFullscreen:!0,addBtn:!1,editBtn:!1,delBtn:!1,menuWidth:300,column:[...Ne.column,{label:"流程主版本",prop:"mainVersion",formatter(e,t){return t?`V${t||""}`:""}}]};function _o(e){return I.get("/sapier-flow/flow-definition/list",{params:e})}function He(e){return I.get("/sapier-flow/flow-definition/detail",{params:e})}function bo(e){return I.post("/sapier-flow/flow-definition/save",e)}function yo(e){return I.post("/sapier-flow/flow-definition/update",e)}function qe(e){return I.post("/sapier-flow/flow-definition/deployFlow",e)}const Ye=A({__name:"index",props:{categoryId:null},emits:["add","view","edit","version"],setup(e,{emit:t}){const o=e,n={rowKey:"flowModuleId",getList:_o},{bindVal:r,crudStateRefs:{searchForm:u},getDataList:s}=q({crudOption:n,tableOption:vo,searchForm:{categoryId:o.categoryId}});Y(()=>{u.value.categoryId=o.categoryId??"",s()});const l=$(!1);async function c(i){await me.confirm("发布新版本，是否确认？","提示",{type:"success"}),l.value=!0,qe({flowModuleId:i.flowModuleId}).then(()=>{ae.success("发布成功"),s()}).finally(()=>{l.value=!1})}return(i,_)=>{const f=V("el-button"),w=V("v-icon"),k=V("avue-crud");return D(),S(k,te(oe(g(r))),{"menu-left":v(()=>[h(f,{type:"primary",icon:"el-icon-plus",onClick:_[0]||(_[0]=a=>t("add"))},{default:v(()=>[U(" 新增 ")]),_:1})]),menu:v(({row:a})=>[h(f,{loading:l.value,type:"text",icon:"el-icon-view",onClick:m=>t("view",a)},{default:v(()=>[U(" 查看 ")]),_:2},1032,["loading","onClick"]),h(f,{loading:l.value,type:"text",icon:"el-icon-edit",onClick:m=>t("edit",a)},{default:v(()=>[U(" 编辑 ")]),_:2},1032,["loading","onClick"]),h(f,{loading:l.value,type:"text",icon:"el-icon-upload",onClick:m=>c(a)},{default:v(()=>[U(" 发布 ")]),_:2},1032,["loading","onClick"]),h(f,{loading:l.value,type:"text",icon:"el-icon-switch",onClick:m=>t("version",a)},{default:v(()=>[U(" 版本管理 ")]),_:2},1032,["loading","onClick"])]),flowIcon:v(({row:a})=>[h(w,{icon:a.flowIcon,width:"25",style:{display:"inline"}},null,8,["icon"])]),_:1},16)}}}),wo={rowKey:"flowDeloyId",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,tabs:!0,dialogFullscreen:!0,addBtn:!1,editBtn:!1,delBtn:!1,menuWidth:250,column:[...Ne.column,{label:"流程版本",prop:"version",formatter(e,t){return t?`V${t||""}`:""}},{label:"是否主版本",prop:"mainVersion",type:"select",dicData:[{label:"否",value:0},{label:"是",value:1}]}]};var Xe=(e=>(e[e.否=0]="否",e[e.是=1]="是",e))(Xe||{});function go(e){return I.get("/sapier-flow/flow-deploy/list",{params:e})}function Ze(e){return I.get("/sapier-flow/flow-deploy/detail",{params:e})}function et(e){return I.post("/sapier-flow/flow-deploy/update",e)}function ho(){return I.get("/sapier-flow/flow-run/queryPublishFlowList")}const tt=A({__name:"index",props:{flowModuleId:null},emits:["back","view","edit"],setup(e,{emit:t}){const o=e,n={rowKey:"flowDeloyId",getList:go,dataPath:"res.data"},{bindVal:r,crudStateRefs:{searchForm:u},getDataList:s}=q({crudOption:n,tableOption:wo});Y(()=>{o.flowModuleId&&(u.value.flowModuleId=o.flowModuleId,s())});const l=$(!1);async function c(i){await me.confirm(`确定将 ${i.flowName}(${i.flowKey}:v${i.version}) 设为主版本?`,"提示",{type:"warning"}),l.value=!0,et({flowDeployId:i.flowDeployId,flowModuleId:i.flowModuleId,mainVersion:1}).then(()=>{ae.success("设置成功"),s()}).finally(()=>{l.value=!1})}return(i,_)=>{const f=V("el-button"),w=V("v-icon"),k=V("avue-crud");return D(),S(k,te(oe(g(r))),{"menu-left":v(()=>[h(f,{loading:l.value,type:"primary",icon:"el-icon-arrow-left",onClick:_[0]||(_[0]=a=>t("back"))},{default:v(()=>[U(" 返回 ")]),_:1},8,["loading"])]),menu:v(({row:a})=>[h(f,{loading:l.value,type:"text",icon:"el-icon-view",onClick:m=>t("view",a)},{default:v(()=>[U(" 查看 ")]),_:2},1032,["loading","onClick"]),h(f,{loading:l.value,type:"text",icon:"el-icon-edit",onClick:m=>t("edit",a)},{default:v(()=>[U(" 编辑 ")]),_:2},1032,["loading","onClick"]),h(f,{loading:l.value,disabled:a.mainVersion===g(Xe).是,type:"text",icon:"el-icon-switch",onClick:m=>c(a)},{default:v(()=>[U(" 设为主版本 ")]),_:2},1032,["loading","disabled","onClick"])]),flowIcon:v(({row:a})=>[h(w,{icon:a.flowIcon,width:"25",style:{display:"inline"}},null,8,["icon"])]),_:1},16)}}});function ko(e){return I.get("/sapier-flow/flow-run/queryPublishFlowDetail",{params:e})}function Vo(e){return I.post("/sapier-flow/flow-run/startProcess",e)}function xo(e){return I.post("/sapier-flow/flow-run/commitTask",e)}function Co(e){return I.post("/sapier-flow/flow-run/queryApprovalNode",e)}function Do(e){const{flowDetail:t,formVariables:o,approvalFormData:n,debug:r}=e,{flowDeployId:u}=t.value.process??{},{taskId:s,flowInstanceId:l}=t.value.task??{};return{flow_pass(){const c={flowDeployId:u,taskId:s,flowInstanceId:l,variables:o.value,debug:r.value,...n.value};return s&&l?xo(c):Vo(c)}}}function $o(e){const t=$({});return Y(async()=>{const o=j(e)?e.value:e,{formProperty:n}=(o==null?void 0:o.properties)||{};n!=null&&n.length&&(await Z(),Object.keys(t.value).forEach(r=>{var l,c,i,_;const u=((l=t.value[r])==null?void 0:l.label)||"",s=n==null?void 0:n.find(f=>f.prop===r);t.value[r].display=s==null?void 0:s.display,t.value[r].disabled=s==null?void 0:s.disabled,t.value[r].detail=s==null?void 0:s.detail,t.value[r].readonly=s==null?void 0:s.readonly,t.value[r].rules=t.value[r].rules??[],!(s!=null&&s.required&&((c=t.value[r].rules)!=null&&c.some(f=>f.required)))&&(s!=null&&s.required?(i=t.value[r].rules)==null||i.push({required:!0,message:`${u}为必填项`}):t.value[r].rules=(_=t.value[r].rules)==null?void 0:_.filter(f=>!f.required))}))}),t}function Oo(){return{visible:{type:Boolean},modelValue:{type:Object,default:()=>({})},flowDetail:{type:Object,default:()=>({})},formLoading:{type:Boolean},submitLoading:{type:Boolean},activeTab:{type:String,default:"form"},flowKey:{type:String},taskId:{type:String},instanceId:{type:String},formId:{type:String},permission:{type:Object},beforeClick:{type:Function},beforeSubmit:{type:Function},detail:{type:Boolean},debug:{type:Boolean}}}function No(){return{complete:e=>e}}const To=Symbol("flowFormState");function Io(e,t){const o=ue(e,void 0,{passive:!0,deep:!0}),{flowDetail:n,modelValue:r,formLoading:u}=o;Y(()=>{const{flowKey:d,taskId:b,instanceId:p}=e;!d&&!b&&!p||(u.value=!0,ko({flowKey:d,taskId:b,flowInstanceId:p}).then(x=>{n.value=x.data,r.value=x.data.formData||{}}).finally(()=>{u.value=!1}))});const s=M(()=>({fileTab:!0,trackTab:!0,...e.permission})),l=M(()=>{var d,b,p,x;return s.value.fileTab===!0&&((x=(p=(b=(d=n.value)==null?void 0:d.properties)==null?void 0:b.formProperty)==null?void 0:p.find(y=>y.prop==="fileTab"))==null?void 0:x.display)}),c=M(()=>{var d,b,p,x;return s.value.trackTab===!0&&((x=(p=(b=(d=n.value)==null?void 0:d.properties)==null?void 0:b.formProperty)==null?void 0:p.find(y=>y.prop==="trackTab"))==null?void 0:x.display)}),i=M(()=>{var C,O,R;const d={userId:"1"},{assignee:b,flowInstanceId:p}=n.value.task||{},x={true:!0,false:!1,assignee:b==d.userId,notstarted:!p,started:!!p};return((R=(O=(C=n.value)==null?void 0:C.properties)==null?void 0:O.button)==null?void 0:R.filter(L=>{var P,N;return(N=(P=L.display)==null?void 0:P.split(","))==null?void 0:N.every(E=>x[E])}))??[]}),_=$(),f=M(()=>i.value.find(d=>d.buttonKey===_.value)),w=$({}),k=$(!1),a=M(()=>Object.entries(r.value||{}).filter(([d])=>!d.startsWith("$")).map(([d,b])=>({key:d,value:b}))),m={...o,formVariables:a,approvalFormData:w,approvalVisible:k,showFileTab:l,showTrackTab:c,permission:s,activeButtonKey:_,activeButton:f,buttonList:i,emit:t};return vt(To,m),m}function Te(e){return new Promise((t,o)=>{(j(e)?e.value:e).validate((r,u)=>{r?(u(),t(r)):o(r)})})}const Lo=A({props:{modelValue:{type:Object,default:()=>({})},flowDetail:{type:Object,default:()=>({})},detail:{type:Boolean}},setup(e){const{modelValue:t}=ue(e,void 0,{passive:!0,deep:!0}),o=$o(e.flowDetail),{proxy:n}=bt(),r=$({});Y(()=>{const{formOption:l}=e.flowDetail.process??{};r.value=Ue.bind(n)(l||'{"menuBtn":false}'),r.value.detail=!!e.detail});const u=$();function s(){return Te(u)}return{form:t,option:r,defaults:o,formRef:u,validate:s}},render(){return _t(V("avue-form"),{ref:"formRef",modelValue:this.form,defaults:this.defaults,option:this.option,"onUpdate:modelValue":e=>this.form=e,"onUpdate:defaults":e=>this.defaults=e})}}),So=A({__name:"approval-form",props:{modelValue:null,visible:{type:Boolean},variables:null,flowDetail:null},emits:["confirm"],setup(e,{emit:t}){const o=e,n={element:"ep:flag",post:"ep:share",dept:"ep:share",user:"ep:user"},r=ue(o),{modelValue:u,visible:s,flowDetail:l}=r,c=$([]),i=$({approver:[],copyUser:"",comment:""}),_=$(),f=$({}),w={menuBtn:!1,labelWidth:70,column:[{label:"审批人",prop:"approver",span:24,rules:[{required:!0,validator:k}]},{label:"意见",prop:"comment",span:24,rules:[{required:!0,message:"请填写意见"}]}]};function k(y,C,O){var P;const R=c.value[0].type==="ParallelGateway",L=(P=c.value[0].children)==null?void 0:P.every(N=>kt([N],E=>C.some(T=>T.id===E.id)));if(C.length){if(R&&!L)return O("请在每个节点选择审批人")}else return O("请选择审批人");return!0}const a=$(),m=$(!0),d=$(!1);Y(async()=>{var R,L,P;if(!s.value||!_.value)return;const{flowKey:y}=((R=l.value)==null?void 0:R.process)||{},{taskId:C}=((L=l.value)==null?void 0:L.task)||{},O=C?"":"发起";if(c.value=[],i.value={approver:[],copyUser:"",comment:u.value.comment||O},Z(()=>{}),m.value){console.log("🚀 ~ file: approval-form.vue:120 ~ watchEffect ~ flowDetail:",l);const N=await Co({flowKey:y,variables:o.variables,taskId:C});c.value=xt(N.data??[],(T,W,K)=>{const ye=T.id||pt();return T.taskNodeKey=(K==null?void 0:K.taskNodeKey)??T.taskNodeKey,T.incoming=(K==null?void 0:K.incoming)??T.incoming,{...T,id:ye,disabled:T.type!=="user"}}),await Z();const E=b(c.value);E&&((P=a.value)==null||P.setCheckedNodes([E]))}});function b(y){var C;if(y.length===1)return(C=y[0].children)!=null&&C.length?b(y[0].children):y[0]}async function p(y,C){var R,L;if(y.type!=="user")return;await Z(),await Z();const O=(R=a.value)==null?void 0:R.getCheckedNodes();i.value.approver=O.filter(P=>P.type==="user"),(L=a.value)==null||L.setCheckedNodes(i.value.approver)}async function x(){await Te(_),d.value=!0;const{approver:y,copyUser:C,comment:O}=i.value,R={},L={},P=new Set;y.forEach(N=>{const{taskNodeKey:E,incoming:T}=N;R[E]||(R[E]=new Set),N.userId&&R[E].add(N.userId),L[E]=[...R[E]].join(","),P.add(T)}),u.value.assignee=L,u.value.comment=O,u.value.outgoing=[...P],console.log("🚀 ~ file: approval-form.vue:210 ~ onConfirm ~ formData:",u),t("confirm")}return(y,C)=>{const O=V("v-icon"),R=V("el-col"),L=V("el-tag"),P=V("el-input"),N=V("avue-form"),E=V("el-row"),T=V("el-button"),W=V("el-dialog");return D(),S(W,{modelValue:g(s),"onUpdate:modelValue":C[4]||(C[4]=K=>j(s)?s.value=K:null),width:m.value?"800px":"500px","append-to-body":""},{footer:v(()=>[h(T,{onClick:C[3]||(C[3]=K=>s.value=!1)},{default:v(()=>[U(" 取 消 ")]),_:1}),h(T,{type:"primary",onClick:x},{default:v(()=>[U(" 确 定 ")]),_:1})]),default:v(()=>[h(E,{gutter:20},{default:v(()=>[m.value?(D(),S(R,{key:0,span:10},{default:v(()=>[h(g(Vt),{ref_key:"treeRef",ref:a,class:"approval-tree","w-full":"","h-400px":"","overflow-y-scroll":"","node-key":"id","empty-text":"无需选择审批人","default-expand-all":"","show-checkbox":"","check-on-click-node":"",data:c.value,style:{"max-height":"600px",overflow:"auto"},onCheckChange:p},{default:v(({data:K})=>[J("div",null,[h(O,{icon:n[K.type],style:{display:"inline-block"}},null,8,["icon"]),J("span",null,z(K.title),1)])]),_:1},8,["data"])]),_:1})):B("",!0),h(R,{span:m.value?14:24},{default:v(()=>[h(N,{ref_key:"formRef",ref:_,modelValue:i.value,"onUpdate:modelValue":C[1]||(C[1]=K=>i.value=K),defaults:f.value,"onUpdate:defaults":C[2]||(C[2]=K=>f.value=K),option:w},{approver:v(()=>[(D(!0),F(G,null,ee(i.value.approver,K=>(D(),S(L,{key:K.id,type:"info"},{default:v(()=>[U(z(K.title),1)]),_:2},1024))),128))]),copyUser:v(()=>[]),comment:v(()=>[h(P,{modelValue:i.value.comment,"onUpdate:modelValue":C[0]||(C[0]=K=>i.value.comment=K),type:"textarea"},null,8,["modelValue"])]),_:1},8,["modelValue","defaults"])]),_:1},8,["span"])]),_:1})]),_:1},8,["modelValue","width"])}}}),Ro=It;function Eo(e){return I.get("/sapier-flow/flow-param/list",{params:e})}function ot(e){return I.get("/sapier-flow/flow-param/getParam",{params:{paramKey:e}})}function Po(e){return I.post("/sapier-flow/flow-param/save",e)}function Uo(e){return I.post("/sapier-flow/flow-param/update",e)}function Mo(e){return I.post("/sapier-flow/flow-param/remove",{},{params:{ids:e}})}const Ko={key:0,class:"flow-viewer"},Fo={class:"flow-status-legend"},Bo=A({__name:"index",props:{modelValue:null,view:{type:Boolean},formOption:null,flowHistory:null},emits:["update:modelValue"],setup(e,{emit:t}){const o=e,n=$({}),r=$();function u(a,m){return a.map(d=>{var E,T;const b=m.find(W=>W.prop===d.prop),{label:p,prop:x,display:y=!0,disabled:C=!1,detail:O=!1,readonly:R=!1,rules:L}=d,P=(L==null?void 0:L.some(W=>W.required))??!1,N={label:p,prop:x,display:y,disabled:C,detail:O,readonly:R,required:P,...b};return d.type==="dynamic"&&((T=(E=d.children)==null?void 0:E.column)!=null&&T.length)&&(N.children=u(d.children.column,(b==null?void 0:b.children)??[])),N})}function s(a,m){return a.map(d=>{const b=m.find(x=>x.buttonKey===d.buttonKey);return{...d,...b}})}const{data:l}=uo();async function c(a){var m,d;if(await Z(),(m=n.value.group)!=null&&m.some(b=>b.prop==="formProperty")){const{column:b=[],group:p=[]}=JSON.parse(o.formOption||"{}"),x=u([...b,...p.map(y=>y.column??[]).flat()],a.formProperty||[]);a.formProperty=x}if((d=n.value.group)!=null&&d.some(b=>b.prop==="button")){const b=s(l.value||[],a.button||[]);a.button=b}return a}function i(a){var x;const{column:m=[],group:d=[]}=JSON.parse(o.formOption||"{}"),p=[...m,...d.map(y=>y.column??[]).flat()].map(y=>({label:y.label,value:`\${${y.prop}}`,desc:`\${${y.prop}}`}));return(x=a.group)==null||x.forEach(y=>{var C;y.prop==="base"&&((C=y.column)==null||C.forEach(O=>{O.prop==="priority"&&(O.type="select",O.filterable=!0,O.allowCreate=!0,O.defaultFirstOption=!0,O.dicData=p),O.prop==="formTitle"&&(O.type="select",O.dataType="string",O.multiple=!0,O.filterable=!0,O.allowCreate=!0,O.defaultFirstOption=!0,O.dicData=p)}))}),a}const _=M({get(){let a=Tt();return typeof o.modelValue=="string"&&o.modelValue?a=JSON.parse(o.modelValue):typeof o.modelValue=="object"&&Object.keys(o.modelValue)&&(a=o.modelValue),a},set(a){t("update:modelValue",JSON.stringify(a))}}),f=$([]);ot("flow.task.status").then(a=>{f.value=a.data});const w=M(()=>{var a;return(a=o.flowHistory)==null?void 0:a.map(m=>{const d=f.value.find(b=>b.status===m.status);return{id:m.taskNodeKey,style:d}})}),k=ce();return(a,m)=>e.view?(D(),F("div",Ko,[J("div",Fo,[(D(!0),F(G,null,ee(f.value,d=>{var b;return D(),F("div",{key:d.name,class:"legend-item"},[J("div",{class:"legend-color",style:yt({backgroundColor:(b=d.style)==null?void 0:b.fill})},null,4),J("span",null,z(d.name),1)])}),128))]),h(g(Ot),{lf:g(k),"onUpdate:lf":m[0]||(m[0]=d=>j(k)?k.value=d:null),"model-value":g(_),styles:g(w)},null,8,["lf","model-value","styles"])])):(D(),S(g(Nt),{key:1,modelValue:g(_),"onUpdate:modelValue":m[1]||(m[1]=d=>j(_)?_.value=d:null),lf:g(k),"onUpdate:lf":m[2]||(m[2]=d=>j(k)?k.value=d:null),elementData:r.value,"onUpdate:elementData":m[3]||(m[3]=d=>r.value=d),formOption:n.value,"onUpdate:formOption":m[4]||(m[4]=d=>n.value=d),"form-options":g(Ro),"form-data-format":c,"form-option-format":i,"form-width":"30%"},null,8,["modelValue","lf","elementData","formOption","form-options"]))}});const be=De(Bo,[["__scopeId","data-v-8309dee2"]]),Ao={class:"flow-track"},jo={key:0},zo=A({__name:"flow-track",props:{flowDetail:null},setup(e){const t=e,o=[{label:"table",icon:"ep:grid"},{label:"graph",icon:"ep:picture"},{label:"timeline",icon:"ep:finished"}],n=$("table"),r=M(()=>{var s,l;return((l=(s=t.flowDetail)==null?void 0:s.flowHistory)==null?void 0:l.filter(c=>c.taskNodeType==="userTask"))??[]}),u={addBtn:!1,menu:!1,border:!0,column:[{label:"节点名称",prop:"taskNodeName"},{label:"处理人",prop:"assigneeName"},{label:"处理时间",prop:"createTime"},{label:"办理时长",prop:"duration"},{label:"操作类型",prop:"type"},{label:"审批意见",prop:"comment",bind:"comment.comment"}]};return(s,l)=>{var m,d,b;const c=V("v-icon"),i=V("el-radio-button"),_=V("el-radio-group"),f=V("avue-crud"),w=V("el-card"),k=V("el-timeline-item"),a=V("el-timeline");return D(),F(G,null,[h(_,{modelValue:n.value,"onUpdate:modelValue":l[0]||(l[0]=p=>n.value=p)},{default:v(()=>[(D(),F(G,null,ee(o,p=>h(i,{key:p.label,label:p.label},{default:v(()=>[h(c,{icon:p.icon},null,8,["icon"])]),_:2},1032,["label"])),64))]),_:1},8,["modelValue"]),J("div",Ao,[n.value==="table"?(D(),S(f,{key:0,class:"hide-menu",data:g(r),option:u},null,8,["data"])):B("",!0),n.value==="graph"?(D(),S(be,{key:1,"model-value":(d=(m=e.flowDetail)==null?void 0:m.process)==null?void 0:d.flowData,"flow-history":(b=e.flowDetail)==null?void 0:b.flowHistory,view:""},null,8,["model-value","flow-history"])):B("",!0),n.value==="timeline"?(D(),S(a,{key:2},{default:v(()=>[(D(!0),F(G,null,ee([...g(r)].reverse(),p=>(D(),S(k,{key:p.id,timestamp:p.createTime,placement:"top"},{default:v(()=>[h(w,null,{default:v(()=>{var x;return[J("div",null,z(p.assigneeName)+" 开始处理 ["+z(p.taskNodeName)+"] 环节",1),p.type?(D(),F("div",jo,z(p.type)+"意见："+z((x=p.comment)==null?void 0:x.comment),1)):B("",!0)]}),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})):B("",!0)])],64)}}});const Wo=De(zo,[["__scopeId","data-v-b6c5452a"]]),Ie=A({__name:"index",props:Oo(),emits:No(),setup(e,{emit:t}){const o=e,n=Io(o,t),{visible:r,flowDetail:u,modelValue:s,approvalFormData:l,formVariables:c,buttonList:i,activeButtonKey:_,activeButton:f,approvalVisible:w,submitLoading:k}=n,a=$();async function m(b){var p,x,y;await((p=a.value)==null?void 0:p.validate()),await((x=o.beforeClick)==null?void 0:x.call(o,b)),_.value=b,(y=f.value)!=null&&y.approval?w.value=!0:d()}async function d(){var p,x;const b=Do(n);try{k.value=!0,await((p=o.beforeSubmit)==null?void 0:p.call(o,_.value)),await((x=b[_.value])==null?void 0:x.call(b)),ae.success("操作成功"),w.value=!1,t("complete",_.value)}finally{k.value=!1}}return(b,p)=>{const x=V("el-skeleton"),y=V("v-icon"),C=V("el-button"),O=V("el-header"),R=V("el-tab-pane"),L=V("el-tabs"),P=V("el-main"),N=V("el-container"),E=V("el-drawer");return D(),S(E,{modelValue:g(r),"onUpdate:modelValue":p[4]||(p[4]=T=>j(r)?r.value=T:null),title:"我是标题",size:"60%"},{default:v(()=>[b.formLoading?(D(),S(x,{key:0})):(D(),S(N,{key:1,class:"flow-form"},{default:v(()=>[h(O,{class:"flow-form__header"},{default:v(()=>[(D(!0),F(G,null,ee(g(i),T=>(D(),S(C,{key:T.buttonKey,type:T.buttonType,onClick:W=>m(T.buttonKey)},{default:v(()=>[h(y,{icon:T.icon},null,8,["icon"]),U(" "+z(T.name),1)]),_:2},1032,["type","onClick"]))),128))]),_:1}),h(P,{class:"flow-form__main"},{default:v(()=>[h(L,{modelValue:b.activeTab,"onUpdate:modelValue":p[1]||(p[1]=T=>b.activeTab=T)},{default:v(()=>{var T,W;return[(W=(T=g(u))==null?void 0:T.process)!=null&&W.formPath?wt(b.$slots,"default",{key:0}):(D(),S(R,{key:1,label:"审批信息",name:"form"},{default:v(()=>[h(Lo,{ref_key:"formRef",ref:a,modelValue:g(s),"onUpdate:modelValue":p[0]||(p[0]=K=>j(s)?s.value=K:null),"flow-detail":g(u)},null,8,["modelValue","flow-detail"])]),_:1})),h(R,{label:"附件资料",name:"file",lazy:""}),h(R,{label:"流程跟踪",name:"track",lazy:""},{default:v(()=>[h(Wo,{"flow-detail":g(u)},null,8,["flow-detail"])]),_:1})]}),_:3},8,["modelValue"])]),_:3}),h(So,{modelValue:g(l),"onUpdate:modelValue":p[2]||(p[2]=T=>j(l)?l.value=T:null),visible:g(w),"onUpdate:visible":p[3]||(p[3]=T=>j(w)?w.value=T:null),variables:g(c),"flow-detail":g(u),onConfirm:d},null,8,["modelValue","visible","variables","flow-detail"])]),_:3}))]),_:3},8,["modelValue"])}}});function Qo(e){return I.get("/sapier-flow/flow-category/list",{params:e})}function Go(e){return I.post("/sapier-flow/flow-category/save",e)}function Jo(e){return I.post("/sapier-flow/flow-category/update",e)}function Ho(e){return I.post("/sapier-flow/flow-category/remove",{},{params:{ids:e}})}const Re={defaultExpandAll:!0,props:{label:"name",value:"id"},filter:!0,formOption:{column:[{label:"分类名称",prop:"name",rules:[{required:!0,message:"请输入分类名称"}]},{label:"描述",prop:"remark"}]}},qo=A({__name:"index",emits:["node-click"],setup(e,{emit:t}){const o={rowKey:"id",getList:Qo,create:Go,update:Jo,remove:Ho,dataPath:"res.data"},{crudStateRefs:{formData:n,tableData:r},getDataList:u,handleSave:s,handleUpdate:l,handleDel:c}=q({crudOption:o,tableOption:Re,pageOption:{pageSize:20},mockCache:"flow-category"});u();function i(w,k,a,m){s(k,a,m)}function _(w,k,a,m){l(k,NaN,a,m)}async function f(w,k){await c(w.data,NaN),k()}return(w,k)=>{const a=V("avue-tree");return D(),S(a,{modelValue:g(n),"onUpdate:modelValue":k[0]||(k[0]=m=>j(n)?n.value=m:null),option:g(Re),data:g(r),onNodeClick:k[1]||(k[1]=m=>t("node-click",m)),onSave:i,onUpdate:_,onDel:f},null,8,["modelValue","option","data"])}}}),Le=A({__name:"index",props:{modelValue:null,view:{type:Boolean},fields:null},emits:["update:modelValue"],setup(e,{emit:t}){var l;const o=e,n=M({get(){return o.modelValue?Ue(o.modelValue):{menuBtn:!1,span:24}},set(c){t("update:modelValue",$t(c,{useJson5:!1}))}}),r=M(()=>o.fields?JSON.parse(o.fields):[]),u=M(()=>{const c={type:"select",dicData:r.value,filterable:!0,allowCreate:!0,defaultFirstOption:!0};return[{...c,props:{label:"name",value:"name",desc:"comment"}},{...c,props:{label:"comment",value:"comment",desc:"name"}}]}),s={form:{settings:Array.from({length:((l=Ct.settings)==null?void 0:l.length)??0}).fill({}).concat({label:"样式类",prop:"class"})}};return(c,i)=>{const _=V("avue-form");return e.view?(D(),S(_,{key:0,class:gt(g(n).class),"model-value":{},option:g(n)},null,8,["class","option"])):(D(),S(g(Dt),{key:1,modelValue:g(n),"onUpdate:modelValue":i[0]||(i[0]=f=>j(n)?n.value=f:null),"base-option":g(u),resources:s},null,8,["modelValue","base-option"]))}}});function nt(e){return I.get("/sapier-flow/dev-form/list",{params:e})}function Yo(){return _e(()=>nt({size:-1}).then(e=>e.data.records))}function Xo(e){return I.post("/sapier-flow/dev-form/submit",e)}function Zo(e){return I.post("/sapier-flow/dev-form/submit",e)}function en(e){return I.post("/sapier-flow/dev-form/remove",{},{params:{ids:e}})}function lt(e){return I.get("/sapier-flow/dev-flow/list",{params:e})}function tn(){return _e(()=>lt({size:-1}).then(e=>e.data.records))}function on(e){return I.post("/sapier-flow/dev-flow/submit",e)}function nn(e){return I.post("/sapier-flow/dev-flow/submit",e)}function ln(e){return I.post("/sapier-flow/dev-flow/remove",{},{params:{ids:e}})}var at=(e=>(e.bigint="bigint",e.blob="blob",e.char="char",e.date="date",e.datetime="datetime",e.decimal="decimal",e.double="double",e.enum="enum",e.float="float",e.int="int",e.longblob="longblob",e.longtext="longtext",e.mediumblob="mediumblob",e.mediumint="mediumint",e.mediumtext="mediumtext",e.set="set",e.smallint="smallint",e.text="text",e.time="time",e.timestamp="timestamp",e.tinyblob="tinyblob",e.tinyint="tinyint",e.tinytext="tinytext",e.varbinary="varbinary",e.varchar="varchar",e.year="year",e))(at||{});function rt(e){return I.get("/sapier-flow/dev-table/list",{params:e})}function an(){return _e(()=>rt({size:-1}).then(e=>e.data.records))}function rn(e){return I.post("/sapier-flow/dev-table/save",e)}function sn(e){return I.post("/sapier-flow/dev-table/update",e)}function un(e){return I.post("/sapier-flow/dev-table/remove",{},{params:{ids:e}})}function cn(e){return I.post("/sapier-flow/dev-table/deploy",e)}const dn=J("span",null,"流程设计",-1),pn={key:0},fn={key:1},mn={style:{height:"calc(100vh - 144px)"}},vn=A({__name:"index",props:{modelValue:null,visible:{type:Boolean}},emits:["close"],setup(e,{emit:t}){const n=ue(e),{visible:r,modelValue:u}=n,s=["流程信息","表单设计","模型设计","完成"],l=$(!1);se(r,async x=>{if(!x)return;const{flowModuleId:y}=u.value,{flowDeployId:C}=u.value;try{l.value=!0;let O={};C?O=await Ze({flowDeployId:C}):y&&(O=await He({flowModuleId:y})),u.value=O.data}finally{l.value=!1}},{immediate:!0});const{data:c}=Yo(),{data:i}=tn(),{data:_}=an(),f=M(()=>{var x,y;return(y=(x=_.value)==null?void 0:x.find(C=>C.tableName===u.value.formDataTable))==null?void 0:y.tableFields}),w=$(0),k=M(()=>{var x,y;return w.value===1?((x=c.value)==null?void 0:x.map(C=>({label:C.formName,value:C.formOption})))??[]:w.value===2?((y=i.value)==null?void 0:y.map(C=>({label:C.flowName,value:C.flowData})))??[]:[]});function a(x){w.value===1?u.value.formOption=x.value:w.value===2&&(u.value.flowData=x.value)}const m=$();async function d(x){w.value===0&&await Te(m),l.value=!0;const{flowModuleId:y}=u.value,{flowDeployId:C}=u.value;try{C?await et(u.value):y?await yo(u.value):await bo(u.value).then(O=>{u.value.flowModuleId=O.data.flowModuleId}),ae.success("保存成功")}finally{l.value=!1}typeof x=="number"?w.value=x:w.value++}async function b(){await me.confirm("发布新版本，是否确认？","提示"),l.value=!0,qe({flowModuleId:u.value.flowModuleId}).then(()=>{ae.success("发布成功")}).finally(()=>{l.value=!1})}function p(){r.value=!1,w.value=0,u.value={},t("close")}return(x,y)=>{const C=V("el-link"),O=V("el-dropdown-item"),R=V("el-dropdown-menu"),L=V("el-dropdown"),P=V("el-col"),N=V("el-step"),E=V("el-steps"),T=V("el-button"),W=V("el-row"),K=V("avue-form"),ye=V("el-result"),it=V("el-dialog"),ct=Ee("loading");return D(),S(it,{modelValue:g(r),"onUpdate:modelValue":y[4]||(y[4]=Q=>j(r)?r.value=Q:null),fullscreen:"","show-close":!1,"destroy-on-close":"",onClose:p},{header:v(()=>[h(W,{align:"center",justify:"center"},{default:v(()=>[h(P,{span:5},{default:v(()=>{var Q,re,we,Se;return[J("div",null,[dn,(Q=g(u))!=null&&Q.flowName?(D(),F("span",pn," - "+z((re=g(u))==null?void 0:re.flowName),1)):B("",!0),(we=g(u))!=null&&we.version?(D(),F("span",fn," - V"+z((Se=g(u))==null?void 0:Se.version),1)):B("",!0)]),g(k).length?(D(),S(L,{key:0},{dropdown:v(()=>[h(R,null,{default:v(()=>[(D(!0),F(G,null,ee(g(k),ge=>(D(),S(O,{key:ge.label,onClick:Un=>a(ge)},{default:v(()=>[U(z(ge.label),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),default:v(()=>[h(C,{icon:"el-icon-arrow-down",underline:!1},{default:v(()=>[U(" 选择模板 ")]),_:1})]),_:1})):B("",!0)]}),_:1}),h(P,{span:14},{default:v(()=>[h(E,{active:w.value,simple:"","process-status":"finish","finish-status":"success"},{default:v(()=>[(D(),F(G,null,ee(s,(Q,re)=>h(N,{key:re,title:Q,onClick:we=>d(re)},null,8,["title","onClick"])),64))]),_:1},8,["active"])]),_:1}),h(P,{span:5,style:{"text-align":"right"}},{default:v(()=>[h(T,{disabled:w.value===0,loading:l.value,type:"primary",onClick:y[0]||(y[0]=Q=>w.value--)},{default:v(()=>[U(" 上一步 ")]),_:1},8,["disabled","loading"]),h(T,{disabled:w.value===s.length-1,type:"primary",loading:l.value,onClick:d},{default:v(()=>[U(" 下一步 ")]),_:1},8,["disabled","loading"]),h(T,{onClick:p},{default:v(()=>[U(" 关闭 ")]),_:1})]),_:1})]),_:1})]),default:v(()=>[Pe((D(),F("div",mn,[w.value===0?(D(),S(K,{key:0,ref_key:"formRef",ref:m,modelValue:g(u),"onUpdate:modelValue":y[1]||(y[1]=Q=>j(u)?u.value=Q:null),option:g(Ne),style:{width:"50%",magin:"0 auto"}},null,8,["modelValue","option"])):B("",!0),w.value===1?(D(),S(Le,{key:1,modelValue:g(u).formOption,"onUpdate:modelValue":y[2]||(y[2]=Q=>g(u).formOption=Q),fields:g(f)},null,8,["modelValue","fields"])):B("",!0),w.value===2?(D(),S(be,{key:2,modelValue:g(u).flowData,"onUpdate:modelValue":y[3]||(y[3]=Q=>g(u).flowData=Q),"form-option":g(u).formOption},null,8,["modelValue","form-option"])):B("",!0),w.value===3?(D(),S(ye,{key:3,icon:"success",title:"流程设计完成"},{extra:v(()=>[g(u).flowDeployId?B("",!0):(D(),S(T,{key:0,type:"primary",onClick:b},{default:v(()=>[U(" 发布 ")]),_:1})),h(T,{onClick:p},{default:v(()=>[U(" 关闭 ")]),_:1})]),_:1})):B("",!0)])),[[ct,l.value]])]),_:1},8,["modelValue"])}}}),_n=J("span",null,"流程查看",-1),bn={key:0},yn={key:1},wn=A({__name:"index",props:{modelValue:null,visible:{type:Boolean}},setup(e){const o=ue(e),{visible:n,modelValue:r}=o,u=$("form"),s=$(!1);se(n,async c=>{if(!c)return;const{flowModuleId:i}=r.value,{flowDeployId:_}=r.value;try{s.value=!0;let f={};_?f=await Ze({flowDeployId:_}):i&&(f=await He({flowModuleId:i})),r.value={...f.data}}finally{s.value=!1}},{immediate:!0});function l(){r.value={},u.value="form"}return(c,i)=>{const _=V("el-tab-pane"),f=V("el-tabs"),w=V("el-dialog"),k=Ee("loading");return D(),S(w,{modelValue:g(n),"onUpdate:modelValue":i[3]||(i[3]=a=>j(n)?n.value=a:null),width:"60%",top:"0",onClose:l},{header:v(()=>{var a,m,d,b;return[_n,(a=g(r))!=null&&a.flowName?(D(),F("span",bn," - "+z((m=g(r))==null?void 0:m.flowName),1)):B("",!0),(d=g(r))!=null&&d.version?(D(),F("span",yn," - V"+z((b=g(r))==null?void 0:b.version),1)):B("",!0)]}),default:v(()=>[Pe((D(),S(f,{modelValue:u.value,"onUpdate:modelValue":i[2]||(i[2]=a=>u.value=a)},{default:v(()=>[h(_,{label:"查看表单",name:"form",style:{height:"600px","overflow-y":"auto"}},{default:v(()=>[u.value==="form"&&g(r).formOption?(D(),S(Le,{key:0,modelValue:g(r).formOption,"onUpdate:modelValue":i[0]||(i[0]=a=>g(r).formOption=a),view:""},null,8,["modelValue"])):B("",!0)]),_:1}),h(_,{label:"查看流程",name:"flow",style:{height:"600px"}},{default:v(()=>[u.value==="flow"?(D(),S(be,{key:0,modelValue:g(r).flowData,"onUpdate:modelValue":i[1]||(i[1]=a=>g(r).flowData=a),view:""},null,8,["modelValue"])):B("",!0)]),_:1})]),_:1},8,["modelValue"])),[[k,s.value]])]),_:1},8,["modelValue"])}}}),gn=A({__name:"index",setup(e){const t=$("definition"),o=$({}),n=$(""),r=$("");function u(a){n.value===a.id?n.value="":n.value=a.id}const s=$(!1),l=$(!1);function c(){o.value={},s.value=!0}function i(a){o.value=a,s.value=!0}function _(a){o.value=a,l.value=!0}function f(a){r.value=a.flowModuleId||"",t.value="deploy"}function w(){r.value="",t.value="definition"}async function k(){const a=t.value;await Z(),t.value="",await Z(),t.value=`${a}`}return(a,m)=>{const d=V("el-col"),b=V("el-row");return D(),S(b,{gutter:20},{default:v(()=>[h(d,{span:4},{default:v(()=>[h(qo,{onNodeClick:u})]),_:1}),h(d,{span:20},{default:v(()=>[t.value==="definition"?(D(),S(Ye,{key:0,"category-id":n.value,onAdd:c,onEdit:i,onView:_,onVersion:f},null,8,["category-id"])):B("",!0),t.value==="deploy"?(D(),S(tt,{key:1,"flow-module-id":r.value,onEdit:i,onView:_,onBack:w},null,8,["flow-module-id"])):B("",!0),h(vn,{modelValue:o.value,"onUpdate:modelValue":m[0]||(m[0]=p=>o.value=p),visible:s.value,"onUpdate:visible":m[1]||(m[1]=p=>s.value=p),onClose:k},null,8,["modelValue","visible"]),h(wn,{modelValue:o.value,"onUpdate:modelValue":m[2]||(m[2]=p=>o.value=p),visible:l.value,"onUpdate:visible":m[3]||(m[3]=p=>l.value=p)},null,8,["modelValue","visible"])]),_:1})]),_:1})}}});var st=(e=>(e[e.已办=1]="已办",e[e.待办=2]="待办",e))(st||{});function hn(e){return I.get("/sapier-flow/flow-ops/list",{params:e})}const kn={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,menu:!1,addBtn:!1,column:[{label:"流程名称",prop:"flowName"},{label:"流程标识",prop:"flowKey"},{label:"流程分类",prop:"categoryId"},{label:"标题",prop:"processTitle"},{label:"流水号",prop:"serialNumber"},{label:"当前节点",prop:"taskNodeName"},{label:"审批人",prop:"assigneeName"},{label:"申请人",prop:"applyUserName"},{label:"接收时间",prop:"createTime"},{label:"任务状态",prop:"status",type:"select",dicData:le(st)}]},Vn=A({__name:"index",setup(e){const t=ht("debugMode",!1),o={rowKey:"id",getList:hn},{bindVal:n,crudStateRefs:{formData:r},getDataList:u}=q({crudOption:o,tableOption:kn});u();const s=$(!1);async function l(c){r.value=c,s.value=!0}return(c,i)=>{const _=V("el-switch"),f=V("el-button"),w=V("el-link"),k=V("avue-crud");return D(),F(G,null,[h(k,te(oe(g(n))),{"menu-right":v(()=>[h(f,{type:"text"},{default:v(()=>[h(_,{modelValue:g(t),"onUpdate:modelValue":i[0]||(i[0]=a=>j(t)?t.value=a:null),"inline-prompt":"","active-text":"debug","inactive-text":"debug"},null,8,["modelValue"])]),_:1})]),processTitle:v(({row:a})=>[h(w,{type:"primary",underline:!1,onClick:m=>l(a)},{default:v(()=>[U(z(a.processTitle||"无标题"),1)]),_:2},1032,["onClick"])]),_:1},16),h(Ie,{visible:s.value,"onUpdate:visible":i[1]||(i[1]=a=>s.value=a),"task-id":g(r).taskId,"instance-id":g(r).flowInstanceId,debug:g(t)},null,8,["visible","task-id","instance-id","debug"])],64)}}});var ut=(e=>(e[e.否=0]="否",e[e.是=1]="是",e))(ut||{});const Ce=le(ut),xn={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,span:24,column:[{label:"配置名称",prop:"paramName"},{label:"配置Key",prop:"paramKey"},{label:"配置值",prop:"paramValue",type:"textarea",overHidden:!0},{label:"系统内置",prop:"paramType",type:"switch",dicData:Ce},{label:"备注",prop:"remark"}]},Cn=A({__name:"index",setup(e){const{bindVal:t,getDataList:o}=q({crudOption:{rowKey:"id",getList:Eo,create:Po,update:Uo,remove:Mo},tableOption:xn});return o(),(n,r)=>{const u=V("avue-crud");return D(),S(u,te(oe(g(t))),null,16)}}}),Dn={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,span:24,column:[{label:"流程标识",prop:"flowKey"},{label:"流程名称",prop:"flowName"},{label:"流程模型数据",prop:"flowData",display:!1},{label:"流程备注",prop:"remarks"},{label:"排序",prop:"sort"}]},$n=A({__name:"index",setup(e){const t={rowKey:"id",getList:lt,create:on,update:nn,remove:ln},{bindVal:o,crudStateRefs:{formData:n},getDataList:r,handleUpdate:u}=q({crudOption:t,tableOption:Dn,mockCache:"model-template"});r();const s=$(!1);async function l(i){n.value=i,s.value=!0}async function c(){await u(n.value,NaN,()=>s.value=!1,()=>{})}return(i,_)=>{const f=V("el-button"),w=V("avue-crud"),k=V("el-dialog");return D(),F(G,null,[h(w,te(oe(g(o))),{flowData:v(({row:a})=>[h(f,{type:"primary",text:"",icon:"el-icon-crop",onClick:m=>l(a)},{default:v(()=>[U(" 设计 ")]),_:2},1032,["onClick"])]),_:1},16),h(k,{modelValue:s.value,"onUpdate:modelValue":_[2]||(_[2]=a=>s.value=a),title:`模型设计-${g(n).flowName}`,fullscreen:"","destroy-on-close":""},{footer:v(()=>[h(f,{type:"primary",onClick:c},{default:v(()=>[U(" 保存 ")]),_:1}),h(f,{onClick:_[1]||(_[1]=a=>s.value=!1)},{default:v(()=>[U(" 取消 ")]),_:1})]),default:v(()=>[h(be,{modelValue:g(n).flowData,"onUpdate:modelValue":_[0]||(_[0]=a=>g(n).flowData=a),style:{height:"calc(100vh - 177px)"}},null,8,["modelValue"])]),_:1},8,["modelValue","title"])],64)}}}),On={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,span:24,column:[{label:"表单标识",prop:"formKey"},{label:"表单名称",prop:"formName"},{label:"表单配置",prop:"formOption",display:!1},{label:"表单备注",prop:"remarks"},{label:"排序",prop:"sort",type:"number"}]},Nn=A({__name:"index",setup(e){const t={rowKey:"id",getList:nt,create:Xo,update:Zo,remove:en},{bindVal:o,crudStateRefs:{formData:n},getDataList:r,handleUpdate:u}=q({crudOption:t,tableOption:On,mockCache:"form-template"});r();const s=$(!1);async function l(i){n.value={...i},s.value=!0}async function c(){await u(n.value,NaN,()=>s.value=!1,()=>{})}return(i,_)=>{const f=V("el-button"),w=V("avue-crud"),k=V("el-dialog");return D(),F(G,null,[h(w,te(oe(g(o))),{formOption:v(({row:a})=>[h(f,{type:"primary",text:"",icon:"el-icon-crop",onClick:m=>l(a)},{default:v(()=>[U(" 设计 ")]),_:2},1032,["onClick"])]),_:1},16),h(k,{modelValue:s.value,"onUpdate:modelValue":_[2]||(_[2]=a=>s.value=a),title:`表单设计-${g(n).formName}`,fullscreen:"","destroy-on-close":""},{footer:v(()=>[h(f,{type:"primary",onClick:c},{default:v(()=>[U(" 保存 ")]),_:1}),h(f,{onClick:_[1]||(_[1]=a=>s.value=!1)},{default:v(()=>[U(" 取消 ")]),_:1})]),default:v(()=>[h(Le,{modelValue:g(n).formOption,"onUpdate:modelValue":_[0]||(_[0]=a=>g(n).formOption=a),style:{height:"calc(100vh - 177px)"}},null,8,["modelValue"])]),_:1},8,["modelValue","title"])],64)}}}),Tn={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,span:24,dialogFullscreen:!0,column:[{label:"表名",prop:"tableName"},{label:"表注释",prop:"tableComment"},{label:"表引擎",prop:"tableEngine"},{label:"表主键策略",prop:"tablePrimary"},{label:"数据库字段",prop:"tableFields",hide:!0,type:"dynamic",children:{column:[{label:"字段名称",prop:"name"},{label:"字段备注",prop:"comment"},{label:"字段类型",prop:"type",type:"select",filterable:!0,allowCreated:!0,defaultFirstOption:!0,dicData:le(at)},{label:"字段长度",prop:"size",type:"number"},{label:"小数位",prop:"point",type:"number"},{label:"默认值",prop:"default"},{label:"是否主键",prop:"primary",type:"switch",dicData:Ce,value:0},{label:"是否允许为空",prop:"permitNull",type:"switch",dicData:Ce,value:1}]}}]},In=A({__name:"index",setup(e){const{bindVal:t,crudStateRefs:{formData:o},getDataList:n,afterGetList:r,beforeOpen:u,beforeSave:s,beforeUpdate:l}=q({crudOption:{rowKey:"id",getList:rt,create:rn,update:sn,remove:un},tableOption:Tn}),c=$([]);r(()=>{ot("table.default.fields").then(f=>{c.value=f.data})}),n(),u(f=>{f==="add"?o.value.tableFields=c.value:o.value.tableFields=JSON.parse(o.value.tableFields)}),s(f=>{f.tableFields=JSON.stringify(f.tableFields)}),l(f=>{f.tableFields=JSON.stringify(f.tableFields)});const i=$(!1);async function _(f){await me.confirm("部署将自动生成数据库表，是否确认？","提示",{type:"success"}),i.value=!0,cn({id:f.id}).then(()=>{ae.success("部署成功"),n()}).finally(()=>{i.value=!1})}return(f,w)=>{const k=V("el-button"),a=V("avue-crud");return D(),S(a,te(oe(g(t))),{menu:v(({row:m})=>[h(k,{type:"text",icon:"el-icon-upload",onClick:d=>_(m)},{default:v(()=>[U(" 部署 ")]),_:2},1032,["onClick"])]),_:1},16)}}}),Ln={class:"flow-list"},Sn=["onClick"],Rn={class:"flow-name"},En=A({__name:"index",setup(e){const t=$([]);ho().then(u=>{t.value=u.data});const o=$(!1),n=$("");function r(u){n.value=u.flowKey,o.value=!0}return(u,s)=>{const l=V("v-icon");return D(),F(G,null,[J("div",Ln,[(D(!0),F(G,null,ee(t.value,c=>(D(),F("div",{key:c.flowKey,class:"flow-item",onClick:i=>r(c)},[h(l,{class:"flow-icon",icon:c.flowIcon,width:"60"},null,8,["icon"]),J("div",Rn,z(c.flowName),1)],8,Sn))),128))]),h(Ie,{visible:o.value,"onUpdate:visible":s[0]||(s[0]=c=>o.value=c),"flow-key":n.value},null,8,["visible","flow-key"])],64)}}});const Pn=De(En,[["__scopeId","data-v-85062dcb"]]),Bl={install(e){e.component("FlowButton",mo),e.component("FlowDefinition",Ye),e.component("FlowDeploy",tt),e.component("FlowForm",Ie),e.component("FlowManage",gn),e.component("FlowOps",Vn),e.component("FlowParam",Cn),e.component("FlowTemplate",$n),e.component("FormTemplate",Nn),e.component("TableTemplate",In),e.component("Workbench",Pn)}};export{mo as FlowButton,Ye as FlowDefinition,tt as FlowDeploy,Ie as FlowForm,gn as FlowManage,Vn as FlowOps,Cn as FlowParam,$n as FlowTemplate,Nn as FormTemplate,In as TableTemplate,Pn as Workbench,Bl as default};
