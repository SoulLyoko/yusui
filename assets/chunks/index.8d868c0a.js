var ee=Object.defineProperty;var te=(s,e,t)=>e in s?ee(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var _=(s,e,t)=>(te(s,typeof e!="symbol"?e+"":e,t),t);import{m as oe,a as se,d as ne,b as A,u as ae}from"./index.181284a5.js";import{A as Kt,f as Ht,g as Wt,h as Qt,j as Xt,e as Yt,k as Zt,z as eo,l as to,n as oo,i as so,o as no,p as ao,q as io,r as lo,s as co,t as ro,v as uo,w as po,x as mo,c as yo,y as ho}from"./index.181284a5.js";import{g as ie,R as K,l as G,u as le,a as ce,E as re,b as $,T as L,s as ue,e as de,p as pe,c as me,f as ye,m as he,C as ge,M as ve,D as fe,h as ke,i as xe,I as be}from"./form.b5017a1b.js";import{d as vo}from"./form.b5017a1b.js";import{S as we,N as Ne}from"./index.7749527f.js";import{a as Te}from"./index.6dee874e.js";import{i as q,u as Ee}from"./zipWith.b37739bd.js";import{o as U}from"./omitBy.e7ddedc3.js";import{d as j}from"./theme.01a3663e.js";import{E as H,z as J,d as W,H as _e,h as Me,A as De,g as Ce,J as D,o as S,b as I,w as O,N as V,R as Pe,l as N,a as Se,B as F,k as Ie,j as Fe,c as Oe}from"./framework.6b67ac47.js";import{a as Ve}from"./index.63550f19.js";import{useMonaco as Ge,Editor as Le}from"./index.9170afa9.js";import{d as ko}from"./data.4983ed38.js";import"./index.013eb64a.js";import"./index.0246ace1.js";import"./index.af03a1c8.js";import"./cloneDeep.707d050f.js";import"./baseSet.c6f802bb.js";import"./initCloneObject.52366613.js";import"./getTag.0b794599.js";import"./baseMap.4525a961.js";import"./merge.0f72b880.js";import"./basePickBy.93df484a.js";import"./pickBy.ee766c69.js";import"./union.a37b7994.js";import"./pick.3451ca24.js";import"./set.d1d08ef6.js";import"./snakeCase.6293e677.js";import"./createCompounder.21553c6c.js";import"./isEqual.d232753d.js";import"./isNil.990ccdb3.js";import"./kebabCase.9388dd24.js";import"./index.c02d6d41.js";import"./use-form-item.2570ef11.js";import"./index.ac500038.js";import"./index.6700b933.js";import"./state-local.dd516420.js";function Be({lf:s,graphData:e,elementData:t,formData:n,formLoading:a,formOption:i,formOptions:r,editorVisible:u,dataOptions:l}){var p,h,g,x,f,m,k,C,P;async function c({data:d,isForce:T}={data:{},isForce:!1}){var w,y,E,M,o,v,z;const b=(w=s.value)==null?void 0:w.graphModel.nodes.find(Z=>Z.type==="process");!d&&(b!=null&&b.id)&&(d=(y=s.value)==null?void 0:y.getNodeDataById(b.id)),!((d==null?void 0:d.id)===((E=t.value)==null?void 0:E.id)&&(d==null?void 0:d.type)===((M=t.value)==null?void 0:M.type)&&!T)&&(d.type!=="process"&&((o=s.value)==null||o.selectElementById(d.id)),a.value=!0,await H(),t.value=d,i.value={menuBtn:!1,span:24,labelPosition:"left",group:((v=r.value)==null?void 0:v[d.type])??ne},n.value={...d.properties,id:d.id,name:((z=d.text)==null?void 0:z.value)||""},a.value=!1)}(p=s.value)==null||p.on("element:click",c),(h=s.value)==null||h.on("blank:click",c),(g=s.value)==null||g.on("node:add",c),(x=s.value)==null||x.on("node:dnd-add",c),(f=s.value)==null||f.on("node:delete",()=>c()),(m=s.value)==null||m.on("history:change",()=>{var d;e.value=(d=s.value)==null?void 0:d.getGraphData()}),(k=s.value)==null||k.on("custom:edit-click",()=>{u.value=!0}),(C=s.value)==null||C.on("custom:reset-form-property",()=>{var d,T;(T=(d=e.value)==null?void 0:d.flowElementList)==null||T.forEach(b=>{var w,y;(w=b.properties)!=null&&w.formProperty&&(b.properties.formProperty=oe(((y=l.value)==null?void 0:y.formPropertyList)||[],[]))}),e.value={...e.value}}),(P=s.value)==null||P.on("custom:reset-button",()=>{var d,T;(T=(d=e.value)==null?void 0:d.flowElementList)==null||T.forEach(b=>{var w,y;(w=b.properties)!=null&&w.button&&(b.properties.button=se(((y=l.value)==null?void 0:y.buttonList)||[],[]))}),e.value={...e.value}})}const Re=K.model,qe=K.view;class Ue extends Re{createId(){return`Note_${ie()}`}initNodeData(e){super.initNodeData(e),this.height=40,this.text.draggable=!1}isAllowConnectedAsSource(){return!1}getNodeStyle(){const e=super.getNodeStyle();return e.strokeDasharray="3 3",e.fill="transparent",e}}class ze extends qe{}const Ae={type:"note",model:Ue,view:ze};class $e extends G.HtmlNodeModel{setAttributes(){this.width=0,this.height=0}}class je extends G.HtmlNode{}const Je={type:"process",model:$e,view:je};class B{constructor({lf:e}){e.definition={},e.useDefinition=le(e.definition),e.register(Je),new we({lf:e}),e.register({...ce(e),type:"startEvent"}),e.register({...re(e),type:"endEvent"}),e.register($("exclusiveGateway",de)),e.register($("parallelGateway",pe)),e.register(L("userTask",me)),e.register(L("serviceTask",ye));const t={d:he,fill:"none",stroke:"black",transform:"scale(30)"};e.register(L("circulateTask",[G.h("path",t)])),e.register({...ue(),type:"sequenceFlow"}),e.register(Ae),e.register(Ne),e.setDefaultEdgeType("sequenceFlow")}}_(B,"pluginName","BpmnElements");class Ke extends ge{constructor({lf:e}){super({lf:e}),[{key:"clear",iconClass:"lf-control-clear",title:"清空",text:"清空",onClick:()=>e.clearData()},{key:"edit",iconClass:"lf-control-edit",title:"编辑",text:"编辑",onClick:()=>e.emit("custom:edit-click",{})},{key:"mini-map",iconClass:"lf-control-mini-map",title:"导航",text:"导航",onClick:()=>{const{isShow:n,show:a,hide:i}=e.extension.miniMap??{};n?i():a()}},{key:"reset",iconClass:"lf-control-reset",title:"重置",text:"重置",onClick:()=>{Te.confirm("选择重置的配置","提示",{confirmButtonText:"重置表单配置",cancelButtonText:"重置按钮配置"}).then(()=>{e.emit("custom:reset-form-property",{})}).catch(()=>{e.emit("custom:reset-button",{})})}}].forEach(n=>this.addItem(n))}}class At{}class He extends ve{constructor({lf:e}){super({lf:e});const t={text:"复制",icon:!0,className:"lf-menu-copy",callback:o=>e.cloneNode(o.id)},n={text:"删除",icon:!0,className:"lf-menu-delete",callback:o=>{e.deleteNode(o.id),e.deleteEdge(o.id)}},a={text:"编辑文本",icon:!0,className:"lf-menu-edit",callback:o=>e.graphModel.editText(o.id)},i={text:"删除文本",icon:!0,className:"lf-menu-delete",callback:o=>e.updateText(o.id,"")},r={text:"框选",icon:!0,className:"lf-menu-select",callback(){e.openSelectionSelect(),e.once("selection:selected",e.closeSelectionSelect)}},u={text:"清空",icon:!0,className:"lf-menu-clear",callback:()=>e.clearData()},l={text:"",icon:!0,className:"lf-menu-back",callback:o=>this.changeMenuList(o,M.nodeMenu)},c={text:"添加",icon:!0,className:"lf-menu-add",callback:o=>{let v=[];switch(o.type){case"startEvent":case"userTask":case"exclusiveGateway":case"parallelGateway":case"circulateTask":v=[l,p,h,g,f,m,x,k];break;case"endEvent":case"sequenceFlow":case"group":case"serviceTask":v=[l,k];break;default:v=[l]}this.changeMenuList(o,v)}},p={text:"用户任务",icon:!0,className:"lf-menu-user-task",callback:o=>this.addNode(o,{type:"userTask",x:o.x+200,y:o.y})},h={text:"服务任务",icon:!0,className:"lf-menu-service-task",callback:o=>this.addNode(o,{type:"serviceTask",x:o.x+200,y:o.y})},g={text:"传阅任务",icon:!0,className:"lf-menu-circulate-task",callback:o=>this.addNode(o,{type:"circulateTask",x:o.x+200,y:o.y})},x={text:"结束",icon:!0,className:"lf-menu-end-event",callback:o=>this.addNode(o,{type:"endEvent",x:o.x+150,y:o.y})},f={text:"互斥网关",icon:!0,className:"lf-menu-exclusive-gateway",callback:o=>this.addNode(o,{type:"exclusiveGateway",x:o.x+150,y:o.y})},m={text:"并行网关",icon:!0,className:"lf-menu-parallel-gateway",callback:o=>this.addNode(o,{type:"parallelGateway",x:o.x+150,y:o.y})},k={text:"注释",icon:!0,className:"lf-menu-note",callback:o=>this.addNode(o,{type:"note",x:o.x,y:o.y-150})},C={text:"切换类型",icon:!0,className:"lf-menu-switch",callback:o=>{let v=[];switch(o.type){case"startEvent":v=[l,d];break;case"endEvent":v=[l,P];break;case"exclusiveGateway":v=[l,T];break;case"parallelGateway":v=[l,b];break;case"userTask":v=[l,y,E];break;case"serviceTask":v=[l,w,E];break;case"circulateTask":v=[l,w,y];break;default:v=[l]}this.changeMenuList(o,v)}},P={text:"开始",icon:!0,className:"lf-menu-start-event",callback:o=>this.changeNodeType(o,"startEvent")},d={text:"结束",icon:!0,className:"lf-menu-end-event",callback:o=>this.changeNodeType(o,"endEvent")},T={text:"并行网关",icon:!0,className:"lf-menu-parallel-gateway",callback:o=>this.changeNodeType(o,"parallelGateway")},b={text:"互斥网关",icon:!0,className:"lf-menu-exclusive-gateway",callback:o=>this.changeNodeType(o,"exclusiveGateway")},w={text:"用户任务",icon:!0,className:"lf-menu-user-task",callback:o=>this.changeNodeType(o,"userTask")},y={text:"服务任务",icon:!0,className:"lf-menu-service-task",callback:o=>this.changeNodeType(o,"serviceTask")},E={text:"传阅任务",icon:!0,className:"lf-menu-circulate-task",callback:o=>this.changeNodeType(o,"circulateTask")},M={nodeMenu:[c,t,n,C,a,i],edgeMenu:[n,a,i],graphMenu:[r,u]};this.setMenuConfig(M)}changeMenuList(e,t){setTimeout(()=>{this.__currentData=e;const{left:n,top:a}=this.__menuDOM.style;this.showMenu(n,a,t)})}addNode(e,t){const n=this.lf.addNode(t),a=["serviceTask","note"].includes(t.type);this.lf.addEdge({type:a?"noteFlow":void 0,sourceNodeId:e.id,targetNodeId:n.id})}changeNodeType(e,t){this.lf.changeNodeType(e.id,t),Object.keys(e.properties||{}).forEach(n=>this.lf.deleteProperty(e.id,n)),this.lf.emit("element:click",{data:{...e,type:t,properties:{}}})}}class We extends fe{constructor({lf:e}){super({lf:e}),this.setPatternItems([{label:"框选",icon:"https://api.iconify.design/bpmn/lasso-tool.svg?width=24&height=24",callback(){e.openSelectionSelect(),e.once("selection:selected",e.closeSelectionSelect)}},{type:"group",label:"子流程",icon:"https://api.iconify.design/bpmn/subprocess-expanded.svg?width=24&height=24"},{type:"startEvent",text:"开始",label:"开始节点",icon:"https://api.iconify.design/bpmn/start-event.svg?width=24&height=24"},{type:"endEvent",text:"结束",label:"结束节点",icon:"https://api.iconify.design/bpmn/end-event.svg?width=24&height=24"},{type:"userTask",label:"用户任务",icon:"https://api.iconify.design/bpmn/user-task.svg?width=24&height=24"},{type:"serviceTask",label:"服务任务",icon:"https://api.iconify.design/bpmn/service-task.svg?width=24&height=24"},{type:"circulateTask",label:"传阅任务",icon:"https://api.iconify.design/bpmn/manual-task.svg?width=24&height=24"},{type:"exclusiveGateway",label:"互斥网关",icon:"https://api.iconify.design/bpmn/gateway-xor.svg?width=24&height=24"},{type:"parallelGateway",label:"并行网关",icon:"https://api.iconify.design/bpmn/gateway-parallel.svg?width=24&height=24"},{type:"note",label:"注释",icon:"https://api.iconify.design/bpmn/text-annotation.svg?width=24&height=24"}])}}class Q{constructor({lf:e}){_(this,"lf");this.lf=e}setStyles(e){e.forEach(({id:t,style:n})=>{var a,i;t&&((i=(a=this.lf)==null?void 0:a.graphModel)==null||i.updateAttributes(t,{style:n}))})}}_(Q,"pluginName","styles");class X{constructor({lf:e}){_(this,"lf");_(this,"container");_(this,"__tooltipDOM");_(this,"__tooltips",[]);this.__tooltipDOM=document.createElement("div"),this.__tooltipDOM.className="lf-tooltips",this.__tooltipDOM.style.position="absolute",this.__tooltipDOM.style.display="none",this.lf=e}render(e,t){this.container=t,t.appendChild(this.__tooltipDOM),e.on("node:mouseenter,edge:mouseenter",({data:n,e:a})=>{var c;const i=(c=this.__tooltips.find(p=>p.id===n.id))==null?void 0:c.content;if(!i)return;this.__tooltipDOM.innerHTML=i;const r=e.getPointByClient(a.x,a.y),{domOverlayPosition:{x:u,y:l}}=r;this.__tooltipDOM.style.top=`${l+10}px`,this.__tooltipDOM.style.left=`${u+10}px`,this.__tooltipDOM.style.display="block"}),e.on("node:mouseleave,edge:mouseleave",()=>{this.__tooltipDOM.style.display="none"})}setTooltips(e){this.__tooltips=e}}_(X,"pluginName","tooltips");const Y={type:"process",key:"Process",properties:{}};function Qe(s){const{id:e,type:t,x:n,y:a,properties:i,children:r,text:u}=s;return{incoming:[],outgoing:[],children:r,type:t,key:e,groupKey:i==null?void 0:i.groupKey,properties:{...i,name:q(u)?u:(u==null?void 0:u.value)??"",x:n,y:a,text:u}}}function Xe(s){const{id:e,type:t,sourceNodeId:n,targetNodeId:a,startPoint:i,endPoint:r,pointsList:u,properties:l,text:c}=s;return{incoming:[n],outgoing:[a],type:t,key:e,groupKey:l==null?void 0:l.groupKey,properties:{...l,name:q(c)?c:(c==null?void 0:c.value)??"",text:c,startPoint:i,endPoint:r,pointsList:u}}}function Ye(s){const{id:e,type:t,properties:n,text:a}=s;return{type:t,key:e,properties:{...n,name:q(a)?a:(a==null?void 0:a.value)??""}}}function Ze(s){const e=new Map,t={processData:Y,flowElementList:[]};return s.nodes.forEach(n=>{var a;if(n.type==="process")t.processData=Ye(n);else{const i=Qe(n);(a=t.flowElementList)==null||a.push(i),e.set(n.id,i)}}),s.edges.forEach(n=>{var u;const a=Xe(n);e.get(n.sourceNodeId).outgoing.push(a.key),e.get(n.targetNodeId).incoming.push(a.key),(u=t.flowElementList)==null||u.push(a)}),t}function et(s){const{incoming:e,outgoing:t,properties:n,key:a,type:i}=s,{text:r,name:u,startPoint:l,endPoint:c,pointsList:p}=n??{},h={id:a,type:i,sourceNodeId:(e==null?void 0:e[0])??"",targetNodeId:(t==null?void 0:t[0])??"",text:r||u,startPoint:l,endPoint:c,pointsList:p,properties:{}},g=["startPoint","endPoint","pointsList","text"];return h.properties=U(n,g),h}function tt(s){const{properties:e,key:t,type:n,children:a}=s,{x:i,y:r,text:u,name:l}=e??{},c={id:t,type:n??"",x:i,y:r,text:u||l,children:a,properties:{}},p=["x","y","text"];return c.properties=U(e,p),c}function ot(s){const{properties:e,key:t,type:n}=s,{name:a}=e??{},i={id:t,type:n??"",text:a,x:0,y:0},r=["x","y","text"];return i.properties=U(e,r),i}function st(s){const{flowElementList:e}=s,t=r=>["sequenceFlow","noteFlow"].includes(r),n=(e==null?void 0:e.filter(r=>!t(r.type)).map(tt))??[],a=(e==null?void 0:e.filter(r=>t(r.type)).map(et))??[];return n.unshift(ot(s.processData??Y)),{nodes:n,edges:a}}class R{constructor({lf:e}){e.adapterIn=this.adapterIn,e.adapterOut=this.adapterOut}adapterOut(e){return Ze(e)}adapterIn(e){return st(e)}}_(R,"pluginName","turboAdapter");function nt({props:s,state:e}){const{lf:t,graphData:n}=e;function a(r){var l;const u=A({container:r,grid:{type:"dot",size:10},nodeTextDraggable:!0,edgeTextDraggable:!0,nodeTextEdit:!0,edgeTextEdit:!0,plugins:[Ke,We,ke,He,xe,be,B,R],edgeGenerator:(c,p)=>{if(["note","serviceTask"].includes(p.type))return"noteFlow"}},s.initOptions);t.value=new G.LogicFlow(u),(l=t.value)==null||l.setTheme(j),Be(e),J(n,c=>{var x,f,m;const p=JSON.stringify(c),h=JSON.stringify((x=t.value)==null?void 0:x.getGraphData());p!==h&&((f=t.value)==null||f.render(c),(m=t.value)==null||m.emit("element:click",{isForce:!0}))},{immediate:!0})}function i(r){var l;const u=A({container:r,grid:{type:"dot",size:10},isSilentMode:!0,plugins:[B,R,X,Q]},s.initOptions);t.value=new G.LogicFlow(u),(l=t.value)==null||l.setTheme(j),J(()=>[n.value,s.styles,s.tooltips],async()=>{var c,p,h,g,x,f,m;(c=t.value)==null||c.render(n.value),await H(),(g=(h=(p=t.value)==null?void 0:p.extension)==null?void 0:h.styles)==null||g.setStyles(s.styles??[]),(m=(f=(x=t.value)==null?void 0:x.extension)==null?void 0:f.tooltips)==null||m.setTooltips(s.tooltips??[])},{immediate:!0})}return{initViewer:i,initModeler:a}}const at=Ie("span",null,"编辑JSON",-1),it=W({__name:"FlowEditor",props:{modelValue:{},visible:{type:Boolean}},emits:["save"],setup(s,{emit:e}){const n=Ve(s),{modelValue:a,visible:i}=n,{monacoRef:r,unload:u}=Ge();_e(()=>!r.value&&u());const l=Me("");function c(){const h=JSON.parse(l.value);a.value=h,e("save",h),i.value=!1}De(()=>{l.value=JSON.stringify(a.value,null,2)});const p=Ce(()=>({defaultLanguage:"json",options:{theme:document.documentElement.className.includes("dark")?"vs-dark":"light",minimap:{enable:!0}}}));return(h,g)=>{const x=D("el-button"),f=D("el-drawer");return S(),I(f,{modelValue:N(i),"onUpdate:modelValue":g[1]||(g[1]=m=>F(i)?i.value=m:null),size:"50%"},{header:O(()=>[at]),default:O(()=>[V(N(Le),Pe({value:l.value,"onUpdate:value":g[0]||(g[0]=m=>l.value=m),width:"100%",height:"100%"},p.value),null,16,["value"]),V(x,{type:"primary",icon:"el-icon-check",style:{position:"absolute",bottom:"20px",right:"20px"},onClick:c},{default:O(()=>[Se(" 保存 ")]),_:1})]),_:1},8,["modelValue"])}}}),lt=["id"],$t=W({__name:"index",props:{lf:{},initOptions:{},modelValue:{},elementData:{},formOptions:{},formData:{},formOption:{},formDefaults:{},formWidth:{},dataOptions:{},type:{},styles:{},tooltips:{}},setup(s){const e=s,t=ae(e),{lf:n,graphData:a,formRef:i,formData:r,formOption:u,formDefaults:l,formLoading:c,editorVisible:p,onUpdateFormData:h}=t,{initModeler:g,initViewer:x}=nt({props:e,state:t}),f=Ee("logicflow-container");return Fe(()=>{const m=document.querySelector(`#${f}`);e.type==="viewer"?x(m):g(m)}),(m,k)=>{const C=D("el-main"),P=D("el-empty"),d=D("el-skeleton"),T=D("avue-form"),b=D("el-aside"),w=D("el-container");return m.type==="viewer"?(S(),Oe("div",{key:0,id:N(f),class:"lf-container"},null,8,lt)):(S(),I(w,{key:1,class:"lf-container"},{default:O(()=>[V(C,{id:N(f),class:"lf-main"},null,8,["id"]),V(b,{class:"lf-aside",width:m.formWidth},{default:O(()=>{var y,E;return[(E=(y=N(u))==null?void 0:y.group)!=null&&E.length?N(c)?(S(),I(d,{key:1})):(S(),I(T,{key:2,ref_key:"formRef",ref:i,modelValue:N(r),"onUpdate:modelValue":[k[0]||(k[0]=M=>F(r)?r.value=M:null),N(h)],defaults:N(l),"onUpdate:defaults":k[1]||(k[1]=M=>F(l)?l.value=M:null),option:N(u)},null,8,["modelValue","defaults","option","onUpdate:modelValue"])):(S(),I(P,{key:0,description:"选择元素以编辑数据"}))]}),_:1},8,["width"]),V(it,{modelValue:N(a),"onUpdate:modelValue":k[2]||(k[2]=y=>F(a)?a.value=y:null),visible:N(p),"onUpdate:visible":k[3]||(k[3]=y=>F(p)?p.value=y:null),onSave:k[4]||(k[4]=y=>{var E;return(E=N(n))==null?void 0:E.render(y)})},null,8,["modelValue","visible"])]),_:1}))}}});export{Kt as AssigneeType,B as BpmnElements,Ke as Control,At as Dagre,$t as FlowDesign,He as Menu,We as Panel,Q as Styles,X as Tooltips,R as TurboAdapter,Ht as assigneeColumn,Wt as baseColumn,Qt as buttonColumn,Xt as circulateColumn,vo as defaultFormProperty,ko as defaultGraphData,ne as defaultGroup,Yt as defaultOptions,j as defaultTheme,Zt as executionListenerColumn,eo as formColumnToDic,to as formPropertyColumn,oo as gatewayColumn,so as injectionKey,se as mergeButton,oe as mergeFormProperty,A as mergeInitOptions,no as multiInstanceColumn,ao as noteColumn,io as processColumn,lo as propertyColumn,co as sequenceFlowColumn,ro as serialColumn,uo as serviceTaskColumn,po as taskListenerColumn,mo as timeLimitColumn,st as toLogicflowData,Ze as toTurboData,nt as useInit,yo as useInjectState,Be as useModelerListener,ae as useProvideState,ho as userTaskColumn};
