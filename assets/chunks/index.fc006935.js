import{c7 as Ce,cj as Y,bw as ee,bx as ce,ck as De}from"../composables_use-crud_index.md.5a3c627a.js";import{_ as xe,a5 as me,a4 as $e,a7 as Ie,a8 as Ue}from"./index.vue_vue_type_script_setup_true_lang.7bd0c7da.js";import{f as L,c as z,D as f,h as _,A as h,u as i,af as T,r as V,i as R,G as d,B as o,k as I,aq as oe,ar as te,F as W,b as H,w as ve,aI as _e,z as J,t as A,C as F,L as le,a1 as we,n as G,al as Oe,d as Ne,j as Me}from"./framework.6c76c79f.js";import{r as Be}from"./axios.4c02e891.js";import{a as Se,_ as Fe}from"./index.vue_vue_type_script_setup_true_lang.ec55a190.js";import{d as Ke}from"./data.ee8ef805.js";import{a as Le}from"../flow-design_flow-modeler_index.md.5ac41c23.js";import{d as Z}from"./theme.22e7a177.js";import{eF as Te}from"../app.7ad6d467.js";import"./vue.runtime.esm-bundler.cd16dfca.js";import"../components_basic-container_index.md.c2902401.js";import"../components_icon-select_index.md.5999308f.js";import"../components_index.md.43b501f2.js";import"../components_v-text_index.md.7d48616e.js";import"../composables_index.md.597fdd4c.js";import"../eslint-config_index.md.4cfe78e4.js";import"../flow-design_flow-viewer_index.md.dfcca5c1.js";import"../flow-design_index.md.3941a9f8.js";import"../flow-pages_flow-manage_index.md.9fb56950.js";import"../flow-pages_flow-template_index.md.91ba6131.js";import"../flow-pages_form-template_index.md.6956dabe.js";import"../flow-pages_index.md.8878ab87.js";import"../flow-pages_workbench_index.md.7ca76f06.js";import"../form-design_demo.md.c49a3eb1.js";import"../form-design_index.md.454afd6f.js";import"../guide_changelog.md.c778465a.js";import"../guide_start.md.af46786e.js";import"../index.md.86a560ec.js";import"../plugins_avue-patch_index.md.24b1b518.js";import"../plugins_env-dts_index.md.bfb63ee5.js";import"../plugins_index.md.f143dffe.js";import"../plugins_load-proxy_index.md.37974852.js";import"../plugins_uni-ui-patch_index.md.9d0386e8.js";import"../plugins_uview-patch_index.md.4541b0e0.js";import"../prettier-config_index.md.5a7d4d11.js";import"../types_avue_index.md.bdb5e61c.js";import"../utils_date_dateFormat.md.95a0ccc9.js";import"../utils_date_durationFormat.md.4812386a.js";import"../utils_emitter_mittAsync.md.06e446b4.js";import"../utils_file_downloadFile.md.443e622e.js";import"../utils_file_getFileName.md.07f04ee5.js";import"../utils_index.md.070bbed1.js";import"../utils_math_index.md.fa407fa4.js";import"../utils_object_filterObj.md.3ea17155.js";import"../utils_object_filterObjDeep.md.6105a7f1.js";import"../utils_object_getDataType.md.af302376.js";import"../utils_string_deserialize.md.df3c79a3.js";import"../utils_string_serialize.md.52ada63d.js";import"../utils_string_uuid.md.3777921e.js";import"../utils_tool_awaitTo.md.3e8c5a8a.js";import"../utils_tool_sleep.md.24e74816.js";import"../utils_tree_buildTree.md.c49d7f11.js";import"../utils_tree_filterTree.md.10578652.js";import"../utils_tree_findTree.md.a798ca70.js";import"../utils_tree_flatTree.md.1269767c.js";import"../utils_tree_treeMap.md.a3a60c1c.js";const Re={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,span:24,column:[{label:"表单标识",prop:"formKey"},{label:"表单名称",prop:"formName"},{label:"表单配置",prop:"formOption",display:!1},{label:"表单备注",prop:"remarks"},{label:"排序",prop:"sort",type:"number"}]},re=L({__name:"index",props:{modelValue:null,view:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:p}){const v=e,r=z({get(){return v.modelValue?me(v.modelValue):{menuBtn:!1,span:24}},set(a){p("update:modelValue",$e(a,{useJson5:!1}))}});return(a,l)=>{const t=f("avue-form");return e.view?(_(),h(t,{key:0,modelValue:{},option:i(r)},null,8,["option"])):(_(),h(i(xe),{key:1,modelValue:i(r),"onUpdate:modelValue":l[0]||(l[0]=n=>T(r)?r.value=n:null)},null,8,["modelValue"]))}}});var je=Be();const Ee=Ce(je),U=Ee.create();U.interceptors.response.use(e=>e.data);function ye(e){return U.get("/sapier-flow/dev-form/list",{params:e})}function Pe(e){return U.post("/sapier-flow/dev-form/submit",e)}function qe(e){return U.post("/sapier-flow/dev-form/submit",e)}function Ae(e){return U.post("/sapier-flow/dev-form/remove",{},{params:{ids:e}})}const We=L({__name:"index",setup(e){const p={rowKey:"id",getList:ye,create:Pe,update:qe,remove:Ae},{bindVal:v,crudStateRefs:{formData:r},getDataList:a,handleUpdate:l}=Y({crudOption:p,tableOption:Re,mockCache:"form-template"});a();const t=V(!1);async function n(c){r.value={...c},t.value=!0}async function w(){await l(r.value,NaN,()=>t.value=!1,()=>{})}return(c,s)=>{const y=f("el-button"),O=f("avue-crud"),g=f("el-dialog");return _(),R(W,null,[d(O,oe(te(i(v))),{formOption:o(({row:u})=>[d(y,{type:"primary",text:"",icon:"el-icon-crop",onClick:m=>n(u)},{default:o(()=>[I("设计")]),_:2},1032,["onClick"])]),_:1},16),d(g,{modelValue:t.value,"onUpdate:modelValue":s[2]||(s[2]=u=>t.value=u),title:`表单设计-${i(r).formName}`,fullscreen:"","destroy-on-close":""},{footer:o(()=>[d(y,{type:"primary",onClick:w},{default:o(()=>[I("保存")]),_:1}),d(y,{onClick:s[1]||(s[1]=u=>t.value=!1)},{default:o(()=>[I("取消")]),_:1})]),default:o(()=>[d(re,{modelValue:i(r).formOption,"onUpdate:modelValue":s[0]||(s[0]=u=>i(r).formOption=u),style:{height:"calc(100vh - 177px)"}},null,8,["modelValue"])]),_:1},8,["modelValue","title"])],64)}}}),Ge={rowKey:"id",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,span:24,column:[{label:"流程标识",prop:"flowKey"},{label:"流程名称",prop:"flowName"},{label:"流程模型数据",prop:"flowData",display:!1},{label:"流程备注",prop:"remarks"},{label:"排序",prop:"sort"}]},ze=Le,ie=L({__name:"index",props:{modelValue:null,view:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:p}){const v=e,r=z({get(){let l=Ke();return typeof v.modelValue=="string"&&v.modelValue?l=JSON.parse(v.modelValue):typeof v.modelValue=="object"&&Object.keys(v.modelValue)&&(l=v.modelValue),l},set(l){p("update:modelValue",JSON.stringify(l))}}),a=V();return H(()=>{var l,t;(l=a.value)==null||l.on("anchor:dragstart",()=>{var n;(n=a.value)==null||n.updateEditConfig({stopMoveGraph:!0})}),(t=a.value)==null||t.on("anchor:dragend",()=>{var n;(n=a.value)==null||n.updateEditConfig({stopMoveGraph:!1})})}),(l,t)=>e.view?(_(),h(i(Se),{key:0,modelValue:i(r),"onUpdate:modelValue":t[0]||(t[0]=n=>T(r)?r.value=n:null)},null,8,["modelValue"])):(_(),h(i(Fe),{key:1,lf:a.value,"onUpdate:lf":t[1]||(t[1]=n=>a.value=n),modelValue:i(r),"onUpdate:modelValue":t[2]||(t[2]=n=>T(r)?r.value=n:null),formOptions:i(ze),formWidth:"30%"},null,8,["lf","modelValue","formOptions"]))}});function ge(e){return U.get("/sapier-flow/dev-flow/list",{params:e})}function Je(e){return U.post("/sapier-flow/dev-flow/submit",e)}function He(e){return U.post("/sapier-flow/dev-flow/submit",e)}function Qe(e){return U.post("/sapier-flow/dev-flow/remove",{},{params:{ids:e}})}const Xe=L({__name:"index",setup(e){const p={rowKey:"id",getList:ge,create:Je,update:He,remove:Qe},{bindVal:v,crudStateRefs:{formData:r},getDataList:a,handleUpdate:l}=Y({crudOption:p,tableOption:Ge,mockCache:"model-template"});a();const t=V(!1);async function n(c){r.value=c,t.value=!0}async function w(){await l(r.value,NaN,()=>t.value=!1,()=>{})}return(c,s)=>{const y=f("el-button"),O=f("avue-crud"),g=f("el-dialog");return _(),R(W,null,[d(O,oe(te(i(v))),{flowData:o(({row:u})=>[d(y,{type:"primary",text:"",icon:"el-icon-crop",onClick:m=>n(u)},{default:o(()=>[I("设计")]),_:2},1032,["onClick"])]),_:1},16),d(g,{modelValue:t.value,"onUpdate:modelValue":s[2]||(s[2]=u=>t.value=u),title:`模型设计-${i(r).flowName}`,fullscreen:"","destroy-on-close":""},{footer:o(()=>[d(y,{type:"primary",onClick:w},{default:o(()=>[I("保存")]),_:1}),d(y,{onClick:s[1]||(s[1]=u=>t.value=!1)},{default:o(()=>[I("取消")]),_:1})]),default:o(()=>[d(ie,{modelValue:i(r).flowData,"onUpdate:modelValue":s[0]||(s[0]=u=>i(r).flowData=u),style:{height:"calc(100vh - 177px)"}},null,8,["modelValue"])]),_:1},8,["modelValue","title"])],64)}}});function Ye(e){return U.get("/sapier-flow/flow-category/list",{params:e})}function Ze(e){return U.post("/sapier-flow/flow-category/save",e)}function el(e){return U.post("/sapier-flow/flow-category/update",e)}function ll(e){return U.post("/sapier-flow/flow-category/remove",{},{params:{ids:e}})}const fe={defaultExpandAll:!0,props:{label:"name",value:"id"},filter:!0,formOption:{column:[{label:"分类名称",prop:"name",rules:[{required:!0,message:"请输入分类名称"}]},{label:"描述",prop:"remark"}]}},ol=L({__name:"index",emits:["node-click"],setup(e,{emit:p}){const v={rowKey:"id",getList:Ye,create:Ze,update:el,remove:ll,dataPath:"res.data"},{crudStateRefs:{formData:r,tableData:a},getDataList:l,handleSave:t,handleUpdate:n,handleDel:w}=Y({crudOption:v,tableOption:fe,pageOption:{pageSize:20},mockCache:"flow-category"});l();function c(O,g,u,m){t(g,u,m)}function s(O,g,u,m){n(g,NaN,u,m)}function y(O){w(O,NaN)}return(O,g)=>{const u=f("avue-tree");return _(),h(u,{modelValue:i(r),"onUpdate:modelValue":g[0]||(g[0]=m=>T(r)?r.value=m:null),option:i(fe),data:i(a),onNodeClick:g[1]||(g[1]=m=>p("node-click",m)),onSave:c,onUpdate:s,onDel:y},null,8,["modelValue","option","data"])}}}),se={menuBtn:!1,span:24,column:[{label:"流程名称",prop:"flowName",rules:[{required:!0,message:"请输入流程名称"}]},{label:"流程标识",prop:"flowKey",rules:[{required:!0,message:"请输入流程标识"}]},{label:"流程分类",prop:"groupId",type:"select",dicUrl:"/sapier-flow/flow-category/list",props:{label:"name",value:"id"}},{label:"流程图标",prop:"icon",component:"icon-select"},{label:"流程描述",prop:"remarks"}]};function tl(e){return U.get("/sapier-flow/flow-definition/list",{params:e})}function be(e){return U.get("/sapier-flow/flow-definition/detail",{params:e})}function al(e){return U.post("/sapier-flow/flow-definition/save",e)}function nl(e){return U.post("/sapier-flow/flow-definition/update",e)}function Ve(e){return U.post("/sapier-flow/flow-definition/deployFlow",e)}function ul(e){return U.get("/sapier-flow/flow-deploy/list",{params:e})}function ke(e){return U.get("/sapier-flow/flow-deploy/detail",{params:e})}function he(e){return U.post("/sapier-flow/flow-deploy/update",e)}function rl(){return U.get("/sapier-flow/flow-run/queryPublishFlowList")}function de(e){return new Promise((p,v)=>{(T(e)?e.value:e).validate((a,l)=>{a?(l(),p(a)):v(a)})})}const il=J("span",null,"流程设计",-1),sl={key:0},dl={key:1},pl={style:{height:"calc(100vh - 144px)"}},fl=L({__name:"index",props:{modelValue:null,visible:{type:Boolean}},emits:["close"],setup(e,{emit:p}){const r=Z(e),{visible:a,modelValue:l}=r,t=["流程信息","表单设计","模型设计","完成"],n=V(!1);ve(a,async $=>{if(!$)return;const{flowModuleId:b}=l.value,{flowDeployId:B}=l.value;try{n.value=!0;let j={};B?j=await ke({flowDeployId:B}):b&&(j=await be({flowModuleId:b})),l.value=j.data}finally{n.value=!1}},{immediate:!0});const w=V([]),c=V([]);ye({size:-1}).then($=>w.value=$.data.records),ge({size:-1}).then($=>c.value=$.data.records);const s=V(0),y=z(()=>{var $,b;return s.value===1?(($=w.value)==null?void 0:$.map(B=>({label:B.formName,value:B.formOption})))??[]:s.value===2?((b=c.value)==null?void 0:b.map(B=>({label:B.flowName,value:B.flowData})))??[]:[]});function O($){s.value===1?l.value.formOption=$.value:s.value===2&&(l.value.flowData=$.value)}const g=V();async function u($){s.value===0&&await de(g),n.value=!0;const{flowModuleId:b}=l.value,{flowDeployId:B}=l.value;try{B?await he(l.value):b?await nl(l.value):await al(l.value).then(j=>{l.value.flowModuleId=j.data.flowModuleId}),ee.success("保存成功")}finally{n.value=!1}typeof $=="number"?s.value=$:s.value++}async function m(){await ce.confirm("发布新版本，是否确认？","提示"),n.value=!0,Ve({flowModuleId:l.value.flowModuleId}).then(()=>{ee.success("发布成功")}).finally(()=>{n.value=!1})}function k(){a.value=!1,s.value=0,l.value={},p("close")}return($,b)=>{const B=f("el-link"),j=f("el-dropdown-item"),Q=f("el-dropdown-menu"),N=f("el-dropdown"),D=f("el-col"),K=f("el-step"),M=f("el-steps"),C=f("el-button"),S=f("el-row"),q=f("avue-form"),E=f("el-result"),P=f("el-dialog"),ae=_e("loading");return _(),h(P,{modelValue:i(a),"onUpdate:modelValue":b[4]||(b[4]=x=>T(a)?a.value=x:null),fullscreen:"","show-close":!1,onClose:k},{header:o(()=>[d(S,{align:"center",justify:"center"},{default:o(()=>[d(D,{span:5},{default:o(()=>{var x,X,ne,pe;return[J("div",null,[il,(x=i(l))!=null&&x.flowName?(_(),R("span",sl," - "+A((X=i(l))==null?void 0:X.flowName),1)):F("",!0),(ne=i(l))!=null&&ne.version?(_(),R("span",dl," - V"+A((pe=i(l))==null?void 0:pe.version),1)):F("",!0)]),i(y).length?(_(),h(N,{key:0},{dropdown:o(()=>[d(Q,null,{default:o(()=>[(_(!0),R(W,null,le(i(y),ue=>(_(),h(j,{key:ue.label,onClick:Ul=>O(ue)},{default:o(()=>[I(A(ue.label),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),default:o(()=>[d(B,{icon:"el-icon-arrow-down",underline:!1},{default:o(()=>[I("选择模板")]),_:1})]),_:1})):F("",!0)]}),_:1}),d(D,{span:14},{default:o(()=>[d(M,{active:s.value,simple:"","process-status":"finish","finish-status":"success"},{default:o(()=>[(_(),R(W,null,le(t,(x,X)=>d(K,{key:X,title:x,onClick:ne=>u(X)},null,8,["title","onClick"])),64))]),_:1},8,["active"])]),_:1}),d(D,{span:5,style:{"text-align":"right"}},{default:o(()=>[d(C,{disabled:s.value===0,loading:n.value,type:"primary",onClick:b[0]||(b[0]=x=>s.value--)},{default:o(()=>[I(" 上一步 ")]),_:1},8,["disabled","loading"]),d(C,{disabled:s.value===t.length-1,type:"primary",loading:n.value,onClick:u},{default:o(()=>[I(" 下一步 ")]),_:1},8,["disabled","loading"]),d(C,{onClick:k},{default:o(()=>[I("关闭")]),_:1})]),_:1})]),_:1})]),default:o(()=>[we((_(),R("div",pl,[s.value===0?(_(),h(q,{key:0,ref_key:"formRef",ref:g,modelValue:i(l),"onUpdate:modelValue":b[1]||(b[1]=x=>T(l)?l.value=x:null),option:i(se),style:{width:"50%",magin:"0 auto"}},null,8,["modelValue","option"])):F("",!0),s.value===1?(_(),h(re,{key:1,modelValue:i(l).formOption,"onUpdate:modelValue":b[2]||(b[2]=x=>i(l).formOption=x)},null,8,["modelValue"])):F("",!0),s.value===2?(_(),h(ie,{key:2,modelValue:i(l).flowData,"onUpdate:modelValue":b[3]||(b[3]=x=>i(l).flowData=x)},null,8,["modelValue"])):F("",!0),s.value===3?(_(),h(E,{key:3,icon:"success",title:"流程设计完成"},{extra:o(()=>[i(l).flowDeployId?F("",!0):(_(),h(C,{key:0,type:"primary",onClick:m},{default:o(()=>[I("发布")]),_:1})),d(C,{onClick:k},{default:o(()=>[I("关闭")]),_:1})]),_:1})):F("",!0)])),[[ae,n.value]])]),_:1},8,["modelValue"])}}}),cl=J("span",null,"流程查看",-1),ml={key:0},vl={key:1},_l=L({__name:"index",props:{modelValue:null,visible:{type:Boolean}},setup(e){const v=Z(e),{visible:r,modelValue:a}=v,l=V("form"),t=V(!1);ve(r,async w=>{if(!w)return;const{flowModuleId:c}=a.value,{flowDeployId:s}=a.value;try{t.value=!0;let y={};s?y=await ke({flowDeployId:s}):c&&(y=await be({flowModuleId:c})),a.value={...y.data}}finally{t.value=!1}},{immediate:!0});function n(){a.value={},l.value="form"}return(w,c)=>{const s=f("el-tab-pane"),y=f("el-tabs"),O=f("el-dialog"),g=_e("loading");return _(),h(O,{modelValue:i(r),"onUpdate:modelValue":c[3]||(c[3]=u=>T(r)?r.value=u:null),width:"60%",top:"0",onClose:n},{header:o(()=>{var u,m,k,$;return[cl,(u=i(a))!=null&&u.flowName?(_(),R("span",ml," - "+A((m=i(a))==null?void 0:m.flowName),1)):F("",!0),(k=i(a))!=null&&k.version?(_(),R("span",vl," - V"+A(($=i(a))==null?void 0:$.version),1)):F("",!0)]}),default:o(()=>[we((_(),h(y,{modelValue:l.value,"onUpdate:modelValue":c[2]||(c[2]=u=>l.value=u)},{default:o(()=>[d(s,{label:"查看表单",name:"form",style:{height:"600px","overflow-y":"auto"}},{default:o(()=>[l.value==="form"&&i(a).formOption?(_(),h(re,{key:0,ref:"formRef",modelValue:i(a).formOption,"onUpdate:modelValue":c[0]||(c[0]=u=>i(a).formOption=u),view:""},null,8,["modelValue"])):F("",!0)]),_:1}),d(s,{label:"查看流程",name:"flow",style:{height:"600px"}},{default:o(()=>[l.value==="flow"?(_(),h(ie,{key:0,modelValue:i(a).flowData,"onUpdate:modelValue":c[1]||(c[1]=u=>i(a).flowData=u),view:""},null,8,["modelValue"])):F("",!0)]),_:1})]),_:1},8,["modelValue"])),[[g,t.value]])]),_:1},8,["modelValue"])}}}),wl={rowKey:"flowModuleId",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,tabs:!0,dialogFullscreen:!0,addBtn:!1,editBtn:!1,delBtn:!1,menuWidth:300,column:[...se.column,{label:"流程主版本",prop:"mainVersion",formatter(e,p){return p?`V${p||""}`:""}}]},yl=L({__name:"index",props:{groupId:null},emits:["add","view","edit","version"],setup(e,{emit:p}){const v=e,r={rowKey:"flowModuleId",getList:tl},{bindVal:a,crudStateRefs:{searchForm:l},getDataList:t}=Y({crudOption:r,tableOption:wl,searchForm:{groupId:v.groupId}});H(()=>{l.value.groupId=v.groupId??"",t()});const n=V(!1);async function w(c){await ce.confirm("发布新版本，是否确认？","提示",{type:"success"}),n.value=!0,Ve({flowModuleId:c.flowModuleId}).then(()=>{ee.success("部署成功"),t()}).finally(()=>{n.value=!1})}return(c,s)=>{const y=f("el-button"),O=f("avue-crud");return _(),h(O,oe(te(i(a))),{"menu-left":o(()=>[d(y,{type:"primary",icon:"el-icon-plus",onClick:s[0]||(s[0]=g=>p("add"))},{default:o(()=>[I("新增")]),_:1})]),menu:o(({row:g})=>[d(y,{loading:n.value,type:"text",icon:"el-icon-view",onClick:u=>p("view",g)},{default:o(()=>[I(" 查看 ")]),_:2},1032,["loading","onClick"]),d(y,{loading:n.value,type:"text",icon:"el-icon-edit",onClick:u=>p("edit",g)},{default:o(()=>[I(" 编辑 ")]),_:2},1032,["loading","onClick"]),d(y,{loading:n.value,type:"text",icon:"el-icon-upload",onClick:u=>w(g)},{default:o(()=>[I(" 发布 ")]),_:2},1032,["loading","onClick"]),d(y,{loading:n.value,type:"text",icon:"el-icon-switch",onClick:u=>p("version",g)},{default:o(()=>[I(" 版本管理 ")]),_:2},1032,["loading","onClick"])]),_:1},16)}}}),gl={rowKey:"flowDeloyId",align:"center",index:!0,border:!0,stripe:!0,searchMenuSpan:4,tabs:!0,dialogFullscreen:!0,addBtn:!1,editBtn:!1,delBtn:!1,menuWidth:250,column:[...se.column,{label:"流程版本",prop:"version",formatter(e,p){return p?`V${p||""}`:""}},{label:"是否主版本",prop:"mainVersion",type:"select",dicData:[{label:"否",value:0},{label:"是",value:1}]}]},bl=L({__name:"index",props:{flowModuleId:null},emits:["back","view","edit"],setup(e,{emit:p}){const v=e,r={rowKey:"flowDeloyId",getList:ul,dataPath:"res.data"},{bindVal:a,crudStateRefs:{searchForm:l},getDataList:t}=Y({crudOption:r,tableOption:gl});H(()=>{v.flowModuleId&&(l.value.flowModuleId=v.flowModuleId,t())});const n=V(!1);function w(c){n.value=!0,he({flowDeployId:c.flowDeployId,flowModuleId:c.flowModuleId,mainVersion:1}).then(()=>{ee.success("设置成功"),t()}).finally(()=>{n.value=!1})}return(c,s)=>{const y=f("el-button"),O=f("avue-crud");return _(),h(O,oe(te(i(a))),{"menu-left":o(()=>[d(y,{loading:n.value,type:"primary",icon:"el-icon-arrow-left",onClick:s[0]||(s[0]=g=>p("back"))},{default:o(()=>[I("返回")]),_:1},8,["loading"])]),menu:o(({row:g})=>[d(y,{loading:n.value,type:"text",icon:"el-icon-view",onClick:u=>p("view",g)},{default:o(()=>[I(" 查看 ")]),_:2},1032,["loading","onClick"]),d(y,{loading:n.value,type:"text",icon:"el-icon-edit",onClick:u=>p("edit",g)},{default:o(()=>[I(" 编辑 ")]),_:2},1032,["loading","onClick"]),d(y,{loading:n.value,disabled:g.mainVersion===1,type:"text",icon:"el-icon-switch",onClick:u=>w(g)},{default:o(()=>[I(" 设为主版本 ")]),_:2},1032,["loading","disabled","onClick"])]),_:1},16)}}}),Vl=L({__name:"index",setup(e){const p=V("definition"),v=V({}),r=V(""),a=V("");function l(u){r.value===u.id?r.value="":r.value=u.id}const t=V(!1),n=V(!1);function w(){v.value={},t.value=!0}function c(u){v.value=u,t.value=!0}function s(u){v.value=u,n.value=!0}function y(u){a.value=u.flowModuleId||"",p.value="deploy"}function O(){a.value="",p.value="definition"}async function g(){const u=p.value;await G(),p.value="",await G(),p.value=u+""}return(u,m)=>{const k=f("el-col"),$=f("el-row");return _(),h($,{gutter:20},{default:o(()=>[d(k,{span:4},{default:o(()=>[d(ol,{onNodeClick:l})]),_:1}),d(k,{span:20},{default:o(()=>[p.value==="definition"?(_(),h(yl,{key:0,groupId:r.value,onAdd:w,onEdit:c,onView:s,onVersion:y},null,8,["groupId"])):F("",!0),p.value==="deploy"?(_(),h(bl,{key:1,flowModuleId:a.value,onEdit:c,onView:s,onBack:O},null,8,["flowModuleId"])):F("",!0),d(fl,{modelValue:v.value,"onUpdate:modelValue":m[0]||(m[0]=b=>v.value=b),visible:t.value,"onUpdate:visible":m[1]||(m[1]=b=>t.value=b),onClose:g},null,8,["modelValue","visible"]),d(_l,{modelValue:v.value,"onUpdate:modelValue":m[2]||(m[2]=b=>v.value=b),visible:n.value,"onUpdate:visible":m[3]||(m[3]=b=>n.value=b)},null,8,["modelValue","visible"])]),_:1})]),_:1})}}});function kl(e){return U.get("/sapier-flow/flow-run/queryPublishFlowDetail",{params:e})}function hl(e){return U.post("/sapier-flow/flow-run/startProcess",e)}function Cl(e){return U.post("/sapier-flow/flow-run/queryApprovalNode",e)}const Dl=L({props:{modelValue:{type:Object,default:()=>({})},flowDetail:{type:Object,default:()=>({})},detail:{type:Boolean}},setup(e){const{modelValue:p}=Z(e,void 0,{passive:!0,deep:!0}),v=V({}),{proxy:r}=Ne(),a=V({});H(()=>{const{formOption:n}=e.flowDetail.process??{};a.value=me.bind(r)(n||'{"menuBtn":false}'),a.value.detail=!!e.detail});const l=V();function t(){return de(l)}return{form:p,option:a,defaults:v,formRef:l,validate:t}},render(){return Oe(f("avue-form"),{ref:"formRef",modelValue:this.form,defaults:this.defaults,option:this.option,"onUpdate:modelValue":e=>this.form=e,"onUpdate:defaults":e=>this.defaults=e})}}),xl=L({__name:"approval-form",props:{modelValue:null,visible:{type:Boolean},flowDetail:null},emits:["confirm"],setup(e,{emit:p}){const v=e,r={element:"ep:flag",post:"ep:share",dept:"ep:share",user:"ep:user"},a=Z(v),{modelValue:l,visible:t,flowDetail:n}=a,w=V([]),c=V({approver:[],copyUser:"",comment:""}),s=V(),y=V({}),O={menuBtn:!1,labelWidth:70,column:[{label:"审批人",prop:"approver",span:24,rules:[{required:!0,validator:g}]},{label:"意见",prop:"comment",span:24,rules:[{required:!0,message:"请填写意见"}]}]};function g(N,D,K){var S;const M=w.value[0].type==="ParallelGateway",C=(S=w.value[0].children)==null?void 0:S.every(q=>Ie([q],E=>D.some(P=>P.id===E.id)));if(D.length){if(M&&!C)return K("请在每个节点选择审批人")}else return K("请选择审批人");return!0}const u=V(!0),m=V(!1),k=z(()=>Object.entries(l.value||{}).filter(([N])=>!N.startsWith("$")).map(([N,D])=>({key:N,value:D}))),$=z(()=>w.value[0]);H(async()=>{var M,C;if(!t.value||!s.value)return;const{taskId:N,flowKey:D}=((M=n.value)==null?void 0:M.process)||{},K=N?"":"发起";if(w.value=[],c.value={approver:[],copyUser:"",comment:l.value.comment||K},G(()=>{}),u.value){await Cl({flowKey:D,variables:k.value}).then(q=>{w.value=Ue(q.data??[],E=>{const P=E.id||De();return{...E,id:P,disabled:E.type!=="user"}})}),await G();const S=b(w.value);S&&((C=B.value)==null||C.setCheckedNodes([S]))}});function b(N){var D;if(N.length===1)return(D=N[0].children)!=null&&D.length?b(N[0].children):N[0]}const B=V();async function j(N,D){var M,C;if(N.type!=="user")return;await G(),await G();const K=(M=B.value)==null?void 0:M.getCheckedNodes();c.value.approver=K.filter(S=>S.type==="user"),(C=B.value)==null||C.setCheckedNodes(c.value.approver)}async function Q(){await de(s),m.value=!0;const{approver:N,copyUser:D,comment:K}=c.value,M={},C={},{taskNodeKey:S,outgoing:q,incoming:E}=$.value;N.forEach(P=>{M[S]||(M[S]=new Set),P.userId&&M[S].add(P.userId),C[S]=[...M[S]].join(",")}),l.value.assignee=C,l.value.comment=K,l.value.outgoing=q,l.value.incoming=E,console.log("🚀 ~ file: approval-form.vue:210 ~ onConfirm ~ formData:",l),p("confirm")}return(N,D)=>{const K=f("el-tree"),M=f("el-col"),C=f("el-tag"),S=f("el-input"),q=f("avue-form"),E=f("el-row"),P=f("el-button"),ae=f("el-dialog");return _(),h(ae,{modelValue:i(t),"onUpdate:modelValue":D[4]||(D[4]=x=>T(t)?t.value=x:null),width:u.value?"800px":"500px","append-to-body":""},{footer:o(()=>[d(P,{onClick:D[3]||(D[3]=x=>t.value=!1)},{default:o(()=>[I("取 消")]),_:1}),d(P,{type:"primary",loading:m.value,onClick:Q},{default:o(()=>[I("确 定")]),_:1},8,["loading"])]),default:o(()=>[d(E,{gutter:20},{default:o(()=>[u.value?(_(),h(M,{key:0,span:10},{default:o(()=>[d(K,{ref_key:"treeRef",ref:B,class:"approval-tree","w-full":"","h-400px":"","overflow-y-scroll":"","node-key":"id","empty-text":"无需选择审批人","default-expand-all":"","show-checkbox":"","check-on-click-node":"",data:w.value,onCheckChange:j},{default:o(({data:x})=>[J("div",null,[d(i(Te),{icon:r[x.type],style:{display:"inline-block"}},null,8,["icon"]),J("span",null,A(x.title),1)])]),_:1},8,["data"])]),_:1})):F("",!0),d(M,{span:u.value?14:24},{default:o(()=>[d(q,{ref_key:"formRef",ref:s,modelValue:c.value,"onUpdate:modelValue":D[1]||(D[1]=x=>c.value=x),defaults:y.value,"onUpdate:defaults":D[2]||(D[2]=x=>y.value=x),option:O},{approver:o(()=>[(_(!0),R(W,null,le(c.value.approver,x=>(_(),h(C,{key:x.id,type:"info"},{default:o(()=>[I(A(x.title),1)]),_:2},1024))),128))]),copyUser:o(()=>[]),comment:o(()=>[d(S,{modelValue:c.value.comment,"onUpdate:modelValue":D[0]||(D[0]=x=>c.value.comment=x),type:"textarea"},null,8,["modelValue"])]),_:1},8,["modelValue","defaults"])]),_:1},8,["span"])]),_:1})]),_:1},8,["modelValue","width"])}}}),$l=L({__name:"index",props:{flowKey:null,visible:{type:Boolean},flowDetail:null,processDetail:null,modelValue:null,formOption:null,loading:{type:Boolean},activeTab:null},setup(e){const p=e,v=Z(p,void 0,{passive:!0,deep:!0}),{visible:r,flowDetail:a,processDetail:l,modelValue:t,loading:n,activeTab:w}=v;function c(m){w.value="form",a.value={},t.value={},m==null||m()}H(()=>{const{flowKey:m}=p;m&&r.value&&(c(),n.value=!0,kl({flowKey:m}).then(k=>{a.value=k.data,l.value=k.data.process,t.value=k.data.formData||{}}).finally(()=>{n.value=!1}))});const s=V(!1),y=z(()=>Object.entries(t.value||{}).filter(([m])=>!m.startsWith("$")).map(([m,k])=>({key:m,value:k}))),O=V();async function g(){var m;await((m=O.value)==null?void 0:m.validate()),s.value=!0}function u(){var m,k,$,b;hl({flowDeployId:(m=l.value)==null?void 0:m.flowDeployId,variables:y.value,assignee:(k=t.value)==null?void 0:k.assignee,outgoing:($=t.value)==null?void 0:$.outgoing,incoming:(b=t.value)==null?void 0:b.incoming})}return(m,k)=>{var M;const $=f("el-skeleton"),b=f("el-button"),B=f("el-header"),j=f("el-tab-pane"),Q=f("el-tabs"),N=f("el-main"),D=f("el-container"),K=f("el-drawer");return _(),h(K,{modelValue:i(r),"onUpdate:modelValue":k[4]||(k[4]=C=>T(r)?r.value=C:null),title:(M=i(l))==null?void 0:M.flowName,"destroy-on-close":"","before-close":c,size:"60%"},{default:o(()=>[i(n)?(_(),h($,{key:0})):(_(),h(D,{key:1},{default:o(()=>[d(B,{height:"40px",style:{padding:"0"}},{default:o(()=>[d(b,{type:"primary",onClick:g},{default:o(()=>[I("发送")]),_:1})]),_:1}),d(N,{style:{padding:"0"}},{default:o(()=>[d(Q,{modelValue:i(w),"onUpdate:modelValue":k[1]||(k[1]=C=>T(w)?w.value=C:null)},{default:o(()=>{var C;return[(C=i(l))!=null&&C.formPath?Me(m.$slots,"default",{key:0}):(_(),h(j,{key:1,label:"审批信息",name:"form"},{default:o(()=>[d(Dl,{ref_key:"formRef",ref:O,modelValue:i(t),"onUpdate:modelValue":k[0]||(k[0]=S=>T(t)?t.value=S:null),flowDetail:i(a)},null,8,["modelValue","flowDetail"])]),_:1}))]}),_:3},8,["modelValue"])]),_:3})]),_:3})),d(xl,{modelValue:i(t),"onUpdate:modelValue":k[2]||(k[2]=C=>T(t)?t.value=C:null),visible:s.value,"onUpdate:visible":k[3]||(k[3]=C=>s.value=C),flowDetail:i(a),onConfirm:u},null,8,["modelValue","visible","flowDetail"])]),_:3},8,["modelValue","title"])}}}),Il=L({__name:"index",setup(e){const p=V([]);rl().then(l=>{p.value=l.data});const v=V(!1),r=V("");function a(l){r.value=l.flowKey,v.value=!0}return(l,t)=>{const n=f("el-button");return _(),R(W,null,[J("div",null,[(_(!0),R(W,null,le(p.value,w=>(_(),h(n,{key:w.flowKey,type:"primary",plain:"",onClick:c=>a(w)},{default:o(()=>[I(A(w.flowName),1)]),_:2},1032,["onClick"]))),128))]),d($l,{visible:v.value,"onUpdate:visible":t[0]||(t[0]=w=>v.value=w),flowKey:r.value},null,8,["visible","flowKey"])],64)}}}),Bo={install(e){e.component("FormTemplate",We),e.component("FlowTemplate",Xe),e.component("FlowManage",Vl),e.component("Workbench",Il)}};export{Vl as FlowManage,Xe as FlowTemplate,We as FormTemplate,Il as Workbench,Bo as default};
