import"./index.a2682797.js";import{o as Q}from"./omit.28986d82.js";import{o as W,a as $,s as X}from"./snakeCase.65aa62e9.js";import{w as Y,ah as Z,r as _,af as ee,b as ae}from"./framework.87994f31.js";import{m as te,E as B,a as x}from"./index.05b719a1.js";import{o as V}from"./omitBy.dee5f82d.js";import{D as q,F as I}from"./index.4aada9e5.js";import{c as z}from"./dayjs.min.80392c58.js";function re(a){return{all:a=a||new Map,on:function(t,s){var o=a.get(t);o?o.push(s):a.set(t,[s])},off:function(t,s){var o=a.get(t);o&&(s?o.splice(o.indexOf(s)>>>0,1):a.set(t,[]))},emit:function(t,s){var o=a.get(t);o&&o.slice().map(function(c){c(s)}),(o=a.get("*"))&&o.slice().map(function(c){c(t,s)})}}}function se(a){const t=re(a);return t.emitAsync=async function(s,o){const c=this.all.get(s);if(c)for(const i of c)await i(o);const n=this.all.get("*");if(n)for(const i of n)await i(s,o)},t}function oe(a=16,t){const s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",o=t||s.length,c=[];for(let n=0;n<a;n++)c[n]=s.charAt(Math.random()*o);return c.join("")}function Ce(a){const t=[];return Object.keys(a).forEach(s=>{t.push(`${s}=${a[s]}`)}),t.join("&")}function ne(a){return new Promise(t=>setTimeout(t,a))}function ce(a,t){return a.then(s=>[null,s]).catch(s=>t?[Object.assign({},s,t),void 0]:[s,void 0])}const A=ce;function ve(a,t){const{label:s="label",value:o="value"}=t||{};return Object.entries(a).map(([c,n])=>({[s]:c,[o]:n})).filter(c=>Number.isNaN(Number(c[s])))}function ie({crudState:a}){if(a.mockCache)try{const i=`mock-${a.mockCache}`,f=localStorage.getItem(i);a.mockData=f?JSON.parse(f):a.mockData,Y(()=>a.mockData,()=>localStorage.setItem(i,JSON.stringify(a.mockData)),{immediate:!0,deep:!0})}catch(n){console.log(n)}function t(n){const{currKey:i,sizeKey:f}=a.crudOption,C=n[i],O=n[f],{descs:L,ascs:b}=n,K=Q(n,[i,f,"descs","ascs"]),P=a.mockData.filter(v=>Object.entries(K).every(([D,U])=>typeof v[D]=="string"?v[D].includes(U):v[D]==U)),F=W(P,L||b||void 0,L?"desc":b?"asc":void 0).filter((v,D)=>D>=(C-1)*O&&D<C*O);return Promise.resolve({code:200,msg:"操作成功",data:{records:F,total:P.length}})}function s(n){const{crudOption:{rowKey:i}}=a;return a.mockData.push({[i]:oe(16,10),...n}),Promise.resolve({code:200,msg:"操作成功"})}function o(n){const{crudOption:{rowKey:i}}=a;return a.mockData=a.mockData.map(f=>f[i]===n[i]?n:f),Promise.resolve({code:200,msg:"操作成功"})}function c(n){const{crudOption:{rowKey:i}}=a;if(typeof n=="string"){const f=n.split(",");a.mockData=a.mockData.filter(C=>!f.some(O=>O==C[i]))}else a.mockData=a.mockData.filter(f=>n!=f[i]);return Promise.resolve({code:200,msg:"操作成功"})}return{getList:t,create:s,update:o,remove:c}}function fe(a){var i;const t=Z(te({crudOption:{rowKey:((i=a==null?void 0:a.tableOption)==null?void 0:i.rowKey)??"id",getList:f=>s(f),create:f=>o(f),update:f=>c(f),remove:f=>n(f),dataPath:"res.data.records",totalPath:"res.data.total",currKey:"current",sizeKey:"size",isPage:!0,isSort:!0,delConfirm:!0,clearSelection:!0,saveSuccessMsg:"保存成功",updateSuccessMsg:"保存成功",delSuccessMsg:"删除成功"},pageOption:{total:0,currentPage:1,pageSize:10},sortOption:{},tableLoading:!1,tableOption:{},tableData:[],dataSelections:[],searchForm:{},queryForm:{},formData:{},formType:"",defaults:{},mockData:[],mockCache:""},a)),{getList:s,create:o,update:c,remove:n}=ie({crudState:t});return t}function le({crudRef:a,crudState:t,emitter:s,options:o}){const c=o.getDataList??(async()=>{var R,N;const{dataPath:e,totalPath:r,currKey:h,sizeKey:l,isPage:u,isSort:g,clearSelection:y}=t.crudOption,{currentPage:m,pageSize:p}=t.pageOption,w=u?{[h]:m,[l]:p}:{},H=g?t.sortOption:{},G=z({...t.searchForm,...w,...H,...t.queryForm}),[T]=await A(s.emitAsync("beforeGetList",G));if(T!==null)return;const{getList:E}=t.crudOption;if(E){t.tableLoading=!0,await ne(100);try{const k=await E(K(G));console.log("getDataList ~ res",k),t.tableData=q({res:k},e,[]),t.pageOption.total=q({res:k},r,0),await s.emitAsync("afterGetList",k)}catch(k){console.error("getDataList ~ err",k),t.tableData=[],t.pageOption.total=0}finally{y&&((N=(R=a==null?void 0:a.value)==null?void 0:R.selectClear)==null||N.call(R)),t.tableLoading=!1}}}),n=o.handleSave??(async(e,r,h)=>{const l=z({...t.formData,...e}),[u]=await A(s.emitAsync("beforeSave",l)),[g]=await A(s.emitAsync("beforeSubmit",l));if(u!==null||g!==null)return h==null?void 0:h();const{rowKey:y,create:m,saveSuccessMsg:p}=t.crudOption;if(!m)return h==null?void 0:h();delete l[y];try{const w=await m(b(l));return p&&B.success(p),await s.emitAsync("afterSave",w),await s.emitAsync("afterSubmit",w),r==null||r(),c()}catch(w){console.error("handleSave ~ err",w),h==null||h()}}),i=o.handleUpdate??(async(e,r,h,l)=>{const u=z({...t.formData,...e}),[g]=await A(s.emitAsync("beforeUpdate",u)),[y]=await A(s.emitAsync("beforeSubmit",u));if(g!==null||y!==null)return l==null?void 0:l();const{update:m,updateSuccessMsg:p}=t.crudOption;if(!m)return l==null?void 0:l();try{const w=await m(b(u));return p&&B.success(p),await s.emitAsync("afterUpdate",w),await s.emitAsync("afterSubmit",w),h==null||h(),c()}catch(w){console.error("handleUpdate ~ err",w),l==null||l()}}),f=o.handleDel??(async e=>{const r=z(e),[h]=await A(s.emitAsync("beforeDel",r));if(h!==null)return;const{rowKey:l,remove:u,delConfirm:g,delSuccessMsg:y}=t.crudOption;if(u){g&&await x.confirm("确认进行删除操作？","提示",{type:"warning"});try{const m=await u(r[l]);return y&&B.success(y),await s.emitAsync("afterDel",m),c()}catch(m){console.error("handleDel ~ err",m)}}}),C=o.batchDel??(async()=>{const e=z(t.dataSelections),[r]=await A(s.emitAsync("beforeBatchDel",e));if(r!==null)return;const{rowKey:h,remove:l,delConfirm:u,delSuccessMsg:g}=t.crudOption;if(!l)return;const y=e.length;if(!y)return B.warning("请选择删除项");u&&await x.confirm(`确认删除所选的${y}条数据？`,"提示",{type:"warning"});const m=e.map(p=>p[h]).join(",");try{const p=await l(m);return g&&B.success(g),await s.emitAsync("afterBatchDel",p),c()}catch(p){console.error("batchDel ~ err",p)}}),O=(e,r)=>r.includes("$"),L=e=>e==="",b=o.filterRow??(e=>V(e,$(I,O))),K=o.filterParams??(e=>V(e,$(I,L,O))),P=o.searchChange??(async(e,r)=>{t.pageOption.currentPage=1,Object.keys(t.searchForm).forEach(u=>{delete t.searchForm[u]}),Object.keys(e).forEach(u=>{t.searchForm[u]=e[u]});const[h]=await A(s.emitAsync("beforeSearch",t.searchForm));if(h!==null)return r==null?void 0:r();await c();const[l]=await A(s.emitAsync("afterSearch",t.searchForm));if(l!==null)return r==null?void 0:r();r==null||r()}),d=o.searchReset??(async()=>{Object.keys(t.searchForm).forEach(e=>{delete t.searchForm[e]}),await s.emitAsync("beforeSearchReset",t.searchForm),await c(),await s.emitAsync("afterSearchReset",t.searchForm)}),F=o.selectionChange??(e=>{t.dataSelections=e}),v=o.pageSizeChange??(e=>(t.pageOption.pageSize=e,c())),D=o.pageCurrentChange??(e=>(t.pageOption.currentPage=e,c())),U=o.sortChange??(({order:e,prop:r})=>(e&&r?t.sortOption={[e.replace("ending","s")]:X(r)}:t.sortOption={},c())),M=o.beforeOpen??(async(e,r)=>{t.formType=r,await s.emitAsync("beforeOpen",r),e(),await s.emitAsync("afterOpen",r)}),j=o.beforeClose??(async(e,r)=>{t.formType=r,await s.emitAsync("beforeClose",r),e(),await s.emitAsync("afterClose",r)});return{getDataList:c,handleSave:n,handleUpdate:i,handleDel:f,batchDel:C,searchChange:P,searchReset:d,selectionChange:F,pageSizeChange:v,pageCurrentChange:D,sortChange:U,beforeOpen:M,beforeClose:j}}function he(){const a=se();return{emitter:a,beforeGetList:e=>{a.on("beforeGetList",async(...r)=>await(e==null?void 0:e(...r)))},afterGetList:e=>{a.on("afterGetList",async(...r)=>await(e==null?void 0:e(...r)))},beforeSave:e=>{a.on("beforeSave",async(...r)=>await(e==null?void 0:e(...r)))},afterSave:e=>{a.on("afterSave",async(...r)=>await(e==null?void 0:e(...r)))},beforeUpdate:e=>{a.on("beforeUpdate",async(...r)=>await(e==null?void 0:e(...r)))},afterUpdate:e=>{a.on("afterUpdate",async(...r)=>await(e==null?void 0:e(...r)))},beforeSubmit:e=>{a.on("beforeSubmit",async(...r)=>await(e==null?void 0:e(...r)))},afterSubmit:e=>{a.on("afterSubmit",async(...r)=>await(e==null?void 0:e(...r)))},beforeDel:e=>{a.on("beforeDel",async(...r)=>await(e==null?void 0:e(...r)))},afterDel:e=>{a.on("afterDel",async(...r)=>await(e==null?void 0:e(...r)))},beforeBatchDel:e=>{a.on("beforeBatchDel",async(...r)=>await(e==null?void 0:e(...r)))},afterBatchDel:e=>{a.on("afterBatchDel",async(...r)=>await(e==null?void 0:e(...r)))},beforeSearch:e=>{a.on("beforeSearch",async()=>await(e==null?void 0:e()))},afterSearch:e=>{a.on("afterSearch",async()=>await(e==null?void 0:e()))},beforeSearchReset:e=>{a.on("beforeSearch",async()=>await(e==null?void 0:e()))},afterSearchReset:e=>{a.on("afterSearch",async()=>await(e==null?void 0:e()))},beforeOpen:e=>{a.on("beforeOpen",async(...r)=>await(e==null?void 0:e(...r)))},afterOpen:e=>{a.on("afterOpen",async(...r)=>await(e==null?void 0:e(...r)))},beforeClose:e=>{a.on("beforeClose",async(...r)=>await(e==null?void 0:e(...r)))},afterClose:e=>{a.on("afterClose",async(...r)=>await(e==null?void 0:e(...r)))}}}function Se(a){const t=_(),s=fe(a),o=ee(s),{emitter:c,beforeGetList:n,afterGetList:i,beforeSave:f,afterSave:C,beforeUpdate:O,afterUpdate:L,beforeSubmit:b,afterSubmit:K,beforeDel:P,afterDel:d,beforeBatchDel:F,afterBatchDel:v,beforeSearch:D,afterSearch:U,beforeSearchReset:M,afterSearchReset:j,beforeOpen:e,afterOpen:r,beforeClose:h,afterClose:l}=he(),{getDataList:u,handleSave:g,handleUpdate:y,handleDel:m,batchDel:p,searchChange:w,searchReset:H,selectionChange:G,pageSizeChange:T,pageCurrentChange:E,sortChange:R,beforeOpen:N,beforeClose:k}=le({crudRef:t,crudState:s,emitter:c,options:a}),J=ae(()=>({ref:S=>t.value=S,modelValue:s.formData,tableLoading:s.tableLoading,option:a.tableOption??{},data:s.tableData,page:s.pageOption,search:s.searchForm,defaults:s.defaults,"before-open":N,"before-close":k,onRowSave:g,onRowUpdate:y,onRowDel:m,onRefreshChange:u,onSelectionChange:G,onCurrentChange:E,onSizeChange:T,onSortChange:R,onSearchChange:w,onSearchReset:H,"onUpdate:search":S=>s.searchForm=S,"onUpdate:page":S=>s.pageOption=S,"onUpdate:modelValue":S=>s.formData=S,"onUpdate:defaults":S=>s.defaults=S}));return{crudRef:t,crudState:s,crudStateRefs:o,bindVal:J,getDataList:u,handleSave:g,handleUpdate:y,handleDel:m,batchDel:p,beforeGetList:n,afterGetList:i,beforeSave:f,afterSave:C,beforeUpdate:O,afterUpdate:L,beforeSubmit:b,afterSubmit:K,beforeDel:P,afterDel:d,beforeBatchDel:F,afterBatchDel:v,beforeSearch:D,afterSearch:U,beforeSearchReset:M,afterSearchReset:j,beforeOpen:e,afterOpen:r,beforeClose:h,afterClose:l}}export{oe as a,Ce as b,ve as e,ne as s,Se as u};
